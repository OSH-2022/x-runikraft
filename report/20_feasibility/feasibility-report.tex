% SPDX-License-Identifier: CC-BY-4.0
% feasibility-report.tex: å¯è¡Œæ€§æŠ¥å‘Š

% Authors: å´éªä¸œ <1904346407@qq.com>,
%          å¼ å­è¾° <zichen350@gmail.com>,
%          è“ä¿Šç® <ljw13@mail.ustc.edu.cn>,
%          éƒ­è€¸éœ„ <logname@mail.ustc.edu.cn> and
%          é™ˆå»ºç»¿ <2512674094@qq.com>

% Copyright (C) 2022 å´éªä¸œ, å¼ å­è¾°, è“ä¿Šç®, éƒ­è€¸éœ„ and é™ˆå»ºç»¿
% All rights reserved.

% ğŸ…­ ğŸ…¯
% This document is licensed under a Creative Commons Attribution
% 4.0 International license <https://creativecommons.org/licenses/by/4.0/>.
\documentclass{../runikraft-report}

\hypersetup
{
  pdftitle={2022æ˜¥ æ“ä½œç³»ç»ŸåŸç†ä¸è®¾è®¡(H) x-runikraftå°ç»„ å¯è¡Œæ€§æŠ¥å‘Š},
  pdfauthor={å´éªä¸œ; å¼ å­è¾°; è“ä¿Šç®; éƒ­è€¸éœ„; é™ˆå»ºç»¿}
}
\renewcommand{\today}{2022å¹´4æœˆ21æ—¥}

\begin{document}
\title{\bfseries Runikraftå°ç»„\quad å¯è¡Œæ€§æŠ¥å‘Š}
\author{å´éªä¸œ\and å¼ å­è¾°\and è“ä¿Šç®\and éƒ­è€¸éœ„\and é™ˆå»ºç»¿}
\date{\today}
\maketitle

\tableofcontents
\section{é¡¹ç›®ä»‹ç»}
æˆ‘ä»¬é€‰æ‹©çš„è¯¾é¢˜æ˜¯ä½¿ç”¨Rustè¯­è¨€æ”¹å†™Unikraft Unikernelã€‚ä¸RustyHermitå’ŒrCoreç­‰ç”¨Rustå®ç°çš„æ“ä½œç³»ç»Ÿä¸åŒï¼Œ
æˆ‘ä»¬å°†å®Œå…¨ä½¿ç”¨Rustçš„ç¨³å®šç‰¹æ€§ç¼–å†™ä»£ç ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨äº’è”ç½‘æŠ€æœ¯å’Œäº‘è®¡ç®—ä¸æ–­å‘å±•çš„ä»Šå¤©ï¼Œæˆ‘ä»¬èº«è¾¹çš„è™šæ‹ŸåŒ–è®¾å¤‡ä¸æ–­å¢å¤šï¼Œ
å®ƒä»¬ä¸­çš„å¾ˆå¤šéƒ½ä½¿ç”¨äº†Unikernelã€‚ç„¶è€Œï¼Œè™šæ‹ŸåŒ–è®¾å¤‡å’ŒUnikernelä¹Ÿæš´éœ²å‡ºäº†å¾ˆå¤šå®‰å…¨é—®é¢˜ã€‚
å¯¹è¿™äº›å®‰å…¨é—®é¢˜ï¼ŒCè¯­è¨€å› å…¶æœ¬èº«çš„ç¼ºé™·éš¾è¾å…¶å’ã€‚

Rust æ˜¯ä¸€é—¨è®©äººäººéƒ½èƒ½å†™å‡ºå¯é ã€é«˜æ•ˆçš„è½¯ä»¶çš„è¯­è¨€ã€‚\cite{7}åˆ©ç”¨Rustç¼–å†™Unikernelï¼Œ
å¯ä»¥å……åˆ†å‘æŒ¥å®ƒç›¸å¯¹Cè¯­è¨€çš„é«˜å±‚æŠ½è±¡å’Œå†…å­˜å®‰å…¨ä¿è¯ã€‚ç”¨Rustæ”¹å†™é¡¹ç›®å·²ç»æˆä¸ºä¸€ç§è§£å†³é—®é¢˜çš„
æœ‰æ•ˆæ‰‹æ®µï¼Œå¦‚zalandoå…¬å¸ä»Scalaè½¬å‘Rustçš„æˆåŠŸæ•…äº‹ã€‚\cite{3}

RISC-Væ˜¯ä¸€æ¬¾è‡ªç”±ã€å¼€æºçš„ISAï¼Œå®ƒå¼€å¯äº†å…¨æ–°çš„åŸºäºå¼€æ”¾æ ‡å‡†åä½œçš„å¤„ç†å™¨åˆ›æ–°æ—¶ä»£ã€‚\cite{0}
ç›®å‰åŸºäºRISC-Væ¶æ„çš„å¼€æºå¤„ç†å™¨æœ‰å¾ˆå¤šï¼Œæ—¢æœ‰æ ‡é‡å¤„ç†å™¨Rocketï¼Œ
ä¹Ÿæœ‰è¶…æ ‡é‡å¤„ç†å™¨BOOMï¼Œè¿˜æœ‰é¢å‘åµŒå…¥å¼é¢†åŸŸçš„Z-scaleã€PicoRV32ç­‰ã€‚\cite{2}

å› æ­¤ï¼Œæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨Rustè¯­è¨€æ”¹å†™æ¶æ„å’Œæ€§èƒ½æ–¹é¢å ä¼˜çš„unikernelâ€”â€”Unikraftã€‚
åœ¨è¿™ä»½æŠ¥å‘Šä¸­ï¼Œæˆ‘ä»¬å°†é¦–å…ˆä»‹ç»é¡¹ç›®çš„ç†è®ºä¾æ®â€”â€”Rustè¯­è¨€é€‚ç”¨äºç³»ç»Ÿç¼–ç¨‹çš„ç‰¹æ€§
åŠå¯¹Unikraftæºç çš„åˆ†æå’Œæ”¹å†™æ€è·¯ï¼›éšåï¼Œæˆ‘ä»¬å°†ä»‹ç»ä½¿ç”¨QEMUè¿›è¡Œç¡¬ä»¶ä»¿çœŸå’Œ
æµ‹è¯•çš„æ–¹æ³•ï¼›æœ€åï¼Œæˆ‘ä»¬å°†ç»™å‡ºé¡¹ç›®çš„æ€»ä½“è®¾è®¡å’Œåˆ›æ–°ç‚¹ã€‚
\section{ç†è®ºä¾æ®}
\subsection{Rustè¯­è¨€}
\subsubsection{ä¿è¯å†…å­˜å®‰å…¨çš„æ–¹å¼}
åœ¨é«˜çº§è¯­è¨€ä¸­ï¼ŒæŸä¸ªå†…å­˜ä½ç½®è¦åœ¨ç¨‹åºä¸­èƒ½è¢«è®¿é—®ï¼Œå¿…ç„¶å°±ä¼šä¸ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡å»ºç«‹å…³è”å…³ç³»ã€‚
è¿™ä¼šå¼•å‡ºå†…å­˜çš„ä¸æ­£ç¡®è®¿é—®å¼•å‘çš„å†…å­˜å®‰å…¨é—®é¢˜ã€‚è¿™äº›é—®é¢˜åœ¨C/C++ä¸­éƒ½æ˜¯éœ€è¦å¼€å‘è€…éå¸¸å°å¿ƒåœ°
è‡ªå·±å¤„ç†ã€‚è€Œ Rust çš„è¯­è¨€ç‰¹æ€§åˆ™ä¸ºä¸Šé¢çš„é—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚\cite{8}
\begin{table}[H]
\centering
\caption{Rustå¯¹å†…å­˜å®‰å…¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ}
\begin{tabular}{|c|c|}
\hline
\textbf{é—®é¢˜} & \textbf{Rust çš„è§£å†³æ–¹æ¡ˆ}\\\hline
ä½¿ç”¨æœªåˆå§‹åŒ–å†…å­˜&ç¼–è¯‘å™¨ç¦æ­¢å˜é‡è¯»å–æœªèµ‹å€¼å˜é‡\\\hline
å¯¹ç©ºæŒ‡é’ˆè§£å¼•ç”¨&ä½¿ç”¨\texttt{Option}æšä¸¾æ›¿ä»£ç©ºæŒ‡é’ˆ\\\hline
æ‚¬å‚æŒ‡é’ˆ&ç”Ÿå‘½å‘¨æœŸæ ‡è¯†ä¸ç¼–è¯‘å™¨æ£€æŸ¥\\\hline
ç¼“å†²åŒºæº¢å‡º&ç¼–è¯‘å™¨æ£€æŸ¥ï¼Œæ‹’ç»è¶…è¶Šç¼“å†²åŒºè¾¹ç•Œçš„æ•°æ®è®¿é—®\\\hline
éæ³•é‡Šæ”¾å†…å­˜&è¯­è¨€çº§çš„ RAII æœºåˆ¶ï¼Œå”¯ä¸€çš„æ‰€æœ‰è€…æ‰æœ‰æƒé‡Šæ”¾å†…å­˜\\\hline
\end{tabular}
\end{table}
\subsubsection{ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ–¹å¼}
Rust é€šè¿‡ä¸€æ•´å¥—è®¾è®¡éå¸¸ç²¾è‰¯çš„åŸºç¡€è®¾æ–½æ¥ä¿è¯è¿™ä¸€ç‚¹ï¼Œè¿™äº›åŸºç¡€è®¾æ–½é…åˆç±»å‹æ£€æŸ¥å’Œ
å€Ÿç”¨æ¨¡å‹â€œå¼ºè¿«â€ç¨‹åºå‘˜å†™å‡ºæ­£ç¡®çš„ä»£ç ï¼ŒæŠŠåˆ«çš„è¯­è¨€åœ¨è¿è¡Œæ—¶çš„å´©æºƒæˆ–æ³„éœ²æš´éœ²åœ¨ç¼–è¯‘æœŸï¼Œ
ä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

\noindent åŸºç¡€è®¾æ–½ï¼š

\begin{enumerate}
\item è¿›è¡Œè¯­ä¹‰é™åˆ¶çš„\texttt{Send} / \texttt{Sync} ã€\texttt{Trait}ã€‚
\item å…±äº«ä¸å¯å˜æ‰€æœ‰æƒçš„\texttt{Arc} (\texttt{Rc}çš„å¤šçº¿ç¨‹ç‰ˆæœ¬)ã€‚
\item æä¾›å†…éƒ¨å¯å˜æ€§çš„\texttt{Mutex} / \texttt{Rwlock}ã€‚
\item ç®¡é“æ¨¡å‹\texttt{channel}ã€‚
\item å…¶ä»–çš„ä¸€äº›çº¿ç¨‹ç›¸å…³çš„APIã€‚
\end{enumerate}

\noindent çº¿ç¨‹ç›¸å…³çš„å¸¸è§APIä¸è®¾æ–½ï¼š

\begin{enumerate}
\item \texttt{std::thread::spawn}ï¼Œ\texttt{spawn}æ¥æ”¶ä¸€ä¸ªé—­åŒ…å¹¶æ‰§è¡Œ,è¿”å›ä¸€ä¸ª
\texttt{JoinHandle}ç±»å‹çš„å€¼ï¼Œå®ƒæ‹¥æœ‰çº¿ç¨‹æ‰€æœ‰æƒï¼›
\item  \texttt{join()}å‡½æ•°ï¼Œè¯¥å‡½æ•°ä½œç”¨åœ¨çº¿ç¨‹å¥æŸ„\texttt{JoinHandle}ç±»å‹çš„å€¼ä¸Šï¼Œ
ä½¿å¾—çˆ¶çº¿ç¨‹èƒ½å¤Ÿç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼›
\item \texttt{move}+é—­åŒ…ï¼Œ\texttt{move}é—­åŒ…å¸¸å¸¸ä¸\texttt{thread}å’Œ\texttt{spawn}
ä¸€èµ·ä½¿ç”¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®ï¼Œä½¿ç”¨\texttt{move}å…³é”®å­—å¼ºåˆ¶é—­åŒ…è·å–
å…¶ä½¿ç”¨çš„ç¯å¢ƒå€¼çš„æ‰€æœ‰æƒã€‚
\end{enumerate}

Rust æ‰€æ‹¥æœ‰çš„è¿™äº›è®¾æ–½ä»¥åŠè‡ªèº«çš„ç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬ç¼–å†™å‡ºæ­£ç¡®çš„ä»£ç ä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚\cite{9}

\subsubsection{Unsafe Rust}
åœ¨è¿›è¡Œåº•å±‚ç³»ç»Ÿç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä½¿ç”¨Rust çš„unsafeå…³é”®å­—ï¼Œä½¿ç”¨è¯¥å…³é”®å­—å¯ä»¥ä½¿æˆ‘ä»¬å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

è§£å¼•ç”¨åŸç”ŸæŒ‡é’ˆï¼Œè¿™å¯¹äºå’ŒCè¯­è¨€å’Œæ±‡ç¼–è¯­è¨€ç¨‹åºäº¤äº’å¾ˆæœ‰ç”¨ã€‚
è°ƒç”¨ä¸€ä¸ªä¸å®‰å…¨çš„å‡½æ•°æˆ–æ–¹æ³•ï¼ˆä¾‹å¦‚Cè¯­è¨€å‡½æ•°ï¼‰ã€‚
è®¿é—®å’Œä¿®æ”¹é™æ€å˜é‡ï¼Œåè€…æ˜¯Rustä¸­çš„"å…¨å±€å˜é‡"ã€‚
ä½¿ç”¨Unsafe Rustä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘Rustç¼–è¯‘å™¨çš„å®‰å…¨æ£€æŸ¥ï¼Œä½†ç‰ºç‰²çš„ç¨è®¸å®‰å…¨æ€§å´å¯ä»¥æ¢æ¥
çµæ´»æ€§çš„å·¨å¤§æé«˜ã€‚åœ¨ä¸ç¡¬ä»¶æŠ½è±¡ï¼ˆå®šä¹‰äº\texttt{portmacros.h}ä¸­ï¼‰è¿›è¡Œäº¤äº’æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½
éœ€è¦ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚

\subsection{Rustä¸Cäº¤äº’}
Rust ä¸­æä¾›äº†\texttt{extern}å…³é”®å­—æ¥ç®€åŒ–åˆ›å»ºå’Œä½¿ç”¨å¤–éƒ¨æ¥å£ï¼ˆForeign Function
Interface, FFIï¼‰çš„è¿‡ç¨‹ã€‚FFI æ˜¯ç¼–ç¨‹è¯­è¨€å®šä¹‰å‡½æ•°çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒå…è®¸å…¶ä»–ï¼ˆå¤–éƒ¨çš„ï¼‰ç¼–ç¨‹è¯­è¨€
æ¥è°ƒç”¨è¿™äº›å‡½æ•°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªé›†æˆäº†Cæ ‡å‡†åº“ä¸­çš„\texttt{abs}å‡½æ•°çš„ç¤ºä¾‹ä»£ç ï¼š
\begin{lstlisting}[numbers=left]
	extern "C" {
		fn abs(input: i32) -> i32;
	}
	fn main(){
		unsafe {
			println!("Absolue value of -3 according to C: {}", abs(-3));
		}
	}
\end{lstlisting}
è¿™æ®µä»£ç åœ¨\texttt{extern "C"}å—ä¸­åˆ—å‡ºäº†å®ƒæƒ³è¦è°ƒç”¨çš„å¤–éƒ¨å‡½æ•°å’Œç­¾åï¼Œå…¶ä¸­çš„\texttt{"C"}æŒ‡æ˜
äº†å¤–éƒ¨å‡½æ•°ä½¿ç”¨çš„åº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆApplication Binary Interface, ABIï¼‰ï¼šå®ƒè¢«ç”¨æ¥å®šä¹‰å‡½æ•°åœ¨
æ±‡ç¼–å±‚é¢çš„è°ƒç”¨æ–¹å¼ã€‚

è¦åœ¨å…¶ä»–è¯­è¨€ä¸­è°ƒç”¨ Rust å‡½æ•°ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨\texttt{extern}æ¥åˆ›å»ºä¸€ä¸ªå…è®¸å…¶ä»–è¯­è¨€è°ƒç”¨ Rust
å‡½æ•°çš„æ¥å£ã€‚åˆ›å»ºæ—¶éœ€è¦å°†\texttt{extern}å…³é”®å­—åŠå¯¹åº”çš„ ABI æ·»åŠ åˆ°å‡½æ•°ç­¾åçš„\texttt{fn}å…³é”®å­—
å‰ï¼Œå¹¶ä¸ºè¯¥å‡½æ•°æ·»åŠ \texttt{\#[no\_mangle]}æ³¨è§£æ¥é¿å… Rust åœ¨ç¼–è¯‘æ—¶æ”¹å˜å®ƒçš„åç§°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ç¼–è¯‘å¹¶é“¾æ¥åè¢« C è¯­è¨€ä»£ç è®¿é—®çš„å‡½æ•°å®šä¹‰ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
	#[no_mangle]
	pub extern "C" fn call_from_c() {
		println!("Just called a Rust function from C!");
	}
\end{lstlisting}
è¿™ä¸€ç±»å‹çš„\texttt{extern}åŠŸèƒ½ä¸éœ€è¦ä½¿ç”¨\texttt{unsafe}ã€‚

\subsection{Rustçš„æ¡ä»¶ç¼–è¯‘}\label{subsec:cond-compile}
Rusté€šè¿‡cfgå±æ€§ï¼Œå¯¹æ¡ä»¶ç¼–è¯‘æä¾›äº†æ”¯æŒã€‚è¿™äº›é…ç½®åœ¨Cargo.tomlä¸­æä¾›ï¼Œä¾‹å¦‚ï¼š

\begin{lstlisting}[numbers=left,language=Rust]
[features]
# no features by default
default = []

# The â€œsecure-passwordâ€ feature depends on the bcrypt package.
secure-password = ["bcrypt"]

# A feature with no dependencies is used mainly for conditional compilation, like `#[cfg(feature = "go-faster")]`.
go-faster = []
\end{lstlisting}

åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥é‡‡ç”¨cfgå±æ€§ä¿®é¥°å‡½æ•°ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
// This function is only included when compiling for a unixish OS with a 32-bit architecture
#[cfg(all(unix, target_pointer_width = "32"))]
fn on_32bit_unix() {
	// ...
}
\end{lstlisting}
ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç±»ä¼¼\texttt{\#\textbf{ifdef}}çš„æ–¹å¼è¿›è¡Œæ¡ä»¶ç¼–è¯‘ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
let machine_kind = if cfg!(unix) {
	"unix"
} else if cfg!(windows) {
	"windows"
} else {
	"unknown"
};

println!("I'm running on a {} machine!", machine_kind);
\end{lstlisting}
\cite{e}

\subsection{RISC-V ISA}
\subsubsection{ç‰¹æƒç‰¹æƒæ¨¡å‹}
åœ¨ç¼–å†™unikernelæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç‰¹æƒæŒ‡ä»¤å¤„ç†å¤–è®¾ä¸­æ–­ã€æ§åˆ¶æœºå™¨çŠ¶æ€ï¼Œ
å› æ­¤éœ€è¦äº†è§£RISC-Vçš„ç‰¹æƒæ¨¡å‹ã€‚

æˆªè‡³ç›®å‰(2022.4)ï¼ŒRISC-V å…±å®šä¹‰äº†å››ä¸ªç‰¹æƒçº§åˆ«ï¼Œç”±é«˜åˆ°ä½æ’åˆ—é¡ºæ¬¡ä¸ºï¼š

\begin{description}
\item[æœºå™¨çº§åˆ«ï¼ˆMï¼‰] RISC-Vä¸­ç¡¬ä»¶çº¿ç¨‹å¯ä»¥æ‰§è¡Œçš„æœ€é«˜æƒé™æ¨¡å¼ã€‚
åœ¨Mæ¨¡å¼ä¸‹è¿è¡Œçš„ hart å¯¹å†…å­˜ã€I/O å’Œä¸€äº›å¯¹äºå¯åŠ¨å’Œé…ç½®ç³»ç»Ÿæ¥è¯´å¿…è¦çš„åº•å±‚
åŠŸèƒ½æœ‰ç€å®Œå…¨çš„ä½¿ç”¨æƒã€‚å› æ­¤å®ƒæ˜¯å”¯ä¸€æ‰€æœ‰æ ‡å‡† RISC-V å¤„ç†å™¨éƒ½å¿…é¡»å®ç°çš„æƒé™æ¨¡å¼ã€‚\cite{a}
\item[è¶…çº§ç›‘ç®¡è€…çº§åˆ«ï¼ˆHï¼‰] ä¸ºäº†æ”¯æŒè™šæ‹Ÿæœºç›‘è§†å™¨ã€‚ä½†ç›®å‰è¯¥çº§åˆ«å¹¶æ²¡æœ‰è¢«æ­£å¼åŠ å…¥åˆ°æ–‡æ¡£ä¸­ã€‚
\item[ç›‘ç®¡è€…çº§åˆ«ï¼ˆSï¼‰] ä¸ºäº†æ”¯æŒç°ä»£ç±» Unix æ“ä½œç³»ç»Ÿï¼Œå¦‚ Linuxï¼ŒFreeBSD å’Œ Windows ã€‚
\item[ç”¨æˆ·çº§åˆ«ï¼ˆUï¼‰] ç”¨äºè¿è¡Œåº”ç”¨ç¨‹åºï¼Œé€‚ç”¨äºå®‰å…¨åµŒå…¥å¼ç³»ç»Ÿã€‚
\end{description}

æ ‡å‡†çš„ RISC-V ä¸ºè¶…è¿‡4000ä¸ª CSR é¢„ç•™äº†12ä½çš„ç¼–ç ç©ºé—´(\texttt{[11ï¼š0]})ã€‚
å…¶ä¸­ï¼Œ\texttt{[11ï¼š8]} ä½æ ¹æ®ç‰¹æƒçº§åˆ«å¯¹ CSR çš„è¯»å†™æƒé™è¿›è¡Œç¼–ç ã€‚
æ³¨æ„ï¼šä»»ä½•è¯•å›¾è®¿é—®ä¸å­˜åœ¨çš„ CSR çš„è¡Œä¸ºå‡ä¼šå¼•å‘æŒ‡ä»¤å¼‚å¸¸ï¼Œå°è¯•å†™å…¥åªè¯»å¯„å­˜å™¨ä¹Ÿä¼šå¼•å‘æŒ‡ä»¤å¼‚å¸¸ã€‚
å‰©ä½™çš„8ä½ç¼–ç  \texttt{[7:0]} å°†æŒ‡å®šç›¸åº”çš„å¯„å­˜å™¨åœ°å€ä½ç½®ã€‚å…·ä½“ç»†èŠ‚å¦‚ä¸‹æ‰€ç¤ºï¼š\cite{b}\cite{c}

\begin{lstlisting}[numbers=left]
CSR [11:10]ï¼šå¯¹è¯»å†™æ¨¡å¼è¿›è¡Œçº¦æŸ
00		read/write
01		read/write
10		read/write
11		read-only
CSR [9:8]ï¼šå¯¹è®¿é—®æœ€ä½æƒé™è¿›è¡Œçº¦æŸ
00		Unprivileged and User-Level CSRs
01		Supervisor-Level CSRs
10		Hypervisor and VS CSRs
11		Machine-Level CSRs
\end{lstlisting}


ç›®å‰ RISC-V æ”¯æŒçš„ç‰¹æƒæŒ‡ä»¤æ ¼å¼ä¸ºï¼š
%\begin{table}[H]
    %\caption{RISC-V ç‰¹æƒæŒ‡ä»¤}
{
    \small
    \newcommand{\instbit}[1]{\mbox{\scriptsize #1}}
    \newcommand{\instbitrange}[2]{~\instbit{#1} \hfill \instbit{#2}~}
    %\centering
    
    \begin{longtable}{p{0in}p{0.4in}p{0.05in}p{0.05in}p{0.05in}p{0.05in}p{0.4in}p{0.6in}p{0.4in}p{0.6in}p{0.7in}l}
    \caption{RISC-V ç‰¹æƒæŒ‡ä»¤}\\
    &
    \multicolumn{1}{l}{\instbit{31}} &
    \multicolumn{1}{r}{\instbit{27}} &
    \instbit{26} &
    \instbit{25} &
    \multicolumn{1}{l}{\instbit{24}} &
    \multicolumn{1}{r}{\instbit{20}} &
    \instbitrange{19}{15} &
    \instbitrange{14}{12} &
    \instbitrange{11}{7} &
    \instbitrange{6}{0} \\
    \cline{2-11}
    \endfirsthead
    &
    \multicolumn{1}{l}{\instbit{31}} &
    \multicolumn{1}{r}{\instbit{27}} &
    \instbit{26} &
    \instbit{25} &
    \multicolumn{1}{l}{\instbit{24}} &
    \multicolumn{1}{r}{\instbit{20}} &
    \instbitrange{19}{15} &
    \instbitrange{14}{12} &
    \instbitrange{11}{7} &
    \instbitrange{6}{0} \\
    \cline{2-11}
    \endhead
    
    &
    \multicolumn{4}{|c|}{funct7} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{funct3} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{opcode} & R-type \\
    \cline{2-11}
    
    
    &
    \multicolumn{6}{|c|}{imm[11:0]} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{funct3} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{opcode} & I-type \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Trap-Return Instructions} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001000} &
    \multicolumn{2}{c|}{00010} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SRET \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0011000} &
    \multicolumn{2}{c|}{00010} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & MRET \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Interrupt-Management Instructions} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001000} &
    \multicolumn{2}{c|}{00101} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & WFI \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Supervisor Memory-Management Instructions} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.VMA \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Memory-Management Instructions} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0010001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HFENCE.VVMA \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HFENCE.GVMA \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Virtual-Machine Load and Store Instructions} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110000} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.B \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110000} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.BU \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.H \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.HU \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.W \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00011} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLVX.HU \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00011} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLVX.WU \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.B \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.H \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110101} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.W \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Virtual-Machine Load and Store Instructions, RV64 only} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.WU \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110110} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.D \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110111} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.D \\
    \cline{2-11}
    
    
    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf \emph{Svinval} Memory-Management Extension} & \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SINVAL.VMA \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001100} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.W.INVAL \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0001100} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.INVAL.IR \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0010011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HINVAL.VVMA \\
    \cline{2-11}
    
    
    &
    \multicolumn{4}{|c|}{0110011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HINVAL.GVMA \\
    \cline{2-11}
    
    
    \end{longtable}
}

ä»¥ CSR è®¿å­˜æŒ‡ä»¤ä¸ºä¾‹ã€‚å…¶æ ‡å‡†æ ¼å¼ä¸ºï¼š
\begin{table}[H]
    \centering
    \caption{çŠ¶æ€æ§åˆ¶å¯„å­˜å™¨ï¼ˆCSRï¼‰}
    \begin{tabular}{|r|c|>{\ttfamily}l>{\ttfamily}l|}
        \hline
        è¯»/å†™&I&CSRRW&rd,csr,rs1\\
        è¯»\&è®¾ç½®ä½&I&CSRRS&rd,csr,rs1\\
        è¯»\&æ¸…é™¤ä½&I&CSRRC&rd,csr,rs1\\
        è¯»/å†™\ ç«‹å³æ•°&I&CSRRWI&rd,csr,imm\\
        è¯»\&è®¾ç½®ä½\ ç«‹å³æ•°&I&CSRRSI&rd,csr,imm\\
        è¯»\&æ¸…é™¤ä½\ ç«‹å³æ•°&I&CSRRCI&rd,csr,imm\\\hline
    \end{tabular}
\end{table}

é™¤ç›®å‰ RISC-V æ”¯æŒçš„ç‰¹æƒæŒ‡ä»¤æ ¼å¼å¤–ï¼Œ\texttt{ecall}æŒ‡ä»¤ç”¨äºç³»ç»Ÿè°ƒç”¨ã€‚

\subsubsection{ç›‘ç®¡è€…äºŒè¿›åˆ¶æ¥å£}
ä¸ºäº†é™ä½Sæ¨¡å¼çš„ç¨‹åºåœ¨ä¸åŒRISC-Vçš„è®¾å¤‡ä¹‹é—´çš„ç§»æ¤éš¾åº¦ï¼Œ
RISC-Vå¼•å…¥äº†ç›‘ç®¡è€…äºŒè¿›åˆ¶æ¥å£ï¼ˆ\textbf{S}upervisor \textbf{B}inary \textbf{I}nterfaceï¼‰ã€‚
å®ƒåœ¨Mæ¨¡å¼è¿è¡Œï¼Œä¸ºè¿è¡Œåœ¨Sæ¨¡å¼ä¸‹çš„æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›ç¡¬ä»¶æŠ½è±¡ã€‚

ä¸Uæ¨¡å¼çš„ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨é™·å…¥Sæ¨¡å¼ç±»ä¼¼ï¼ŒSæ¨¡å¼çš„ç³»ç»Ÿå†…æ ¸ä¹Ÿå¯ä»¥ç”¨SBIè°ƒç”¨é™·å…¥Mæ¨¡å¼ï¼Œ
ä»¥ä½¿ç”¨SBIæä¾›çš„æœåŠ¡ã€‚

\begin{figure}[tbh!]
\centering
\includegraphics[width=0.7\linewidth]{assets/riscv-sbi-intro1.png}
\caption{ä¸å«Hæ‹“å±•çš„RISC-Vç³»ç»Ÿ}
\label{fig:riscv-sbi}
\end{figure}

å¦‚ä¸‹ä¸º\texttt{arch/riscv/kernel/sbi.c}ä¸­çš„éƒ¨åˆ†ä»£ç ï¼Œä½¿ç”¨\texttt{ecall}æŒ‡ä»¤æ—¶ï¼Œ
å°†EIDå†™åœ¨\texttt{a7} å¯„å­˜å™¨ï¼ŒFIDå†™åœ¨\texttt{a6}å¯„å­˜å™¨ï¼Œå‚æ•°å†™åœ¨ \texttt{a0}-\texttt{a5} å¯„å­˜å™¨ï¼Œ
åé¢ä¼šæ ¹æ®EIDå’ŒFIDçš„ä¸åŒè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ã€‚
\begin{lstlisting}[language=C,numbers=left]
struct sbiret sbi_ecall(int ext, int fid, unsigned long arg0,
unsigned long arg1, unsigned long arg2,
unsigned long arg3, unsigned long arg4,
unsigned long arg5)
{
	struct sbiret ret;

	register uintptr_t a0 asm ("a0") = (uintptr_t)(arg0);
	register uintptr_t a1 asm ("a1") = (uintptr_t)(arg1);
	register uintptr_t a2 asm ("a2") = (uintptr_t)(arg2);
	register uintptr_t a3 asm ("a3") = (uintptr_t)(arg3);
	register uintptr_t a4 asm ("a4") = (uintptr_t)(arg4);
	register uintptr_t a5 asm ("a5") = (uintptr_t)(arg5);
	register uintptr_t a6 asm ("a6") = (uintptr_t)(fid);
	register uintptr_t a7 asm ("a7") = (uintptr_t)(ext);
	asm volatile ("ecall"
	: "+r" (a0), "+r" (a1)
	: "r" (a2), "r" (a3), "r" (a4), "r" (a5), "r" (a6), "r" (a7)
	: "memory");
	ret.error = a0;
	ret.value = a1;

	return ret;
}
\end{lstlisting}â€‹

ä¾‹å¦‚å¯ä»¥ç”¨å¦‚ä¸‹ç¨‹åºå®ç°ä¸€ä¸ªæ‰“å°ä¸€ä¸ªå­—ç¬¦åˆ°ç³»ç»Ÿæ§åˆ¶å°ä¸Šçš„putcharå‡½æ•°ï¼š
\begin{lstlisting}[language=C]
    void sbi_console_putchar(int ch)
    {
    	sbi_ecall(SBI_EXT_0_1_CONSOLE_PUTCHAR, 0, ch, 0, 0, 0, 0, 0);
    }
\end{lstlisting}

ç”¨SBIå¯ä»¥é™ä½å¼€å‘ç³»ç»Ÿçš„éš¾åº¦ï¼Œä½†æ˜¯ä¼šå¼•å…¥\texttt{ecall}æŒ‡ä»¤ï¼Œè€Œunikernelçš„é«˜æ•ˆæ­£æ˜¯
ä¾é é¿å…\texttt{ecall}å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¼šåœ¨å‰æœŸä½¿ç”¨SBIæä¾›çš„æœåŠ¡ï¼ŒåæœŸä¼šç”¨è‡ªå·±ç¼–å†™
çš„virtioé©±åŠ¨ç¨‹åºä»£æ›¿SBIã€‚


\subsubsection{KVMå¯¹RISC-Væ¶æ„çš„æ”¯æŒ}
KVM (Kernel-based Virtual Machineï¼ŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº)  ï¼Œæ˜¯ä¸€ç§å†…å»ºäº Linux ä¸­çš„
å¼€æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å…·ä½“è€Œè¨€ï¼ŒKVM å¯ä»¥å°† Linux è½¬å˜ä¸ºè™šæ‹Ÿç›‘æ§ç¨‹åºï¼Œä»è€Œä½¿ä¸»æœºè®¡ç®—æœºèƒ½å¤Ÿè¿è¡Œ
å¤šä¸ªéš”ç¦»çš„è™šæ‹Ÿç¯å¢ƒï¼Œå³è™šæ‹Ÿå®¢æˆ·æœºæˆ–è™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚
\begin{figure}[!hbt]
	\centering
	\includegraphics[width=0.9\linewidth]{assets/riscv-sbi-intro2.png}
	\caption{è™šæ‹ŸåŒ–ä¸‹çš„ç‰¹æƒç­‰çº§}
	\label{fig:w4}
\end{figure}

å¦‚å›¾\ref{fig:w4}ï¼Œä¸ºäº†æ”¯æŒè™šæ‹ŸåŒ–ï¼ŒRISC-V è§„èŒƒå®šä¹‰äº† RISC-V H-extension ï¼Œåœ¨åŸæ¥çš„3çº§
ç‰¹æƒæ¶æ„çš„åŸºç¡€ä¸Šå¯¹åŸæœ‰çš„ Supervisor æ¨¡å¼è¿›è¡Œäº†æ‰©å±•ï¼Œå¼•å…¥äº† Hypervisor-Extended Supervisor mode(HS)ã€‚
æ­¤æ—¶ï¼Œåœ¨ Machine Mode ä¸‹è¿è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„ã€å¯¹å…¨éƒ¨èµ„æºå…·å¤‡æ“ä½œèƒ½åŠ›çš„ Firmware ï¼Œè™šæ‹Ÿæœºè½¯ä»¶
Hypervisor è¿è¡Œåœ¨ HS æ¨¡å¼ï¼Œè™šæ‹Ÿæœº VM è¿è¡Œåœ¨è™šæ‹ŸåŒ–çš„ Supervisor æ¨¡å¼ï¼Œåº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œåœ¨
è™šæ‹Ÿæ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œè¿è¡Œåœ¨ Virtualized User modeã€‚

ä¸ºäº†å®ç° Supervisor ä¸ Hypervisor-extended supervisor æ¨¡å¼çš„åˆ‡æ¢ï¼ŒRSIC-V å°†åŸæ¥
Supervisor æ¨¡å¼ä¸‹çš„ CSR å¤åˆ¶ä¸€ä»½åˆ°Hypervisorï¼Œä»è€Œè®©æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹æ‹¥æœ‰ä¸¤ä»½ supervisor
å¯„å­˜å™¨ï¼ŒåŠ å¿«ä¸¤ä¸ªæ¨¡å¼ä¹‹é—´çš„åˆ‡æ¢è¿‡ç¨‹ã€‚

ç”±äº RISC-V æ²¡æœ‰ä¸ºä¸åŒè™šæ‹ŸåŒ–è½¯ä»¶è®¾è®¡ä¸“é—¨çš„ç‰¹æƒæ¨¡å¼ï¼Œè€Œæ˜¯è®¾è®¡äº†ç»Ÿä¸€çš„ç‰¹æƒæ¨¡å¼ï¼Œè¿™è¯´æ˜å®ƒå¯¹
1ç±»ï¼ˆå¦‚Xvisorï¼‰ã€ 2ç±»ï¼ˆå¦‚KVMï¼‰è™šæ‹ŸåŒ–è½¯ä»¶éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚ RISC-V å¯ä»¥é€šè¿‡ CSR å¯„å­˜å™¨æ³¨å…¥
ä¸­æ–­ï¼Œå› æ­¤ä¸éœ€è¦ä¸ºè™šæ‹ŸåŒ–è€Œç‰¹æ®Šè®¾è®¡ä¸­æ–­æ§åˆ¶å™¨å¤–è®¾ã€‚æ­¤å¤–ï¼ŒRISC-V å¯ç›´æ¥å€ŸåŠ©ç‰¹æ®Šçš„å¯„å­˜å™¨ä½æ”¯æŒ
åµŒå¥—è™šæ‹ŸåŒ–ï¼Œè€Œ Aarch64 è¦ç­‰åˆ° v8.3 ç‰ˆæœ¬ä¹‹åæ‰æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚RISC-V çš„æ—¶é’Ÿå’Œæ ¸é—´ä¸­æ–­å¯é€šè¿‡
SBI è½¯ä»¶è¾…åŠ©å®Œæˆï¼Œè€Œ Aarch64 éœ€è¦ç‰¹æ®Šè®¾è®¡çš„è®¡æ—¶å™¨å¤–è®¾æ¥æ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½ã€‚\cite{d}

\subsubsection{ä½¿ç”¨QEMUè¿›è¡Œä»¿çœŸæµ‹è¯•}

QEMU is a generic and open source machine emulator and virtualizer.

When used as a machine emulator, QEMU can run OSes and programs made for
one machine (e.g. an ARM board) on a different machine (e.g. your own PC).
By using dynamic translation, it achieves very good performance.

When used as a virtualizer, QEMU achieves near native performance by executing
the guest code directly on the host CPU. QEMU supports virtualization when executing
under the Xen hypervisor or using the KVM kernel module in Linux. When using KVM,
QEMU can virtualize x86, server and embedded PowerPC, 64-bit POWER, S390, 32-bit
and 64-bit ARM, and MIPS guests.\cite{1}

\noindent QEMUå…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

\begin{description}
\item[Full-system emulation] Run operating systems for any machine, on any supported architecture.
\item[User-mode emulation] Run programs for another Linux/BSD target, on any supported architecture.
\item[Virtualization] Run KVM and Xen virtual machines with near native performance.\cite{1}
\end{description}

\subsection{Unikraftæ¶æ„åˆ†æ}
\subsubsection{ä»£ç é£æ ¼}\label{ssubsec:code-style}
Unikraftçš„ä»£ç ç»„ç»‡æ–¹å¼å……åˆ†ä½“ç°äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæ ¸å¿ƒä»£ç è¢«æ”¾åœ¨äº†\texttt{arch/}ã€\texttt{include/}å’Œ
\texttt{plat/}ä¸‰ä¸ªç›®å½•ä¸‹ï¼Œè€Œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰åŠŸèƒ½éƒ½ç”±ä¸ºäº†\texttt{lib/}ç›®å½•ä¸‹çš„micro-librariesæä¾›ã€‚
ä¸€ä¸ªmicro-libraryè¢«æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼š
\begin{itemize}
\item \texttt{include/}ï¼šmicro-librayçš„APIï¼›
\item \texttt{Config.uk}ï¼šmenu-configé…ç½®ï¼›
\item \texttt{exportsyms.uk}ï¼šå¯¼å‡ºçš„ç¬¦å·ï¼›
\item \texttt{Makefile.uk}ï¼šè‡ªåŠ¨æ„å»ºç³»ç»Ÿçš„é…ç½®ï¼›
\item \texttt{*.c}ï¼šmicro-libraryçš„å®ç°ã€‚
\item \texttt{extra.ld}ï¼šï¼ˆå¯é€‰ï¼‰é“¾æ¥å™¨é…ç½®ã€‚
\end{itemize}

æ¯”å¦‚ï¼Œ\texttt{rksched}çš„ç›®å½•ç»“æ„ï¼š
{\linespread{1}
\begin{verbatim}
    uksched
    â”œâ”€â”€ Config.uk
    â”œâ”€â”€ exportsyms.uk
    â”œâ”€â”€ extra.ld
    â”œâ”€â”€ include
    â”‚Â Â  â””â”€â”€ uk
    â”‚Â Â      â”œâ”€â”€ sched.h
    â”‚Â Â      â”œâ”€â”€ thread_attr.h
    â”‚Â Â      â”œâ”€â”€ thread.h
    â”‚Â Â      â”œâ”€â”€ wait.h
    â”‚Â Â      â””â”€â”€ wait_types.h
    â”œâ”€â”€ Makefile.uk
    â”œâ”€â”€ sched.c
    â”œâ”€â”€ thread_attr.c
    â””â”€â”€ thread.c
\end{verbatim}}

Unikraftç”¨UNIXå‘½åé£æ ¼ï¼Œå‡½æ•°åå’Œç»“æ„ä½“
ä»¥\texttt{uk\_\hspace{0cm}\textit{<micro-library\hspace{0cm}å\hspace{0cm}>}\hspace{0cm}\_}
å¼€å¤´ï¼Œç»“æ„ä½“åå\textit{é€šå¸¸}é™„åŠ \texttt{\_t}ï¼Œ
æ¯”å¦‚\texttt{uk\_malloc}ã€\texttt{uk\_alloc\_malloc\_func\_t}ã€‚
Unikraftä½¿ç”¨é¢å‘å¯¹è±¡è®¾è®¡ï¼Œæ¯ä¸ªmicro-librayä¸­é€šå¸¸æœ‰ä¸åº“åŒåçš„ç»“æ„ä½“ï¼Œå¦‚\texttt{uk\_sched}ï¼Œ
åº“ä¸­çš„å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é€šå¸¸æ˜¯æ‰§è¡Œè¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå¦‚
\texttt{\textbf{struct} uk\_sched *uk\_sched\_create(\textbf{struct} uk\_alloc *a, \textbf{size\_t} prv\_size)}ã€‚

\subsubsection{ç¼–è¯‘è¿è¡Œæµç¨‹}
ä»¥ç¼–è¯‘\href{https://github.com/unikraft/app-helloworld}{hello worldç¨‹åº}ä¸ºä¾‹ï¼Œä»‹ç»ç¼–è¯‘å¹¶
è¿è¡ŒåŸºäºUnikraftçš„unikernelçš„æµç¨‹ã€‚

é¦–å…ˆè¦ä¿®æ”¹\texttt{Makefile}ï¼ŒæŠŠ\texttt{UK\_ROOT}æ”¹ä¸ºunikraftæºä»£ç çš„ç›®å½•ï¼Œæ¯”å¦‚
\texttt{UK\_ROOT ?= \linebreak\$(PWD)/../unikraft}ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸ä¿®æ”¹\texttt{Makefile}è€Œä¿®æ”¹
å‘½ä»¤è¡Œå‚æ•°ã€‚

ç”¨\texttt{make menuconfig}é…ç½®ï¼Œç„¶åç”¨\texttt{make}ç¼–è¯‘ã€‚
\begin{figure}[!hbt]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/unikraft-menuconfig}
\vspace*{-3ex}
\caption{é…ç½®Unikraft}
\label{fig:unikraft-menuconfig}
\end{figure}
Hello worldç¨‹åºä¸Unikraftçš„å„ä¸ªè¢«ä½¿ç”¨çš„micro-libraieså…ˆè¢«åˆ†åˆ«ç¼–è¯‘æˆäº†\texttt{.o}æ–‡ä»¶ï¼Œ
å†é“¾æ¥æˆä¸€ä¸ªunikernelé•œåƒã€‚ä¸€å…±ç”Ÿæˆäº†\texttt{libkvmplat}ã€\texttt{libkvmpci}ã€\texttt{libkvmvirtio}ã€
\texttt{apphelloworld}ã€\texttt{libnolibc}ã€\texttt{libukalloc}ã€\texttt{libukallocbbuddy}ã€
\texttt{libukargparse}ã€\texttt{libukboot}ã€\texttt{libukbus}ã€\texttt{libukdebug}ã€
\texttt{libuksglist}ã€\texttt{libuktime}ã€\texttt{libuktimeconv}ã€\texttt{libx86\_64arch}ç­‰ä¸­é—´æ–‡ä»¶ã€‚
æœ€åçš„è¾“å‡ºæ˜¯18.0KiBå¤§çš„\texttt{app-\linebreak helloworld\_kvm-x86\_64.gz}ã€‚

è¯¦ç»†çš„ç¼–è¯‘æ—¥å¿—ä½äºæˆ‘ä»¬çš„ä»“åº“çš„\href{https://github.com/OSH-2022/x-runikraft/tree/d22ccf0c1b248667148fd8953b71b6e0258de6a3/reference/Unikraft%20helloworld}{reference/Unikraft helloworld/}ç›®å½•ã€‚

ç”¨\texttt{qemu-system-x86\_64 -kernel build/app-helloworld\_kvm-x86\_64 -nographic}\linebreak è¿è¡Œhello worldç¨‹åºã€‚

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/unikraft-run}
\vspace*{-3ex}
\caption{è¿è¡Œhello world}
\label{fig:unikraft-run}
\end{figure}


\subsubsection[å¼€æœºæµç¨‹]{å¼€æœºæµç¨‹ï¼ˆKVM+AMD64ï¼‰}
\begin{enumerate}
\item bootloaderï¼ˆç”±è™šæ‹Ÿæœºçš„å›ºä»¶å®ç°ï¼‰ã€‚
\item \texttt{\_libkvmplat\_start32}ï¼ˆä½äº\texttt{plat/kvm/x86/entry64.S}ï¼‰ï¼š
    \begin{enumerate}
    \item enable paeï¼›
    \item enable long modeï¼›
    \item load pml4 pointerï¼›
    \item enable pagingï¼›
    \item \texttt{jmp \_libkvmplat\_start64}ã€‚
    \end{enumerate}
\item \texttt{\_libkvmplat\_start64}ï¼š
    \begin{enumerate}
    \item ä¸€ç³»åˆ—å¤æ‚çš„åˆå§‹åŒ–ï¼›
    \item \texttt{call \_libkvmplat\_entry}ã€‚
    \end{enumerate}
\item \texttt{\_libkvmplat\_entry}ï¼ˆä½äº\texttt{plat/kvm/x86/setup.c}ï¼‰ï¼Œ
å®ƒæ¥å—\texttt{struct multiboot\_info*}å‚æ•°ï¼š
    \begin{enumerate}
    \item \texttt{\_init\_cpufeatures}ï¼›
    \item \texttt{\_libkvmplat\_init\_console}ï¼›
    \item \texttt{traps\_init}ï¼›
    \item \texttt{intctrl\_init}ï¼›
    \item \texttt{\_mb\_get\_cmdline}ï¼šæŠŠmultiboot\_infoä¸­çš„å‘½ä»¤è¡Œå‚æ•°å¤åˆ¶åˆ°æ•°æ®æ®µ
    çš„\texttt{char\linebreak cmdline[8192]}ï¼›
    \item \texttt{\_mb\_init\_mem}ï¼šå¤„ç†ä¸å†…å­˜åˆ†æ®µæœ‰å…³çš„æ“ä½œï¼›
    \item \texttt{\_mb\_init\_initrd`}ï¼›
    \item (\texttt{CONFIG\_HAVE\_SMP})\footnote{è¡¨ç¤ºåœ¨å¼€å¯æŸä¸ªé…ç½®æ—¶æ‰§è¡Œã€‚} \texttt{acpi\_init}ï¼›
    \item (\texttt{CONFIG\_HAVE\_SYSCALL}) \texttt{\_init\_syscall}ï¼›
    \item (\texttt{CONFIG\_HAVE\_X86PKU}) \texttt{\_check\_ospke}ï¼›
    è°ƒç”¨\texttt{\_libkvmplat\_newstack}ä»å¼•å¯¼æ ˆåˆ‡æ¢èµ°ã€‚
    \end{enumerate}
    å¯ä»¥çœ‹å‡ºï¼ŒAMD64çš„å¼€æœºæµç¨‹å¾ˆå¤æ‚ï¼Œåœ¨ARMv8ä¸­ï¼Œç³»ç»Ÿçš„èµ·ç‚¹æ˜¯ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™
    çš„\texttt{\_libkvmplat\_entry}ï¼Œå®ƒè°ƒç”¨ç”¨Cè¯­è¨€ç¼–å†™çš„\texttt{\_libkvmplat\_start}ï¼Œ
    ä¹‹åçš„æµç¨‹ä¸AMD64ç›¸åŒã€‚
\item \texttt{\_libkvmplat\_entry2}ï¼šæŠŠcmdlineä¼ é€’ç»™\texttt{ukplat\_entry\_argp}ã€‚
\item \texttt{ukplat\_entry\_argp}ï¼šæŠŠå‘½ä»¤è¡Œå‚æ•°æ‹†æˆargc+argvçš„å½¢å¼ï¼Œç„¶åè°ƒç”¨\texttt{ukplat\_entry}ã€‚
\item \texttt{ukplat\_entry}ï¼š
    \begin{enumerate}
    \item è°ƒç”¨\texttt{ctorfn}æ³¨å†Œçš„æ„é€ å‡½æ•°ï¼ˆ\texttt{ctors.h}æä¾›äº†æ³¨å†Œæ„é€ å‡½æ•°çš„æœºåˆ¶ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKLIBPARAM})è¿›ä¸€æ­¥åˆ†æå‘½ä»¤è¡Œå‚æ•°ï¼›
    \item (\texttt{!CONFIG\_LIBUKBOOT\_NOALLOC}) ä¾æ¬¡å°è¯•åœ¨æ¯ä¸€å—å†…å­˜åŒºåŸŸä¸Šåˆå§‹åŒ–
    åˆ†é…å™¨\linebreakï¼ˆ\texttt{uk\_<name>\_init}ï¼‰ï¼Œ
    æˆåŠŸåˆ›å»ºåˆ†é…å™¨åï¼Œå°†å‰©ä½™çš„å†…å­˜åŒºåŸŸåŠ å…¥åˆ†é…å™¨\linebreakï¼ˆ\texttt{uk\_alloc\_addmem}ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKALLOC}) åˆå§‹åŒ–ä¸­æ–­ï¼ˆ\texttt{ukplat\_irq\_init}ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKSCHED}) åˆå§‹åŒ–è°ƒåº¦å™¨\texttt{uk\_sched\_default\_init}ï¼›
    \item (\texttt{CONFIG\_LIBUKSCHED}?)
        \begin{itemize}
        \item (true)  åˆ›å»ºä¸»çº¿ç¨‹ï¼ˆæ‰§è¡Œ\texttt{main\_thread\_func}ï¼‰â†’å¯åŠ¨è°ƒåº¦å™¨ï¼ˆ\texttt{uk\_sched\_start}ï¼‰ï¼Œ
        \item (false) å¯åŠ¨ä¸­æ–­ï¼ˆ\texttt{ukplat\_lcpu\_enable\_irq}ï¼‰â†’ç›´æ¥è°ƒç”¨\texttt{main\_thread\_func}ã€‚
        \end{itemize}
    \end{enumerate}
\item \texttt{main\_thread\_func}ï¼š
    \begin{enumerate}
    \item è°ƒç”¨init tableä¸Šæ³¨å†Œçš„å‡½æ•°ï¼ˆç”±\texttt{init.h}æä¾›ï¼Œä¸\texttt{ctorfn}ç±»ä¼¼ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKSP})\texttt{uk\_stack\_chk\_guard\_setup}ï¼›
    \item è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„æ„é€ å‡½æ•° \texttt{\_\_preinit\_array}å’Œ\texttt{\_\_init\_array}ï¼›
    \item è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„\texttt{main}ã€‚
    \end{enumerate}
\item \texttt{main}ã€‚
\item å…³æœº/å´©æºƒã€‚
\end{enumerate}

\subsubsection{åˆ†é…å™¨}
åˆ†é…å™¨çš„APIä½äº\texttt{ukalloc}ï¼Œå¯é€‰çš„å®ç°æœ‰\texttt{ukallocbbuddy}ã€\texttt{ukallocpool}ã€
\texttt{ukallocregion}ã€‚\texttt{ukalloc}ç”¨å‡½æ•°æŒ‡é’ˆå®ç°äº†ç±»ä¼¼C++çš„è™šå‡½æ•°çš„è¿è¡Œæ—¶ç»‘å®šï¼Œå…¶ä»–çš„
Unikraft æ¥å£micro-librariesä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„æŠ€æœ¯ã€‚\texttt{\textbf{struct} uk\_alloc}ä¿å­˜
\texttt{malloc}ã€\texttt{free}ç­‰æŒ‡å‘å®ç°çš„å‡½æ•°æŒ‡é’ˆï¼Œ\texttt{uk\_malloc}ç­‰æ¥å£å‡½æ•°
æ¥å—\texttt{uk\_alloc}å‹æŒ‡é’ˆ\texttt{a}ï¼Œå°†å‚æ•°è½¬å‘ç»™\texttt{a}çš„å‡½æ•°æŒ‡é’ˆã€‚æ¯”å¦‚ï¼Œ\texttt{malloc}çš„
å®ç°ï¼š
\begin{lstlisting}[language=C]
static inline void *uk_do_malloc(struct uk_alloc *a, __sz size)
{
	UK_ASSERT(a);
	return a->malloc(a, size);
}

static inline void *uk_malloc(struct uk_alloc *a, __sz size)
{
	if (unlikely(!a)) {
		errno = ENOMEM;
		return __NULL;
	}
	return uk_do_malloc(a, size);
}
\end{lstlisting}

å…·ä½“çš„å®ç°è´Ÿè´£åˆå§‹åŒ–\texttt{uk\_alloc}å˜é‡ï¼Œæ¯”å¦‚\texttt{ukbbuddy}å®ç°äº†ä¼™ä¼´åˆ†é…å™¨ï¼Œå®ƒæä¾›çš„
\texttt{struct uk\_alloc *uk\_allocbbuddy\_init(void *base, size\_t len)}å‡½æ•°ä¼šæŠŠ
è‡ªå·±çš„å®ç°ç»‘å®šåˆ°\texttt{uk\_alloc}ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚

\subsubsection{è°ƒåº¦å™¨}
è°ƒåº¦å™¨APIä½äº\texttt{uksched}ï¼Œå®ƒä¸»è¦åŒ…æ‹¬\texttt{sched}å’Œ\texttt{thread}ä¸¤ä¸ªå­æ¨¡å—ã€‚

\texttt{thread}æ—¢æ˜¯æ¥å£åˆæ˜¯å®ç°ï¼Œå®ƒæä¾›é’ˆå¯¹å•ä¸ªçº¿ç¨‹çš„æ“ä½œï¼Œ
å…¶ä¸­çš„\texttt{\textbf{struct} uk\_thread}ä¿å­˜çº¿ç¨‹æ§åˆ¶å—ï¼Œ
\texttt{uk\_thread\_set\_timeslice}å‡½æ•°è®¾ç½®çº¿ç¨‹æ—¶é—´ç‰‡ï¼Œ\texttt{uk\_thread\_wake}
å‡½æ•°å”¤é†’çº¿ç¨‹ï¼Œæ ¹æ®çº¿ç¨‹çš„æ—¶é—´ç‰‡è®¾ç½®å®šæ—¶å™¨ï¼Œç„¶åæŠŠæ§åˆ¶æƒè½¬äº¤ç»™è¿™ä¸ªçº¿ç¨‹ï¼Œè¿™äº›æ“ä½œéœ€è¦è°ƒç”¨\texttt{ukplat}
çš„APIã€‚

\texttt{sched}æ˜¯åªæ˜¯æ¥å£ï¼Œå®ƒ
è´Ÿè´£ç®¡ç†æ‰€æœ‰çº¿ç¨‹ï¼Œå®ƒè°ƒç”¨\texttt{thread}çš„APIæ“ä½œå•ä¸ªçº¿ç¨‹ã€‚
\texttt{ukschedcoop}æ˜¯\texttt{uksched}çš„å®ç°ä¹‹ä¸€ï¼Œå®ƒå®ç°äº†æœ€åŸºæœ¬éæŠ¢å å¼çš„æ—¶é—´ç‰‡è½®è½¬çº¿ç¨‹è°ƒåº¦å™¨ã€‚
å®ƒä½¿ç”¨åŒé“¾å°¾é˜Ÿåˆ—ï¼ˆtail queueï¼‰ç»´æŠ¤æ‰€æœ‰çº¿ç¨‹ï¼ˆ\texttt{thread\_list}ï¼‰å’Œ
ç¡çœ çŠ¶æ€ï¼ˆå°±ç»ªæˆ–ç­‰å¾…ï¼‰çš„çº¿ç¨‹ï¼ˆ\texttt{sleeping\_threads}ï¼‰ã€‚
æ¯ä¸€è½®è°ƒåº¦ï¼Œ\texttt{ukschedcoop}ä»ç¡çœ çº¿ç¨‹é˜Ÿåˆ—
ä¸­æ‰¾å‡ºä¸€ä¸ªå¤„åœ¨å°±ç»ªæ€çš„çº¿ç¨‹ï¼Œå¹¶å”¤é†’ï¼ˆ\texttt{uk\_thread\_wake}ï¼‰è¿™ä¸ªçº¿ç¨‹ï¼Œ
å¦‚æœæ²¡æœ‰ä»»ä½•èƒ½æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå°±æŒ‚èµ·CPUï¼ˆ\texttt{ukplat\_lcpu\_halt\_to}ï¼‰ï¼Œ
ç›´åˆ°æŸä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œã€‚\texttt{ukschedcoop}å¹¶ä¸éœ€è¦ä¸ºæ¯ä¸€ä¸ªäº‹ä»¶ç»´æŠ¤ç­‰å¾…é˜Ÿåˆ—ï¼Œ
å› ä¸ºå³ä½¿çº¿ç¨‹ç­‰å¾…çš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œç”±äºå½“å‰çº¿ç¨‹çš„æ‰§è¡Œä¸èƒ½è¢«æŠ¢å ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¹Ÿä¸èƒ½è¢«ç«‹å³å”¤é†’ã€‚

Unikraftçš„è®ºæ–‡ä¸­æåˆ°äº†å®ƒæ‹¥æœ‰æŠ¢å å¼è°ƒåº¦å™¨\texttt{ukpreempt}ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨å®ƒçš„æºä»£ç ä¸­æ‰¾åˆ°ç›¸åº”çš„å®ç°ã€‚

\section{æŠ€æœ¯ä¾æ®}
\subsection{rustcäº¤å‰ç¼–è¯‘}
å…ˆå®‰è£…äº¤å‰ç¼–è¯‘riscv64gcçš„ç¼–è¯‘å™¨ç»„ä»¶ï¼Œ
ç„¶ååœ¨ç¼–è¯‘æ—¶é™„åŠ \texttt{--target riscv64gc-\linebreak unknown-none-elf}é€‰é¡¹å³å¯å®ç°x86-64--riscv64äº¤å‰ç¼–è¯‘ã€‚

è¿˜éœ€è¦å®‰è£…\texttt{rust-objcopy}ä»¥ç”ŸæˆQEMUèƒ½åŠ è½½çš„åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

\noindent å‘½ä»¤ï¼ˆå‡å®šå·²å®‰è£…é€šè¿‡rustupå®‰è£…Rustæ„å»ºå·¥å…·é“¾ï¼‰ï¼š
\begin{lstlisting}
rustup target add riscv64gc-unknown-none-elf
cargo install cargo-binutils
\end{lstlisting}

\subsection{å¯åŠ¨æ“ä½œç³»ç»Ÿ}
æ·»åŠ ç¼–è¯‘é€‰é¡¹\texttt{-Clink-arg=-Tlinker.ld}ä»¥ä¾¿é“¾æ¥å™¨èƒ½è¯»å–è‡ªå®šä¹‰çš„é“¾æ¥è„šæœ¬ï¼š
\begin{multicols}{2}
\begin{lstlisting}
OUTPUT_ARCH(riscv)
ENTRY(__runikraft_start)
BASE_ADDRESS = 0x80200000;

SECTIONS
{
    . = BASE_ADDRESS;
    skernel = .;

    stext = .;
    .text : {
        *(.text.entry)
        *(.text .text.*)
    }

    . = ALIGN(4K);
    etext = .;
    srodata = .;
    .rodata : {
        *(.rodata .rodata.*)
        *(.srodata .srodata.*)
    }

    . = ALIGN(4K);
    erodata = .;
    sdata = .;
    .data : {
        *(.data .data.*)
        *(.sdata .sdata.*)
    }

    . = ALIGN(4K);
    edata = .;
    .bss : {
        *(.bss.stack)
        sbss = .;
        *(.bss .bss.*)
        *(.sbss .sbss.*)
    }

    . = ALIGN(4K);
    ebss = .;
    ekernel = .;

    /DISCARD/ : {
        *(.eh_frame)
    }
}
\end{lstlisting}
\end{multicols}

åˆå§‹åŒ–å‡½æ•°éœ€è¦ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ï¼š
\begin{lstlisting}[numbers=left]
.extern sbss
.extern ebss

.section .text.entry
.globl __runikraft_start

__runikraft_start:
    #æ¸…ç©ºbssæ®µ
    la t0,sbss
    la t1,ebss
    clean_bss:
        bge t0,t1,clean_bss_end
        sd x0,(t0)
        addi t0,t0,8
        j clean_bss
    clean_bss_end:
    addi t0,zero,0
    addi t1,zero,0
    #åŠ è½½æ ˆæŒ‡é’ˆ
    la sp,stack_top
    call __runikraft_entry_point

.section .bss.stack
    .space 65536
stack_top:
\end{lstlisting}
å®ƒåŠ è½½æ ˆæŒ‡é’ˆï¼Œç„¶åå°†æ§åˆ¶æƒè½¬äº¤ç»™ç”¨Rustå†™çš„æ›´é«˜å±‚çš„åˆå§‹åŒ–å‡½æ•°ã€‚ç›®å‰åè€…è¿˜åªæœ‰é›å½¢ï¼Œå®ƒåªåˆå§‹åŒ–\texttt{rk::plat}æ¨¡å—
çš„å®šæ—¶å™¨å­æ¨¡å—ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·ç¨‹åºçš„å…¥å£\texttt{main}ã€‚
\begin{lstlisting}[language=Rust,numbers=left]
/// ç³»ç»Ÿçš„å…¥å£ï¼Œç”±å¼•å¯¼ç¨‹åºè°ƒç”¨
///
#[no_mangle]
pub fn __runikraft_entry_point()->!{
    time::init();
    unsafe{main();}
    halt();
}
\end{lstlisting}

\texttt{\_\_runikraft\_entry\_point}å’Œ\texttt{\_\_runikraft\_start}éƒ½æ˜¯Runikraftæ ¸å¿ƒç»„ä»¶çš„
\texttt{plat::\linebreak bootstrap}çš„ä¸€éƒ¨åˆ†ï¼Œç›®å‰çš„æ ¸å¿ƒç»„ä»¶è¿˜å·²ç»å®ç°äº†\texttt{plat::console}å’Œ
\texttt{plat::time}ä¸¤ä¸ª\texttt{plat}æ¨¡å—çš„å­æ¨¡å—ï¼Œä»¥åŠ\texttt{bitcount}æ¨¡å—ï¼ˆè¿™ä¸ªæ¨¡å—å®Œå…¨æ˜¯
å¯¹Unikraftçš„\texttt{bitcount.c}çš„ç¿»è¯‘ï¼‰ã€‚ç›®å‰å·²ç»å®ç°äº†\texttt{rkalloc} APIï¼ˆå¯¹åº”Unikraftçš„
\texttt{ukalloc}ï¼Œè¿™ä¸ªAPIæœ‰ä¸€ä¸ªæ¼”ç¤ºç”¨çš„â€œç©ºå®ç°â€\texttt{rkalloc\_empty}ã€‚

ç›®å‰çš„\texttt{main}å‡½æ•°èƒ½ç®€å•æ¼”ç¤º\texttt{plat::console}ã€\texttt{plat::time}å’Œ\texttt{rkalloc}ï¼š
\begin{lstlisting}[language=Rust,numbers=left]
#![no_std]
#![no_main]

use runikraft as rk;

use rkalloc::RKalloc;
use rkalloc_empty::RKallocEmpty;
use rk::plat::time;

static mut HEAP_SPACE: [u8;1000] = [0;1000];

#[no_mangle]
fn main() {
    let mut alloc;
    unsafe {
        alloc = RKallocEmpty::new(HEAP_SPACE.as_mut_ptr(),1000);
    }
    rk::println!("Hello, world!");
    let p1 = unsafe{alloc.malloc(10)};
    rk::println!("p1={:?}",p1);
    let p2 = unsafe{alloc.malloc(5)};
    rk::println!("p2={:?}",p2);
    rk::println!("sleep for 10s");
    let start = time::get_ticks();
    loop {
        if (time::get_ticks() - start).as_secs()>=10 {break;}
    }
    let end = time::get_ticks();
    rk::println!("slept for {:?}",end - start);
}
\end{lstlisting}

\subsection{ç¼–è¯‘}
ä¾æ¬¡è¿è¡Œ
\begin{lstlisting}
cargo build --release
rust-objcopy --strip-all build/riscv64gc-unknown-none-elf/release/dev-test -O binary build/riscv64gc-unknown-none-elf/release/dev-test.bin
\end{lstlisting}
å³å¯å®Œæˆç¼–è¯‘ã€‚

\subsection{è¿è¡Œå’Œè°ƒè¯•}
è¿™ä¸€æ­¥éœ€è¦QEMU \texttt{riscv64}ã€\texttt{riscv64-unknown-elf} GDBå’ŒOpenSBIçš„
\texttt{fw\_jump.bin}ã€‚QEMUå¯ä»¥ç”¨\texttt{sudo apt install qemu-system-misc}å®‰è£…ï¼Œ
å½“ç„¶ä¹Ÿå¯ä»¥ç”¨\texttt{sudo apt install qemu-system}å®Œæ•´åœ°å®‰è£…QEMUã€‚ç¬¦åˆè¦æ±‚çš„GDBå¹¶æ²¡æœ‰
è¢«æ”¶å½•åœ¨Ubuntuçš„è½¯ä»¶æºä¸­ï¼Œå¹¸å¥½SiFiveæä¾›äº†ä¸€å¥—é¢„ç¼–è¯‘çš„è°ƒè¯•å·¥å…·é“¾ï¼Œå…¶å¯åœ¨\
\href{https://github.com/sifive/freedom-tools/releases}{sifive/freedom-tools}\
ä¸‹è½½ã€‚ä¸‹è½½å¹¶è§£å‹åï¼Œå¯ä»¥å°†\texttt{riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86\_64-linux-ubuntu14/bin}æ·»åŠ åˆ°\texttt{PATH}ã€‚
QEMUçš„æ–‡æ¡£å£°ç§°å·²ç»é™„å¸¦äº†\texttt{OpenSBI}\cite{qemu-virt}ï¼Œ
ä½†æ˜¯Ubuntu 20.04çš„APTæºä¸­çš„QEMUå¹¶æ²¡æœ‰é™„å¸¦ï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦åˆ°
\ \href{https://github.com/riscv-software-src/opensbi/releases/tag/v1.0}{OpenSBI Version 1.0}\
æ‰‹åŠ¨ä¸‹è½½ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯\linebreak\texttt{opensbi-1.0-rv-bin/share/opensbi/lp64/generic/firmware/fw\_jump.bin}ã€‚
ä¸ºäº†æ–¹ä¾¿åç»­ä½¿ç”¨ï¼Œå¯ä»¥åœ¨\texttt{~/.bashrc}ä¸­åŠ ä¸Š\texttt{export RISCV\_BIOS=\textit{<PATH\_TO\_fw\_jump.bin>}}ã€‚

ä¸€åˆ‡å®‰è£…å®Œæ¯•åï¼Œå¯ä»¥ç”¨
\begin{lstlisting}
qemu-system-riscv64 -machine virt -nographic -bios $RISCV_BIOS -device loader,file=build/riscv64gc-unknown-none-elf/release/dev-test.bin,addr=0x80200000 -s -S
\end{lstlisting}
å¯åŠ¨ç³»ç»Ÿã€‚ç”¨
\begin{lstlisting}
riscv64-unknown-elf-gdb -ex 'file build/riscv64gc-unknown-none-elf/release/dev-test' -ex 'set arch riscv:rv64' -ex 'target remote localhost:1234'
\end{lstlisting}
è¿›è¡Œäº¤äº’å¼è°ƒè¯•ã€‚

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/debug.png}
\vspace*{-3ex}
\caption{è°ƒè¯•}
\label{fig:debug}
\end{figure}

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/run.png}
\vspace*{-3ex}
\caption{è¿è¡Œç»“æœ}
\label{fig:run}
\end{figure}

\subsection{QEMUæ€§èƒ½æµ‹è¯•}
Unikernelä»¥é«˜æ€§èƒ½è‘—ç§°ï¼Œæ€§èƒ½ä¹Ÿæ˜¯è¯„ä»·unikernelçš„é‡è¦æŒ‡æ ‡ã€‚
ç„¶è€Œé—æ†¾çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ— æ³•å¾—åˆ°RISC-Vç‰©ç†æœºï¼Œè€ŒQEMUä»¿çœŸç¡¬ä»¶æ¶æ„æœ¬èº«
ä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æŸå¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾å‡†ç¡®è¯„ä¼°æˆ‘ä»¬å†™çš„Runikraftçš„æ€§èƒ½ã€‚
ä¸ºäº†ç›¸å¯¹å‡†ç¡®çš„ä¼°è®¡Runikraft
çš„æ€§èƒ½ï¼Œå¯ä»¥æµ‹è¯•QEMUä»¿çœŸæœ¬èº«å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼Œ
ç„¶åå¯ä»¥ç”¨QEMUä¸Šçš„è¿è¡Œæ—¶é—´é™¤ä»¥æ€§èƒ½æŸå¤±æ¯”\footnote{riscv64æ—¶é—´Ã· x86-64æ—¶é—´}ï¼Œä¼°è®¡çœŸå®RISC-V
ç¡¬ä»¶ä¸Šçš„è¿è¡Œæ—¶é—´ã€‚

æˆ‘ä»¬ç”¨ç»„å‘˜å¼ å­è¾°åŒå­¦çš„æ•°æ®ç»“æ„è¯¾ç¨‹çš„å¤§ä½œä¸š
\href{https://github.com/WCIofQMandRA/huffman_compressor}{Huffmanæ ‘å‹ç¼©å™¨}åšäº†åŸºå‡†æµ‹è¯•ã€‚
æµ‹è¯•ç»“æœè§è¡¨\ \ref{table:test}ã€‚
\begin{longtable}{|c||>{\ttfamily}r|>{\ttfamily}r|>{\ttfamily}r||>{\ttfamily}r|>{\ttfamily}r|>{\ttfamily}r|}
\caption{QEMUåŸºå‡†æµ‹è¯•}\label{table:test}\\
\hline
\multirow{2}{*}{æ–‡ä»¶}&\multicolumn{3}{c|}{å‹ç¼©/s}&\multicolumn{3}{c|}{æå–/s}\\\cline{2-7}
&\multicolumn{1}{c|}{x86-64}&\multicolumn{1}{c|}{riscv64}&\multicolumn{1}{c||}{æŸå¤±æ¯”}&
\multicolumn{1}{c|}{x86-64}&\multicolumn{1}{c|}{riscv64}&\multicolumn{1}{c|}{æŸå¤±æ¯”}\\\hline
\endfirsthead
test01&0.019& 0.079&4.16&0.009&0.058&6.44\\\hline
test02&0.040& 0.134&3.35&0.011&0.083&7.55\\\hline
test03&1.075& 3.054&2.84&0.316&1.624&5.14\\\hline
test04&1.114& 3.285&2.95&0.272&1.701&6.23\\\hline
test05&0.715& 2.085&2.92&0.201&1.116&5.55\\\hline
test06&5.001&14.121&2.82&1.177&7.018&5.96\\\hline
\end{longtable}

æµ‹è¯•è„šæœ¬æ˜¯\href{https://github.com/WCIofQMandRA/huffman_compressor/blob/8ab200b656a0e087e27480fcbcae4000a59f6b47/test/benchmark.sh}{test/bencmark.sh}ã€‚
åŸå§‹è®°å½•è§æˆ‘ä»¬çš„ä»“åº“çš„\href{https://github.com/OSH-2022/x-runikraft/tree/eca8a7575be96fb0a4dc311a8c60622c0e9b0aa5/reference/qemu-benchmark.log}{reference/qemu-benchmark.log}ã€‚

ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¸åŒç±»å‹çš„ç¨‹åºçš„æŸå¤±æ¯”å¹¶ä¸ç›¸åŒï¼Œä½†æ˜¯æˆ‘ç›®å‰å¹¶æ²¡æœ‰å¼„æ¸…æ¥š
ä»€ä¹ˆæ ·çš„ç¨‹åºæ›´å®¹æ˜“é€ æˆæ€§èƒ½æŸå¤±ã€‚ç”±äºQEMUæ— æ³•æœ‰æ•ˆåˆ©ç”¨å¤„ç†å™¨çš„åˆ†å€¼é¢„æµ‹å’Œé«˜é€Ÿç¼“å­˜ï¼Œ
æˆ‘çŒœæµ‹æµæ°´çº¿å‹å¥½å’Œç¼“å­˜å‹å¥½çš„ç¨‹åºä¼šå› æ­¤è¾ƒå¤§çš„æ€§èƒ½æŸå¤±ã€‚è€ƒè™‘åˆ°å†…æ ¸çš„å¤§éƒ¨åˆ†æ“ä½œä¸æ¶‰åŠå¤§èŒƒå›´çš„
å¯»å€ï¼Œå¯ä»¥è®¤ä¸ºç³»ç»Ÿå†…æ ¸å±äºä¼šå¼•èµ·è¾ƒå¤§æ€§èƒ½æŸå¤±çš„ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠQEMUä»¿çœŸå¸¦æ¥çš„æ€§èƒ½æŸå¤±è§†ä¸º5ã€‚

\section{åˆ›æ–°ç‚¹}
ä¸å…ˆå‰ç”¨Rustæ”¹å†™FreeRTOSçš„å°ç»„ç±»ä¼¼ï¼Œæˆ‘ä»¬çš„é¡¹ç›®åé‡å·¥ç¨‹ï¼Œæ²¡æœ‰ç†è®ºä¸Šçš„åˆ›æ–°ç‚¹ã€‚
ç”±äºæˆ‘ä»¬äº†è§£çš„æ‰€æœ‰ç”¨Rustå†™çš„æ“ä½œç³»ç»Ÿéƒ½æˆ–å¤šæˆ–å°‘çš„ä½¿ç”¨äº†unstableçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ç”¨stableç‰¹æ€§
ç¼–å†™unikernelä¹Ÿä¸å¤±ä¸ºä¸€ç§æŠ€æœ¯ä¸Šçš„åˆ›æ–°ã€‚
\section{æ¦‚è¦è®¾è®¡}
\subsection{æ¶æ„}
Runikraftçš„æ¶æ„ä¸Unikraftå‡ ä¹ç›¸åŒã€‚
\begin{figure}[!hbt]
\centering
\begin{minipage}{0.49\linewidth}
\centering
\includegraphics[width=\linewidth]{assets/Unikraft-architecture.png}
\caption{Unikraftçš„æ¶æ„}\label{fig:unikraft-arch}
\end{minipage}
\begin{minipage}{0.49\linewidth}
\centering
\includegraphics[width=\linewidth]{assets/Runikraft-architecture.pdf}
\caption{Runikraftçš„æ¶æ„}\label{fig:runikraft-arch}
\end{minipage}
\end{figure}
å¹³å°å±‚å°†ä¸åŒçš„å¹³å°å°è£…æˆé€šç”¨çš„\texttt{rkplat} APIï¼Œå®ƒæä¾›ä¸å¹³å°/æ¶æ„å¯†åˆ‡ç›¸å…³çš„åŠŸèƒ½ï¼Œ
æ¯”å¦‚å¤–è®¾é©±åŠ¨ã€å¤–ä¸­æ–­å¤„ç†ã€å†…å­˜åˆ†é¡µã€å®šæ—¶å™¨ã€åŸå­æ“ä½œã€å†…å­˜å±éšœï¼Œæˆ‘ä»¬åªè®¡åˆ’æ”¯æŒRISC-V+QEMU virt
ä¸€ç§å¹³å°ã€‚å¦‚æœæ—¶é—´ä¸è¶³ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç°æˆçš„OpenSBI\cite{5}\cite{6}å°è£…æˆ\texttt{rkplat} APIã€‚

\texttt{rknetdev}ã€\texttt{rkblkdev}ã€\texttt{rktime}ã€\texttt{rkswrand}ã€\texttt{rkboot}
äº”ä¸ªAPIsçš„åŠŸèƒ½ä¸å¹³å°å¯†åˆ‡ç›¸å…³ï¼Œ
ä½†æ˜¯ä¸ºäº†é™ä½å¼€å‘å’Œç»´æŠ¤éš¾åº¦ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰ç›´æ¥å®ç°ï¼Œè€Œæ˜¯åœ¨\texttt{rkplat}æä¾›çš„åˆçº§æŠ½è±¡çš„åŸºç¡€ä¸Šå®ç°ã€‚
\texttt{rknetdev}å’Œ\texttt{rbblkdev}å¯¹åº”å›¾\ \ref{fig:unikraft-arch}\ çš„â‘¦å’Œâ‘§ï¼Œ
å®ƒä»¬åˆ†åˆ«æä¾›ç½‘ç»œè®¾å¤‡å’Œå—è®¾å¤‡çš„æ”¯æŒã€‚
%ä¸Unikraftçš„å®ç°ç±»ä¼¼ï¼Œè¿™ä¸¤ä¸ªAPIsçš„æ„é€ å‡½æ•°çš„å‚æ•°æ¥å—æŒ‡å‘\texttt{trait RKplat}çš„æŒ‡é’ˆã€‚
\texttt{rktime}æä¾›è·å–å’Œä¿®æ”¹ç³»ç»Ÿæ—¶é—´çš„APIï¼Œ\texttt{rkswrand}æä¾›å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ï¼Œ
\texttt{rkboot}è´Ÿè´£å®Œæˆç³»ç»Ÿçš„åˆå§‹åŒ–å¹¶å°†æ§åˆ¶æƒè½¬äº¤ç»™ç”¨æˆ·çš„ä»£ç ã€‚

\texttt{rksched}å’Œ\texttt{rklock}æ˜¯ä¸¤ä¸ªä¸è°ƒåº¦å™¨æœ‰å…³çš„APIsï¼Œå‰è€…è´Ÿè´£åˆ›å»ºã€è°ƒåº¦ã€æ’¤é”€çº¿ç¨‹ï¼Œåè€…è´Ÿè´£çº¿ç¨‹é—´
çš„åŒæ­¥å’Œäº’æ–¥ã€‚Runikraftæ”¯æŒå¤šç§è°ƒå–å™¨ï¼Œæ¯”å¦‚ï¼Œå›¾\ \ref{fig:runikraft-arch}\ ä¸­çš„RRçš„æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦å™¨ã€
Mul-quæ˜¯å¤šé‡é˜Ÿåˆ—è°ƒå–å™¨ã€EDFæ˜¯æˆªæ­¢æ—¥æœŸæœ‰é™è°ƒåº¦å™¨ã€‚æˆ‘ä»¬è®¡åˆ’å…ˆå®ç°RRè°ƒåº¦å™¨ã€‚å½“ç„¶ï¼Œä¸ºäº†ç³»ç»Ÿé•œåƒçš„è½»é‡æ€§ï¼Œ
ç”¨æˆ·å¯ä»¥ä¸ä½¿ç”¨ä»»ä½•è°ƒå–å™¨ï¼Œè¿™æ—¶ï¼Œ\texttt{rksched}å’Œ\texttt{rklock}ä¼šè¢«ç¼–è¯‘æˆç©ºAPIï¼Œåˆ›å»ºçº¿ç¨‹çš„è¡Œä¸º
å°†å’Œå‡½æ•°è°ƒç”¨ç›¸åŒã€‚è¿™ä¿è¯äº†å¤§éƒ¨åˆ†ä½¿ç”¨ä»…ä»…å¹¶è¡ŒåŠ é€Ÿçš„ç¨‹åºä»ç„¶èƒ½æ­£ç¡®è¿è¡Œã€‚

Runikrafté€‰æ‹©æ€§åœ°æä¾›çº¿ç¨‹é€šä¿¡æ¨¡å—ï¼Œå¦‚UNIXé£æ ¼çš„ä¿¡å·ï¼ˆ\texttt{rksignal}ï¼‰ï¼Œä¿¡ç®±ï¼ˆ\texttt{rkmbox}ï¼‰ï¼Œ
æ— é”çš„ç¯å½¢ç¼“å†²é˜Ÿåˆ—ï¼ˆ\texttt{rkring}ï¼‰ã€‚

æˆ‘ä»¬ç›®å‰æ²¡æœ‰è®¡åˆ’åŒºåˆ†çº¿ç¨‹å’Œè¿›ç¨‹ï¼ŒRunikraftçš„çº¿ç¨‹åŒæ—¶å…·æœ‰ä¼ ç»Ÿçš„OSesçš„çº¿ç¨‹å’Œè¿›ç¨‹çš„ç‰¹æ€§ï¼š
çº¿ç¨‹ä¹‹é—´æ²¡æœ‰éš”ç¦»æªæ–½ï¼Œä½†æ˜¯çº¿ç¨‹ä¹‹é—´åˆå¯ä»¥ä½¿ç”¨è¿›ç¨‹é€šä¿¡çš„æ–¹æ³•æ›´å®‰å…¨åœ°åŒæ­¥ã€‚

\texttt{rkalloc}æ˜¯åˆ†é…å™¨APIï¼Œå®ƒçš„åç«¯å¯ä»¥æ˜¯\texttt{buddy}ã€\texttt{tinyalloc}ã€\texttt{tlsf}ã€
\texttt{mimalloc}ç­‰åˆ†é…å™¨ã€‚
ä¸è¿‡ï¼Œæˆ‘ä»¬å¯èƒ½åªä¼šå®ç°å…¶ä¸­çš„ä¸€ä¸ªã€‚

Runikraftè¿˜æä¾›äº†ä¸€äº›å·¥å…·æ¨¡å—ï¼Œæ¯”å¦‚è°ƒè¯•å·¥å…·\texttt{rkdebug}ã€å‘½ä»¤è¡Œå‚æ•°åˆ†æå·¥å…·\texttt{rkparam}ã€‚

åœ¨ Unikraft ä¸­,æ–‡ä»¶ç³»ç»Ÿ API vfscore æ˜¯ POSIX å…¼å®¹å±‚çš„ä¸€éƒ¨åˆ†,æˆ‘ä»¬æ²¿ç”¨äº†å®ƒçš„è®¾
è®¡,å°† \texttt{vfscore} æ”¾åœ¨äº†å…¼å®¹å±‚ã€‚Runikraftè®¡åˆ’æ”¯æŒRAMä¸Šçš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿå’ŒPlan 9 OSçš„9fpsã€‚

ä½äºæœ€é¡¶å±‚çš„æ˜¯è¯­è¨€æ ‡å‡†åº“ï¼Œè¿™ä¸€å±‚å¯ä»¥å¸®åŠ©Runikraftæ”¯æŒå¤šç§è¯­è¨€ã€‚
è™½ç„¶è¯­è¨€æ ‡å‡†åº“å±‚è¢«ç”»åœ¨äº†å…¼å®¹å±‚ä¹‹ä¸Šï¼Œä½†å®ƒå…¶å®æ˜¯ç›´æ¥ç”¨OSå…ƒä»¶å±‚çš„APIså®ç°çš„ï¼Œè¿™èƒ½é¿å…åˆ†å±‚ç³»ç»Ÿ
çš„ä½æ•ˆã€‚
æˆ‘ä»¬åªæ‰“ç®—å®ç°Rustæ ‡å‡†åº“å’ŒCæ ‡å‡†åº“çš„éƒ¨åˆ†å†…å®¹ã€‚

\subsection{æ”¹å†™æ–¹æ³•}

\subsubsection{ç±»å‹è½¬æ¢}
ä¸‹é¢æ˜¯é€šå¸¸æƒ…å†µä¸‹Unikraftä½¿ç”¨çš„Cç±»å‹å¯¹åº”çš„Rustç±»å‹ã€‚
è¶Šå…ˆå‡ºç°çš„è§„åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå³å¦‚æœä¸€ä¸ªCç±»å‹ä¸å¤šæ¡è§„åˆ™åŒ¹é…ï¼Œåˆ™æŒ‰æœ€å…ˆå‡ºç°çš„è§„åˆ™è½¬æ¢
æˆRustç±»å‹ï¼Œä½†æ˜¯å¦‚æœè½¬æ¢åçš„ç±»å‹ä¼šå¼•èµ·æ‰€æœ‰æƒé—®é¢˜ï¼Œåˆ™æ”¾å¼ƒè¿™æ¡è½¬æ¢è§„åˆ™ï¼ŒæŒ‰ä¸‹ä¸€æ¡åŒ¹é…çš„
è§„åˆ™è½¬æ¢ã€‚
\begin{longtable}{|l|l|}
\caption{}\\
\hline
Cç±»å‹&Rustç±»å‹\\\hline
\endfirsthead
\hline
Cç±»å‹&Rustç±»å‹\\\hline
\endhead
\texttt{long}&\texttt{isize}\\\hline
\texttt{unsigned long}&\texttt{usize}\\\hline
\texttt{\_\_sz}&\texttt{usize}\\\hline
\texttt{\_\_nsec}&\texttt{core::time::Duration}\\\hline
ä»£è¡¨é”™è¯¯ä¿¡æ¯çš„\texttt{int}&\texttt{Result<(),i32>}\\\hline
å–1æˆ–0çš„\texttt{int}&\texttt{bool}\\\hline
\texttt{T[N]}&\texttt{[T;N]}\\\hline
\texttt{void \_\_noreturn}&\texttt{!}\\\hline
\texttt{void*}&ï¼ˆæ³›å‹å‡½æ•°ï¼‰\texttt{*mut T}\\\hline
\texttt{void*}&ï¼ˆæ³›å‹å‡½æ•°ï¼‰\texttt{*const T}\\\hline
\texttt{void*}&\texttt{*const u8}\\\hline
\texttt{void*}&\texttt{*mut u8}\\\hline
\texttt{const char*}&\texttt{\&str}\\\hline
ä¼ é€’ç»“æœçš„\texttt{T*}ï¼Œè¿”å›\texttt{int}&\texttt{Result<T,int>}æˆ–\texttt{Optional<T>}\\\hline
ä¼ é€’ç»“æœçš„\texttt{T*}ï¼Œè¿”å›\texttt{void}&\texttt{T}\\\hline
\texttt{T*}+\hspace{0cm}é•¿åº¦&\texttt{\&mut [T]}\\\hline
\texttt{const T*}+\hspace{0cm}é•¿åº¦&\texttt{\&[T]}\\\hline
\texttt{T*}&\texttt{\&mut T}\\\hline
\texttt{T*}&\texttt{*mut T}\\\hline
\texttt{const T*}&\texttt{\&T}\\\hline
\texttt{const T*}&\texttt{*const T}\\\hline
æ•´å‹&é•¿åº¦å’Œç¬¦å·ç›¸åŒçš„æ•´å‹\\\hline
æµ®ç‚¹ç±»å‹&é•¿åº¦ç›¸åŒçš„æµ®ç‚¹ç±»å‹\\\hline
\end{longtable}

Unikraftç”¨åˆ°äº†å°‘é‡åŒé‡æŒ‡é’ˆã€‚ä¸€èˆ¬åœ°ï¼ŒCçš„åŒé‡æŒ‡é’ˆ\texttt{T**}åœ¨C++çš„å«ä¹‰æ˜¯\texttt{T \&*}ï¼Œ
æ‰€ä»¥å®ƒå¯¹åº”Rustçš„\texttt{\&mut *mut T}ã€‚ä½†æ˜¯è¿™ç§å†™æ³•æ¯”è¾ƒä¸‘é™‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°½é‡é€šè¿‡æ”¹å†™
å‡½æ•°ä¼ å‚çš„æ–¹å¼ï¼Œé¿å…ä½¿ç”¨æŒ‡é’ˆçš„å¼•ç”¨ã€‚

\subsubsection{é¢å‘å¯¹è±¡å¼å‡½æ•°}
æ‰€è°“â€œé¢å‘å¯¹è±¡å¼å‡½æ•°â€å°±æ˜¯\ \ref{ssubsec:code-style}\ æåˆ°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯
ä¸åº“åŒåçš„ç»“æ„ä½“çš„æŒ‡é’ˆçš„å‡½æ•°ã€‚åœ¨Rustä¸­ï¼Œå¯ä»¥æŠŠè¿™äº›å‡½æ•°æ”¾åœ¨\texttt{\textbf{impl}}å—
ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯\texttt{\textbf{self}}ã€‚

å¦‚\texttt{ukring}çš„å…¥é˜Ÿæ“ä½œ
\begin{lstlisting}[language=C]
static __inline int
uk_ring_enqueue(struct uk_ring *br, void *buf)
{
    /* å®ç°ç•¥ */
}
\end{lstlisting}
æ”¹å†™ä¸º
\begin{lstlisting}[language=Rust]
impl Ring {
    fn enqueue<T>(&mut self, buf: *const T)->Result<(),i32> {
        // å®ç°ç•¥
    }
}
\end{lstlisting}

\subsubsection{å®}

ç”¨\ \ref{subsec:cond-compile}\ çš„æ–¹æ³•å¤„ç†æ¡ä»¶ç¼–è¯‘å®ã€‚
æŠŠå®å¸¸é‡è½¬æ¢ä¸ºé™æ€å˜é‡ã€‚æŠŠä»¿å‡½æ•°å®è½¬æ¢æˆå†…è”å‡½æ•°ï¼Œåœ¨å¿…è¦æ—¶ä½¿ç”¨æ³›å‹ã€‚
æŠŠç”¨å®å®ç°çš„æ¨¡æ¿ç±»å‹è½¬æ¢æˆåŸºäºæ³›å‹çš„ç»“æ„ä½“ï¼Œå®ƒä»¬ä¸»è¦æ˜¯é“¾è¡¨è¿™æ ·çš„å®¹å™¨ã€‚

\subsubsection{ç¼–è¯‘æç¤º}
Rustçš„ä¸­çš„\texttt{cold}å±æ€§å¯ä»¥å……å½“GCCä¸­çš„\texttt{\_\_builtin\_expect(\textit{<expr>},0)}ï¼Œ
ä¹Ÿå°±æ˜¯\texttt{unlikely(\textit{<expr>})}ï¼Œä½†æ˜¯Rustä¸­æ²¡æœ‰å«ä¹‰æ˜¯\texttt{likely}çš„å±æ€§ã€‚

GCCçš„\texttt{\_\_inline}ç­‰ä»·äºRustçš„\texttt{\#[inline]}ï¼Œ
GCCçš„\texttt{\_\_attribute\_\_((always\_inline))}ç­‰ä»·äºRustçš„\texttt{\#[inline(always)]}ï¼Œ
GCCçš„\texttt{\_\_attribute\_\_((no\_inline))}ç­‰ä»·äºRustçš„\texttt{\#[inline(never)]}ã€‚

ä¸€äº›ä¾èµ–å¸ƒå±€çš„ç»“æ„ä½“ï¼Œå¦‚\texttt{\_\_regs}æ”¹å†™æˆRuståéœ€è¦é™„åŠ \texttt{\#[repr(C)]}å±æ€§ï¼Œ
ä»¥ç¡®ä¿èƒ½ç›´æ¥é€šè¿‡åç§»é‡è®¿é—®ç»“æ„ä½“æˆå‘˜ã€‚
\subsection{æ—¶é—´å®‰æ’}
ä»¥æ˜ŸæœŸæ—¥ä¸ºä¸€å‘¨çš„èµ·ç‚¹ã€‚å¤§ä½“ä¸Šï¼Œç¬¬10\tildechar14å‘¨å®ç°OSå…ƒä»¶å±‚ï¼Œç¬¬15ã€16å‘¨å®ç°å…¼å®¹å±‚ï¼Œå…·ä½“å®‰æ’è§
è¡¨\ \ref{table:schedule}ã€‚
\begin{table}[!hbt]
\centering
\caption{æ—¶é—´å®‰æ’}\ \label{table:schedule}
\begin{tabular}{|r|l|l|l|l|l|}
\hline
ç¬¬10å‘¨&\multirow{2}{*}{\texttt{rkplat}}&\texttt{rkalloc}&\multirow{2}{*}{\texttt{rkring}}&\multirow{3}{*}{\texttt{rkblkdev}}&\texttt{rksched}\\\cline{1-1}\cline{3-3}
ç¬¬11å‘¨&&\multirow{3}{*}{\texttt{rknetdev}}&&&æ— æŠ¢å \\\cline{1-2}\cline{4-4}\cline{6-6}
ç¬¬12å‘¨&\texttt{rktime}&&\multirow{2}{*}{\texttt{rkmbox}}&&\texttt{rklock}\\\cline{1-2}\cline{5-6}
ç¬¬13å‘¨&\texttt{rkswrand}&&&\multirow{2}{*}{9pfs}&\texttt{rksched}\\\cline{1-4}
ç¬¬14å‘¨&\texttt{rkplat}&\texttt{rkparam}&\texttt{rksignal}&&å¯æŠ¢å \\\cline{1-1}\cline{3-6}
ç¬¬15å‘¨&ä¸ä¾èµ–&\multirow{2}{*}{RustStd}&\multirow{2}{*}{LibC}&\multirow{2}{*}{\texttt{vfscore}}&\multirow{2}{*}{\texttt{pthread}}\\\cline{1-1}
ç¬¬16å‘¨&SBI&&&&\\\hline
\end{tabular}
\end{table}

\section*{è®¸å¯åè®®}
æœ¬æ–‡æ¡£ä»¥çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™… (CC BY 4.0)è®¸å¯è¯å‘å¸ƒã€‚

\vspace{2ex}
\noindent\textbf{\large æ‚¨å¯ä»¥è‡ªç”±åœ°}ï¼š
\begin{description}
\item[å…±äº«] åœ¨ä»»ä½•åª’ä»‹ä»¥ä»»ä½•å½¢å¼å¤åˆ¶ã€å‘è¡Œæœ¬ä½œå“ï¼›
\item[æ¼”ç»] ä¿®æ”¹ã€è½¬æ¢æˆ–ä»¥æœ¬ä½œå“ä¸ºåŸºç¡€è¿›è¡Œåˆ›ä½œ
åœ¨ä»»ä½•ç”¨é€”ä¸‹ï¼Œç”šè‡³å•†ä¸šç›®çš„ã€‚
\end{description}

\vspace{2ex}
\noindent\textbf{\large æƒŸé¡»éµå®ˆä¸‹åˆ—æ¡ä»¶}ï¼š
\begin{description}
\item[ç½²å] æ‚¨å¿…é¡»ç»™å‡ºé€‚å½“çš„ç½²åï¼Œæä¾›æŒ‡å‘æœ¬è®¸å¯åè®®çš„é“¾æ¥ï¼Œ
åŒæ—¶æ ‡æ˜æ˜¯å¦ï¼ˆå¯¹åŸå§‹ä½œå“ï¼‰ä½œäº†ä¿®æ”¹ã€‚æ‚¨å¯ä»¥ç”¨ä»»ä½•åˆç†çš„æ–¹å¼æ¥ç½²åï¼Œ
ä½†æ˜¯ä¸å¾—ä»¥ä»»ä½•æ–¹å¼æš—ç¤ºè®¸å¯äººä¸ºæ‚¨æˆ–æ‚¨çš„ä½¿ç”¨èƒŒä¹¦ã€‚
\item[æ²¡æœ‰é™„åŠ é™åˆ¶] æ‚¨ä¸å¾—ä½¿ç”¨æ³•å¾‹æœ¯è¯­æˆ–è€…æŠ€æœ¯æªæ–½ï¼Œä»è€Œé™åˆ¶å…¶ä»–äºº
åšè®¸å¯åè®®å…è®¸çš„äº‹æƒ…ã€‚
\end{description}

\vspace{2ex}
\noindent\textbf{\large å£°æ˜}ï¼š

æ‚¨ä¸å¿…å› ä¸ºå…¬å…±é¢†åŸŸçš„ä½œå“è¦ç´ è€Œéµå®ˆè®¸å¯åè®®ï¼Œæˆ–è€…æ‚¨çš„ä½¿ç”¨è¢«å¯é€‚ç”¨çš„ä¾‹å¤–æˆ–é™åˆ¶æ‰€å…è®¸ã€‚

ä¸æä¾›æ‹…ä¿ã€‚è®¸å¯åè®®å¯èƒ½ä¸ä¼šç»™ä¸æ‚¨æ„å›¾ä½¿ç”¨çš„æ‰€å¿…é¡»çš„æ‰€æœ‰è®¸å¯ã€‚
ä¾‹å¦‚ï¼Œå…¶ä»–æƒåˆ©æ¯”å¦‚å½¢è±¡æƒã€éšç§æƒæˆ–äººæ ¼æƒå¯èƒ½é™åˆ¶æ‚¨å¦‚ä½•ä½¿ç”¨ä½œå“ã€‚

æœ¬è®¸å¯è¯çš„å…¨æ–‡ä½äºï¼š\\
\centerline{\url{https://creativecommons.org/licenses/by/4.0/legalcode.zh-Hans}}
\bibliographystyle{IEEEtran}
\bibliography{feasibility-report}
\end{document}
