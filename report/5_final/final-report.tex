% SPDX-License-Identifier: CC-BY-4.0
% research-report.tex: ç»“é¢˜æŠ¥å‘Š

% Authors: å´éªä¸œ <1904346407@qq.com>,
%          å¼ å­è¾° <zichen350@gmail.com>,
%          è“ä¿Šç® <ljw13@mail.ustc.edu.cn>,
%          éƒ­è€¸éœ„ <logname@mail.ustc.edu.cn> and
%          é™ˆå»ºç»¿ <2512674094@qq.com>

% Copyright (C) 2022 å´éªä¸œ, å¼ å­è¾°, è“ä¿Šç®, éƒ­è€¸éœ„ and é™ˆå»ºç»¿
% All rights reserved.

% ğŸ…­ ğŸ…¯
% This document is licensed under a Creative Commons Attribution
% 4.0 International license <https://creativecommons.org/licenses/by/4.0/>.
\documentclass{../runikraft-report}

\hypersetup
{
  pdftitle={2022æ˜¥ æ“ä½œç³»ç»ŸåŸç†ä¸è®¾è®¡(H) x-runikraftå°ç»„ ç»“é¢˜æŠ¥å‘Š},
  pdfauthor={å´éªä¸œ; å¼ å­è¾°; è“ä¿Šç®; éƒ­è€¸éœ„; é™ˆå»ºç»¿}
}
\renewcommand{\today}{2022å¹´7æœˆ9æ—¥}

\begin{document}
\title{\bfseries Runikraftå°ç»„\quad ç»“é¢˜æŠ¥å‘Š\thanks{ä½œè€…æŒ‰Unicodeç ä½æ’åºï¼ŒæŒ‰è´¡çŒ®åº¦æ’åºæ˜¯å¼ å­è¾°ã€éƒ­è€¸éœ„ã€é™ˆå»ºç»¿ã€å´éªä¸œã€è“ä¿Šç®ã€‚}}
\author{å´éªä¸œ\and å¼ å­è¾°\and è“ä¿Šç®\and éƒ­è€¸éœ„\and é™ˆå»ºç»¿}
\date{\today}
\maketitle

\tableofcontents

\section{é¡¹ç›®ç®€ä»‹}
Runikraft æ˜¯ç”¨Rustè¯­è¨€ç¼–å†™çš„èƒ½åœ¨RISC-Væ¶æ„ + QEMUå¹³å°ä¸Šè¿è¡Œçš„unikernelã€‚
å®ƒåŸºäºç”¨Cè¯­è¨€å®ç°çš„Unikraftï¼Œåœ¨ç»§æ‰¿Unikraftçš„é«˜æ•ˆæ€§å’Œå¯å®šåˆ¶æ€§çš„åŒæ—¶ï¼Œ
è¿›ä¸€æ­¥ç®€åŒ–äº†æ„å»ºç³»ç»Ÿé•œåƒçš„æµç¨‹ï¼ŒåŠ å…¥äº†RISC-Væ”¯æŒï¼Œå¹¶ä¸”
ç”¨Rustè¯­è¨€æä¾›äº†æ›´å¼ºçš„å†…æ ¸å®‰å…¨ä¿è¯ã€‚
ä¸RustyHermitå’ŒrCoreç­‰ç”¨Rustå®ç°çš„æ“ä½œç³»ç»Ÿä¸åŒï¼Œ
æˆ‘ä»¬å°†å®Œå…¨ä½¿ç”¨Rustçš„ç¨³å®šç‰¹æ€§ç¼–å†™ä»£ç ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨äº’è”ç½‘æŠ€æœ¯å’Œäº‘è®¡ç®—ä¸æ–­å‘å±•çš„ä»Šå¤©ï¼Œæˆ‘ä»¬èº«è¾¹çš„è™šæ‹ŸåŒ–è®¾å¤‡ä¸æ–­å¢å¤šï¼Œ
å®ƒä»¬ä¸­çš„å¾ˆå¤šéƒ½ä½¿ç”¨äº†Unikernelã€‚ç„¶è€Œï¼Œè™šæ‹ŸåŒ–è®¾å¤‡å’ŒUnikernelä¹Ÿæš´éœ²å‡ºäº†å¾ˆå¤šå®‰å…¨é—®é¢˜ã€‚
å¯¹è¿™äº›å®‰å…¨é—®é¢˜ï¼ŒCè¯­è¨€å› å…¶æœ¬èº«çš„ç¼ºé™·éš¾è¾å…¶å’ã€‚

Rust æ˜¯ä¸€é—¨è®©äººäººéƒ½èƒ½å†™å‡ºå¯é ã€é«˜æ•ˆçš„è½¯ä»¶çš„è¯­è¨€ã€‚\cite{bib:feasibility-7}åˆ©ç”¨Rustç¼–å†™Unikernelï¼Œ
å¯ä»¥å……åˆ†å‘æŒ¥å®ƒç›¸å¯¹Cè¯­è¨€çš„é«˜å±‚æŠ½è±¡å’Œå†…å­˜å®‰å…¨ä¿è¯ã€‚ç”¨Rustæ”¹å†™é¡¹ç›®å·²ç»æˆä¸ºä¸€ç§è§£å†³é—®é¢˜çš„
æœ‰æ•ˆæ‰‹æ®µï¼Œå¦‚zalandoå…¬å¸ä»Scalaè½¬å‘Rustçš„æˆåŠŸæ•…äº‹ã€‚\cite{bib:feasibility-3}

RISC-Væ˜¯ä¸€æ¬¾è‡ªç”±ã€å¼€æºçš„ISAï¼Œå®ƒå¼€å¯äº†å…¨æ–°çš„åŸºäºå¼€æ”¾æ ‡å‡†åä½œçš„å¤„ç†å™¨åˆ›æ–°æ—¶ä»£ã€‚\cite{bib:feasibility-0}
ç›®å‰åŸºäºRISC-Væ¶æ„çš„å¼€æºå¤„ç†å™¨æœ‰å¾ˆå¤šï¼Œæ—¢æœ‰æ ‡é‡å¤„ç†å™¨Rocketï¼Œ
ä¹Ÿæœ‰è¶…æ ‡é‡å¤„ç†å™¨BOOMï¼Œè¿˜æœ‰é¢å‘åµŒå…¥å¼é¢†åŸŸçš„Z-scaleã€PicoRV32ç­‰ã€‚\cite{bib:feasibility-2}

å› æ­¤ï¼Œæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨Rustè¯­è¨€æ”¹å†™æ¶æ„å’Œæ€§èƒ½æ–¹é¢å ä¼˜çš„unikernelâ€”â€”Unikraftã€‚

\section{é¡¹ç›®èƒŒæ™¯}
\subsection{æ“ä½œç³»ç»Ÿçš„æ¶æ„}
æœ€åˆçš„æ“ä½œç³»ç»Ÿç¼ºä¹æ˜ç¡®å®šä¹‰çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ç®€å•ç»“æ„ã€‚è¿™ç±»ç³»ç»Ÿçš„è®¾è®¡è€…å¸Œæœ›ç”¨
æœ€å°çš„ç©ºé—´æä¾›å°½å¯èƒ½å¤šçš„åŠŸèƒ½ï¼Œå› æ­¤ï¼Œç³»ç»Ÿæ²¡æœ‰è¢«ä»”ç»†åˆ’åˆ†æˆæ¨¡å—ï¼Œæ•´ä¸ªç³»ç»Ÿæ˜¯
ä¸€ä¸ªé«˜åº¦è€¦åˆçš„æ•´ä½“ï¼Œç”¨æˆ·ç¨‹åºçš„é”™è¯¯å¯èƒ½å¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å´©æºƒã€‚\cite{bib:os-concept}

éšç€æ“ä½œç³»ç»Ÿçš„
å‘å±•ï¼Œåˆ†å±‚ç³»ç»Ÿå‡ºç°äº†ï¼Œè¿™ç§ç³»ç»Ÿè¢«åˆ†å‰²æˆè‹¥å¹²å±‚ï¼Œæœ€ä½å±‚ä¸ºç¡¬ä»¶å±‚ï¼Œæœ€é«˜å±‚ä¸ºç”¨æˆ·
å±‚ï¼Œæ¯ä¸€å±‚éƒ½åœ¨è¾ƒä½å±‚çš„åŸºç¡€ä¸Šå®ç°ï¼Œå¹¶ä¸ºè¾ƒé«˜å±‚æä¾›ä¸€ç»„èƒ½è°ƒç”¨çš„ç¨‹åºé›†ã€‚åˆ†å±‚ç³»ç»Ÿ
ç®€åŒ–äº†æ„å»ºå’Œè°ƒè¯•ç³»ç»Ÿçš„éš¾åº¦ï¼Œå¹¶ä¸”æœ‰åŠ©äºå±€éƒ¨ä¼˜åŒ–ç³»ç»Ÿã€‚
ç„¶è€Œåˆç†åœ°å®šä¹‰å„å±‚å¹¶ä¸å®¹æ˜“ï¼Œæœ‰æ—¶ä½å±‚ç»„ä»¶å¯èƒ½éœ€è¦
é«˜å±‚ç»„ä»¶æä¾›çš„æœåŠ¡ï¼›è€Œä¸”åˆ†å±‚ä¼šå¯¼è‡´ç”¨æˆ·å±‚æ‰§è¡Œçš„æ“ä½œéœ€è¦å¤šæ¬¡è½¬å‘æ‰èƒ½æ˜ å°„åˆ°ç¡¬ä»¶
æ“ä½œï¼Œæ•ˆç‡ç¨å·®ã€‚

éšç€åˆ†å±‚ç³»ç»Ÿçš„ä¸æ–­å‘å±•ï¼Œç³»ç»Ÿçš„å†…æ ¸æ—¥ç›Šå¢å¤§ï¼Œè¿™å¯¼è‡´ç³»ç»Ÿçš„å†…æ ¸æ„ˆå‘éš¾ä»¥ç®¡ç†å’Œç»´æŠ¤ã€‚
å¾®å†…æ ¸å°±æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹è¯ç”Ÿçš„ï¼Œåœ¨è¿™ç§ç³»ç»Ÿä¸­ï¼Œåªæœ‰CPUè°ƒåº¦ã€å†…å­˜ç®¡ç†ã€è¿›ç¨‹é€šä¿¡ç­‰
é«˜åº¦ä¾èµ–ç‰¹æƒçš„æ¨¡å—è¢«æ”¾åœ¨å†…æ ¸ä¸­ï¼Œè€Œè®¾å¤‡é©±åŠ¨ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç­‰ç³»ç»ŸæœåŠ¡ä¸€æ¦‚æ˜¯è¿è¡Œ
åœ¨ç”¨æˆ·æ€ä¸‹çš„ç‹¬ç«‹æœåŠ¡è¿›ç¨‹ï¼Œè¿™äº›æœåŠ¡è¿›ç¨‹ä¾é æ¶ˆæ¯ä¼ é€’æœºåˆ¶ç›¸äº’ä½¿ç”¨ã€‚å¾®å†…æ ¸è¯ç”Ÿåï¼ŒåŸæœ¬
çš„åˆ†å±‚ç³»ç»Ÿçš„å†…æ ¸è¢«ç§°ä¸ºå®å†…æ ¸ã€‚å…¸å‹çš„å¾®å†…æ ¸çš„
ä»£ç é‡åœ¨ä¸€ä¸‡è¡Œä»¥ä¸‹ï¼Œè¿™æœ‰åŠ©äºç”¨å½¢å¼åŒ–æ–¹æ³•ä¸¥æ ¼éªŒè¯å†…æ ¸çš„æ­£ç¡®æ€§ï¼Œç¡®ä¿å†…æ ¸æ²¡æœ‰å®‰å…¨æ¼æ´
å’ŒåŠŸèƒ½ç¼ºé™·ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„æœåŠ¡è¿›ç¨‹ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œè¿›ç¨‹çš„æƒé™æ°èƒ½æä¾›
ç›¸åº”çš„æœåŠ¡ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šæ³¢åŠæ•´ä¸ªç³»ç»Ÿã€‚æ‰€ä»¥ï¼Œå¾®å†…æ ¸ç³»ç»Ÿç›¸æ¯”å®å†…æ ¸æ›´å®‰å…¨ã€
æ›´å¥å£®ã€‚è™½ç„¶ä¸å®å†…æ ¸ç›¸æ¯”ï¼Œæ¶ˆæ¯ä¼ é€’ä¼šé™ä½ç³»ç»Ÿæ¨¡å—ä¹‹é—´çš„é€šä¿¡æ•ˆç‡ï¼Œä½†è¿™å¯ä»¥é€šè¿‡å…±äº«å†…å­˜ç¼“è§£ã€‚

å—å¾®å†…æ ¸ç³»ç»Ÿçš„å¯å‘ï¼Œå®å†…æ ¸ç³»ç»Ÿå¼•å…¥äº†å¯åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå³ä¸€é¡¹æœåŠ¡å¯ä»¥åœ¨ç³»ç»Ÿå¯åŠ¨åéšæ—¶é“¾å…¥å†…æ ¸ï¼Œ
æˆ–ä»å†…æ ¸ä¸­å¸è½½ã€‚
è¿™æ ·ï¼Œå†…æ ¸çš„æ ¸å¿ƒç»„ä»¶åªéœ€è¦åŒ…å«CPUè°ƒåº¦ã€å†…å­˜ç®¡ç†ã€è¿›ç¨‹é€šä¿¡ç­‰åŸºæœ¬çš„åŠŸèƒ½ï¼Œè€Œå…¶ä»–å†…æ ¸åŠŸèƒ½å¯ä»¥
æ ¹æ®éœ€è¦å¯åŠ¨ã€‚ä¸è¿‡ï¼Œä¸å¾®å†…æ ¸ä¸åŒï¼Œè¿™äº›å¯åŠ è½½å†…æ ¸æ¨¡å—è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œå®ƒä»¬ä¸­çš„å®‰å…¨æ¼æ´å¯ä»¥
å¨èƒæ•´ä¸ªå†…æ ¸ã€‚\cite{bib:os-concept}

ä¼ ç»Ÿä¸Šï¼Œæ“ä½œç³»ç»Ÿåº”è¯¥ä¸ºç”¨æˆ·ç¨‹åºæä¾›å°½å¯èƒ½å…¨é¢çš„æœåŠ¡ï¼Œå¹¶ä¸”è¦è´Ÿè´£åœ¨ç”¨æˆ·ç¨‹åºå’Œç³»ç»Ÿé—´ã€
ç”¨æˆ·ç¨‹åºä¹‹é—´å»ºç«‹å±éšœï¼Œä»¥é˜²æ­¢ç”¨æˆ·ç¨‹åºçš„é”™è¯¯å½±å“æ•´ä¸ªç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œéšç€è®¡ç®—æœºçš„æ™®åŠï¼Œ
ä¸“ä¸ºä¸€ä¸ªç”¨é€”å»ºé€ çš„è®¡ç®—æœºæ„ˆæ¥æ„ˆå¤šï¼Œè¿™äº›è®¡ç®—æœºä¸Šåªä¼šè¿è¡Œä¸€ä¸ªç”¨æˆ·ç¨‹åºï¼Œè€Œè¿™ä¸ªç”¨æˆ·ç¨‹åº
çš„å´©æºƒä¹Ÿæ„å‘³ç€ç³»ç»Ÿçš„å´©æºƒï¼Œæ‰€ä»¥ä¼ ç»Ÿæ“ä½œç³»ç»Ÿä¸­çš„éš”ç¦»åœ¨è¿™ç§é«˜åº¦ä¸“ç”¨çš„è®¡ç®—æœºä¸­æ¯«æ— æ„ä¹‰ï¼Œ
è€Œæ¶ˆé™¤éš”ç¦»èƒ½å‡å°ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œè¿›è€Œæé«˜æ•ˆç‡ã€‚å½“ä»Šï¼Œéœ€è¦å¤§é‡ä½¿ç”¨ä¸“ç”¨ç³»ç»Ÿçš„é¢†åŸŸ
åŒ…æ‹¬ç‰©è”ç½‘ã€å·¥ä¸šæ§åˆ¶å’Œäº‘è®¡ç®—ã€‚å‰ä¸¤è€…ä¸»è¦éœ€è¦å®æ—¶ç³»ç»Ÿï¼Œè€Œåä¸€è€…ä¸è™šæ‹ŸåŒ–å¯†åˆ‡ç›¸å…³ã€‚

\subsection{è™šæ‹ŸåŒ–}
åœ¨1960sï¼Œå¤§å‹æœºçš„è¿ç®—é€Ÿåº¦å·²ç»è¿œè¶…è¿‡äº†äººç±»çš„æ“ä½œé€Ÿåº¦ã€‚ä¸ºäº†
å……åˆ†åˆ©ç”¨å¤§å‹æœºçš„ç®—åŠ›ï¼Œä¸€å°å¤§å‹æœºé…ç½®äº†å¤šä¸ªç»ˆç«¯ï¼Œå¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶é€šè¿‡ç»ˆç«¯ä¸å¤§å‹æœºäº¤äº’ï¼Œ
å¤šä¸ªç”¨æˆ·çš„ç¨‹åºè½®è½¬ä½¿ç”¨CPUæ—¶é—´ã€‚ç”±äºè½®è½¬é€Ÿåº¦å¾ˆå¿«ï¼Œç”¨æˆ·æ— æ³•æ„Ÿå—åˆ°è‡ªå·±çš„ç¨‹åºæ²¡æœ‰è¿ç»­è¿è¡Œï¼Œ
æ‰€ä»¥åœ¨æ¯ä¸ªç”¨æˆ·çœ‹æ¥ï¼Œä»–ä¼¼ä¹æ‹¥æœ‰ä¸€å°ç‹¬ç«‹çš„è®¡ç®—æœºã€‚è¿™ç§è¿è¡Œåœ¨å¤§å‹æœºä¸Šçš„åˆ†æ—¶ç³»ç»Ÿæ˜¯æœ€åˆçš„è™šæ‹ŸåŒ–ã€‚
ç„¶è€Œï¼Œéšç€ä¸ªäººè®¡ç®—æœºçš„å‘å±•ï¼Œè¿™ç§åŸºäºåˆ†æ—¶ç³»ç»Ÿçš„è™šæ‹ŸåŒ–é€æ¸æ²¡è½ã€‚è™šæ‹ŸåŒ–çš„å†æ¬¡å…´èµ·
å¾—ç›Šäºäº’è”ç½‘æŠ€æœ¯çš„å‘å±•å’Œäº‘è®¡ç®—çš„å…´èµ·ï¼Œåœ¨äº‘è®¡ç®—ä¸­ï¼Œç”¨æˆ·é€šè¿‡ç½‘ç»œæ“ä½œè¿œç¨‹çš„è™šæ‹Ÿæœºï¼Œ
è¿™äº›è¿œç¨‹è™šæ‹Ÿæœºå¯ä»¥å‘å¤–ç•Œæä¾›ç½‘ç»œæœåŠ¡ã€‚

\subsubsection{è™šæ‹Ÿæœº}\sectionauthor{å¼ å­è¾°}
å¹¿ä¹‰ä¸Šçš„è™šæ‹Ÿæœºæ˜¯æ¨¡æ‹Ÿç¡¬ä»¶æˆ–è§£é‡Šé«˜çº§è¯­è¨€çš„ç¨‹åºï¼Œæ¯”å¦‚Appleåœ¨ä¸¤æ¬¡macOSæ¶æ„è¿ç§»æ—¶
åˆ†åˆ«æ¨å‡ºçš„Rosettaå’ŒRosetta 2å°±æ˜¯ç¡¬ä»¶æ¨¡æ‹Ÿå™¨ï¼ŒCPythonå°±æ˜¯é«˜çº§è¯­è¨€è§£é‡Šå™¨ï¼Œ
è€ŒOpenJDK JREå¯ä»¥è§†ä¸ºç¡¬ä»¶æ¨¡æ‹Ÿå™¨ï¼Œåªä¸è¿‡å®ƒæ¨¡æ‹Ÿçš„æ˜¯ä¸å­˜åœ¨çš„ç¡¬ä»¶ã€‚è¿™ä¸‰ä¸ªç¤ºä¾‹
éƒ½ä¾§é‡ååŠ©è¿è¡Œç¨‹åºï¼Œè€Œå‡ ä¹æ²¡æœ‰éš”ç¦»æªæ–½ã€‚ç‹­ä¹‰çš„è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿ
çš„ç¨‹åºï¼Œåœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ç³»ç»Ÿçœ‹æ¥ï¼Œè™šæ‹Ÿæœºå’Œç‰©ç†æœºæ²¡æœ‰æ˜æ˜¾åŒºåˆ«ï¼Œè€Œä¸”ï¼Œè™šæ‹Ÿæœºä¸Š
è¿è¡Œçš„ç³»ç»Ÿä¸èƒ½éšæ„è®¿é—®å®¿ä¸»æœºçš„èµ„æºï¼ŒVirtual Boxã€VMWareå°±æ˜¯è¿™ç±»è™šæ‹Ÿæœºã€‚
ç”±äºäº‘è®¡ç®—å¹³å°ä¸Šè¿è¡Œçš„ç”¨æˆ·ç¨‹åºå¯¹è®¡ç®—èµ„æºçš„æä¾›å•†å¹¶ä¸å¯ä¿¡ï¼Œæ‰€ä»¥ï¼Œæä¾›å•†å¸Œæœ›å°†ç”¨æˆ·
ç¨‹åºä¸ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†éš”ç¦»ã€‚è¿™éœ€è¦ç‹­ä¹‰çš„è™šæ‹Ÿæœºã€‚

æœ€åˆçš„äº‘è®¡ç®—æœåŠ¡å°±æ˜¯å‘ç”¨æˆ·æä¾›ä¸€å°å®Œæ•´çš„è¿œç¨‹è™šæ‹Ÿæœºã€‚é€šå¸¸çš„è¿œç¨‹è™šæ‹Ÿæœºå¸®åŠ©ç”¨æˆ·æä¾›
ç½‘ç»œæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä½œä¸ºæœåŠ¡å™¨ã€‚æœåŠ¡å™¨å…¶å®ä¸éœ€è¦æ¯æ—¶æ¯åˆ»éƒ½ä¿æŒè¿è¡Œï¼Œè€Œåªéœ€è¦åœ¨æœ‰äººè¯·æ±‚è¿™é¡¹ç½‘ç»œ
æœåŠ¡æ—¶è¿è¡Œï¼Œä½†æ˜¯ä¸ºäº†ç¡®ä¿ç½‘ç»œæœåŠ¡çš„å¯ç”¨æ€§ï¼ŒæœåŠ¡å™¨å¿…é¡»ä¿æŒå¼€æœºï¼Œç”¨æˆ·å¿…é¡»
æŒç»­ä¸ºè¿™å°ä½œä¸ºæœåŠ¡å™¨çš„è¿œç¨‹è™šæ‹Ÿæœºä»˜è´¹ã€‚ä¸ºäº†æ›´ç»†ç²’åº¦åœ°åˆ†é…è®¡ç®—èµ„æºï¼Œäº‘è®¡ç®—æœåŠ¡çš„æä¾›å•†
æ¨å‡ºäº†serverlessæœåŠ¡ã€‚åœ¨serverlessä¸­ï¼ŒåŸæœ¬çš„æœåŠ¡å™¨è¢«æ‹†åˆ†æˆè‹¥å¹²â€œå‡½æ•°â€ï¼Œå…¶å®ä¹Ÿå°±æ˜¯
ä¸€ä¸ªå“åº”ç½‘ç»œè¯·æ±‚çš„ç¨‹åºã€‚å½“ç½‘ç»œæœåŠ¡è¢«è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªç¨‹åºè¢«å¯åŠ¨ï¼Œå“åº”è¿™ä¸ªè¯·æ±‚ï¼Œç„¶åé€€å‡ºã€‚
è¿™éœ€è¦ä¸€å°è™šæ‹Ÿæœºèƒ½å¤Ÿå¿«é€Ÿå¯åŠ¨ï¼Œå¯æ˜¯ä¼ ç»Ÿçš„è™šæ‹Ÿæœºæ— æ³•æ»¡è¶³è¦æ±‚ã€‚

\subsubsection{å®¹å™¨}\sectionauthor{è“ä¿Šç®}
ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä¸ä½¿ç”¨è™šæ‹Ÿæœºï¼Œè€Œä½¿ç”¨æ›´åŠ è½»é‡çš„æ–¹å¼å®ç°éš”ç¦»ï¼Œæ¯”å¦‚å®¹å™¨ã€‚
ä»¥Dockerä¸ºä»£è¡¨çš„ä¼ ç»Ÿå®¹å™¨æ˜¯ä¸ºäº†ä¾¿æ·åœ°æ‰“åŒ…ç¨‹åºåŠå…¶ä¾èµ–è¯ç”Ÿçš„ï¼Œè€Œå¹¶ä¸å¼ºè°ƒéš”ç¦»æ€§ã€‚
ä¼ ç»Ÿå®¹å™¨ä½¿ç”¨ Namespace/Cgroup å®ç°ï¼Œè¿™å¥—å®¹å™¨æŠ€æœ¯å®é™…ä¸Šæ˜¯ä»è¿›ç¨‹è°ƒåº¦çš„è§’åº¦å…¥æ‰‹ï¼Œ
å¯¹å†…æ ¸è¿›è¡Œçš„åŠŸèƒ½æ‰©å±•ã€‚ä¼˜åŠ¿ä¸Šæ¥è¯´ï¼Œæ“ä½œç•Œé¢å¾ˆ Linuxã€å¾ˆæ–¹ä¾¿ï¼Œå¼€é”€ä¹Ÿå¾ˆä½ï¼Œ
å¯ä»¥è¢«ç”¨æ¥æ— è´Ÿæ‹…åœ°å¥—åœ¨å·²æœ‰åº”ç”¨å¤–é¢ï¼Œæ¥æ„å»ºéš”ç¦»çš„ç¯å¢ƒã€‚å¹¶ä¸”å®ƒæ˜¯çº¯è½¯ä»¶æ–¹æ¡ˆï¼Œ
ä¸å’Œå…¶ä»–å±‚é¢çš„ç‰©ç†æœºã€è™šæ‹Ÿæœºç›¸å†²çªã€‚ç„¶è€Œï¼Œ
éšç€å®¹å™¨æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œä¼ ç»Ÿå®¹å™¨éš”ç¦»æ€§ä¸è¶³çš„ç¼ºé™·é€æ¸æš´éœ²äº†å‡ºæ¥ã€‚
Namespace/Cgroup æ˜¯å†…æ ¸çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­è¿è¡Œçš„å®¹å™¨ä»ç„¶ä½¿ç”¨ä¸»æœºçš„ Linux å†…æ ¸ï¼Œ
å®ƒè§£å†³ä¸äº†Linuxå†…æ ¸ä¸­éš”ç¦»æ€§å·®çš„é—®é¢˜ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨Linuxå†…æ ¸çš„æ¼æ´
å®ç°å®¹å™¨é€ƒé€¸ï¼Œç„¶åä¾¿å¯ä»¥ç›´æ¥å¯¹å®¿ä¸»æœºè¿›è¡Œæ”»å‡»ã€‚\cite{bib:docker-security-selinux}

åŸºäºæ“ä½œç³»ç»Ÿæœ¬èº«çš„å®¹å™¨æœºåˆ¶æ²¡åŠæ³•è§£å†³å®‰å…¨æ€§é—®é¢˜ï¼Œéœ€è¦ä¸€ä¸ªéš”ç¦»å±‚ã€‚
è€Œè™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç°æˆçš„éš”ç¦»å±‚ï¼ŒAWSè¿™æ ·çš„äº‘æœåŠ¡å·²ç»è®©å…¨ä¸–ç•Œç›¸ä¿¡ï¼Œ
å¯¹ç”¨æˆ·æ¥è¯´ï¼Œâ€œsecure of VMâ€ æ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ã€‚
è™šæ‹Ÿæœºé‡Œé¢åªè¦æœ‰ä¸ªå†…æ ¸ï¼Œå°±å¯ä»¥æ”¯æŒ OCI è§„èŒƒçš„è¯­ä¹‰ï¼Œ
åœ¨å†…æ ¸ä¸Šè·‘ä¸ª Linux åº”ç”¨å¹¶ä¸å¤ªéš¾å®ç°ã€‚æ‰€ä»¥ï¼Œå®‰å…¨å®¹å™¨çš„éš”ç¦»å±‚è®©åº”ç”¨çš„
é—®é¢˜â€”â€”ä¸è®ºæ˜¯æ¶æ„æ”»å‡»ï¼Œè¿˜æ˜¯æ„å¤–é”™è¯¯â€”â€”éƒ½ä¸è‡³äºå½±å“å®¿ä¸»æœºï¼Œ
ä¹Ÿä¸ä¼šåœ¨ä¸åŒçš„ Pod ä¹‹é—´ç›¸äº’å½±å“ã€‚è€Œä¸”å®é™…ä¸Šï¼Œé¢å¤–éš”ç¦»å±‚å¸¦æ¥çš„å½±å“å¹¶ä¸ä»…æ˜¯å®‰å…¨ï¼Œ
å¯¹äºè°ƒåº¦ã€æœåŠ¡è´¨é‡å’Œåº”ç”¨ä¿¡æ¯çš„ä¿æŠ¤éƒ½æœ‰å¥½å¤„ã€‚ç›®å‰çš„å®‰å…¨å®¹å™¨æœ‰ä¸¤ä¸ªä¸»æµå®ç°ï¼š
\begin{itemize}
\item \href{https://github.com/kata-containers/kata-containers}{Kata Container} æ˜¯MicroVMçš„ä¸€ä¸ªç»å…¸çš„å®ç°ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªMicroVMï¼Œ
å¹¶ä¸”æœ‰ä¸“é—¨æä¾›ç»™ Kubernetes çš„æ¥å£ï¼Œæœ‰æ¯”è¾ƒå¥½çš„å®‰å…¨æ€§å’Œè¿è¡Œæ•ˆç‡ï¼Œ
ç°åœ¨å·²ç»å¼€å§‹é€æ­¥ä½¿ç”¨ã€‚ä½†æ˜¯å…¶å¯åŠ¨æ—¶é—´å’Œå†…å­˜å ç”¨ä¸ä¼ ç»Ÿå®¹å™¨è¿˜æœ‰ä¸€å®šçš„å·®è·ã€‚
\item  \href{https://github.com/google/gvisor}{gVisor} æ˜¯
åŸºäºè¿›ç¨‹è™šæ‹ŸåŒ–çš„å®¹å™¨å®ç°ï¼Œå®ƒæ‹¥æœ‰å¾ˆå¥½çš„éš”ç¦»æ€§ï¼Œ
å¾ˆå°çš„å†…å­˜å ç”¨å’Œå¯åŠ¨æ—¶é—´ï¼Œä½†æ˜¯ç³»ç»Ÿè°ƒç”¨æ•ˆç‡ä¸é«˜ã€‚
\end{itemize}

å®¹å™¨è™½ç„¶è§£å†³äº†ä¼ ç»Ÿè™šæ‹Ÿæœºå¯åŠ¨æ—¶é—´é•¿çš„é—®é¢˜ï¼Œä½†æ˜¯æ— æ³•å…¼é¡¾æ•ˆç‡å’Œéš”ç¦»æ€§ã€‚

\subsubsection{Unikernel}\sectionauthor{å¼ å­è¾° and é™ˆå»ºç»¿}
Unikernelåœ¨MicroVMçš„åŸºç¡€ä¸Šæ›´è¿›ä¸€æ­¥ï¼Œå®ƒæ”¾å¼ƒäº†è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„ç³»ç»Ÿå†…çš„éš”ç¦»ï¼Œè®©ç”¨æˆ·ç¨‹åº
å’Œç³»ç»Ÿç¨‹åºè¿è¡Œåœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ä¸‹ï¼Œç”¨æˆ·é€šè¿‡å‡½æ•°è°ƒç”¨ï¼ˆå¦‚\texttt{call}æŒ‡ä»¤ï¼‰
è€Œä¸æ˜¯è½¯ä¸­æ–­æˆ–é™·å…¥ï¼ˆå¦‚\texttt{int}ã€\texttt{syscall}ã€\texttt{ecall}ç­‰æŒ‡ä»¤ï¼‰ä½¿ç”¨
ç³»ç»Ÿæä¾›çš„æœåŠ¡ï¼Œè¿™å…å»äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œå¤§å¹…æé«˜äº†ç³»ç»Ÿè°ƒç”¨çš„æ•ˆç‡ã€‚
é«˜æ•ˆçš„ç³»ç»Ÿè°ƒç”¨ç”šè‡³ä½¿unikernelçš„å“åº”æ—¶é—´å’Œååç‡ä¼˜äºå®¹å™¨ã€‚
ç”±äºunikernelæœ¬è´¨ä¸Šæ˜¯è¿è¡Œåœ¨è™šæ‹Ÿä¸Š
çš„ç‹¬ç«‹æ“ä½œç³»ç»Ÿï¼Œå®ƒæ‹¥æœ‰è‰¯å¥½çš„éš”ç¦»æ€§ã€‚Unikernelçš„ç³»ç»Ÿé•œåƒä¸­åªåŒ…å«äº†ç”¨æˆ·ç¨‹åº
éœ€è¦çš„ä»£ç ï¼Œè¿™ä½¿unikernelçš„é•œåƒéå¸¸è½»é‡ï¼Œç”šè‡³æ¯”Dockeré•œåƒè¿˜å°ã€‚

ç„¶è€Œï¼Œä¸ºäº†è¿½æ±‚è½»é‡æ€§ï¼Œ
unikernelsè£å‰ªäº†ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿçš„ä¼—å¤šç»„ä»¶ï¼Œå› æ­¤unikernelsæ— æ³•æä¾›è®¸å¤š
å¸¸ç”¨çš„åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæ‰€ä»¥ä¸ºäº†å°†ç°æœ‰çš„ç¨‹åºç§»æ¤åˆ°æŸä¸ªunikernelå¹³å°ï¼Œå¼€å‘è€…
ä¸å¾—ä¸æ ¹æ®è¯¥unikernelçš„APIé‡æ„ç¨‹åºã€‚\cite{bib:unikraft}
æ­¤å¤–ï¼Œä¸ºäº†è½»é‡ã€å¿«é€Ÿï¼Œunikernels
æ²¡æœ‰å¯ç”¨è®¸å¤šåŸºæœ¬çš„å¹¶ä¸”ä¸ä¼šå½±å“æ€§èƒ½çš„å®‰å…¨æªæ–½ï¼Œè¿™å¯¼è‡´unikernelsç›¸æ¯”å®¹å™¨
æ›´å®¹æ˜“å—åˆ°ç”¨æˆ·ç¨‹åºçš„å®‰å…¨æ¼æ´çš„å½±å“ã€‚\cite{bib:unikernel-secuirty}

ç›®å‰çš„Unikernel æŒ‰å®ç°æ–¹å¼å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š
\begin{itemize}
\item å…¨æ–°çš„æ–¹å¼(Clean-slate)ï¼šåœ¨æ„å»ºå•ä¸€ç”¨é€”çš„æ“ä½œç³»ç»Ÿçš„å‡è®¾ä¸‹ï¼Œ
è‡ªç”±åœ°ä½¿ç”¨ç°ä»£å·¥å…·æ¥è¿›è¡Œæ„å»ºï¼Œæ¯”å¦‚æ¨¡å—åŒ–(modularity)ã€
å£°æ˜æ€§ä»£ç (declarative code)ã€é¿å¼€æ ·æ¿æ–‡ä»¶(avoiding boilerplate)ç­‰ã€‚
å¹¶ä¸”ä»å¤´å¼€å§‹æ€è€ƒæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºå±‚çš„å®ç°ï¼Œ
ä½¿ç”¨é«˜çº§è¯­è¨€è¿›è¡Œç³»ç»Ÿåº“çš„ç¼–å†™ï¼Œä»è€Œä½¿å¾—å®ç°æ›´åŠ å¯æŒæ§ï¼Œå¾—åˆ°çš„ç³»ç»Ÿåº“è´¨é‡æ›´é«˜ã€‚
ç”¨ OCmal è¯­è¨€ç¼–å†™çš„ MirageOS å°±æ˜¯ä½¿ç”¨ Clean-slate æ–¹å¼å®ç°çš„ã€‚
\item ä¼ ç»Ÿçš„æ–¹å¼(Legacy)ï¼šåœ¨ä¸è¿›è¡Œä¿®æ”¹æˆ–åªè¿›è¡Œä¸€äº›å°çš„ä¿®æ”¹çš„å‰æä¸‹ï¼Œ
è¿è¡Œç°æœ‰çš„è½¯ä»¶ã€‚è¿™é€šå¸¸é€šè¿‡å°†ç°æœ‰çš„æ“ä½œç³»ç»Ÿä»£ç åº“é‡æ„åˆ°åº“æ“ä½œç³»ç»Ÿä¸­æ¥å®ç°ã€‚
ç”¨ C è¯­è¨€ç¼–å†™çš„ Rumprun æ˜¯ä½¿ç”¨ Legacy æ–¹å¼å®ç°çš„ã€‚
\end{itemize}

\subsection{Unikernelsé¢ä¸´çš„é—®é¢˜}
Unikernelæ˜¯ä¸ºäº†è§£å†³å®¹å™¨çš„éš”ç¦»æ€§å·®å’Œä¼ ç»Ÿçš„è™šæ‹Ÿæœºå¯åŠ¨æ…¢è€Œè¯ç”Ÿçš„ï¼Œæ‰€ä»¥unikernels
å¿…é¡»åšåˆ°å¯åŠ¨å¿«ã€å»¶è¿Ÿä½ã€ååé‡å¤§ã€‚Unikernelsçš„ç›®æ ‡æ˜¯å–ä»£å®¹å™¨ï¼Œæˆä¸ºäº‘è®¡ç®—é¢†åŸŸçš„
æœ€ä½³é€‰æ‹©ï¼Œæ‰€ä»¥å®ƒä»¬å¿…é¡»æä¾›é«˜æ•ˆçš„ç½‘ç»œæ”¯æŒã€‚ä¸ºäº†æ–¹ä¾¿ç°æœ‰çš„ç¨‹åºç§»æ¤åˆ°unikernelsä¸Šï¼Œ
unikernelåº”è¯¥è€ƒè™‘å…¼å®¹æ€§é—®é¢˜ï¼Œå®ƒä»¬åº”è¯¥ä»¥æœ€å°çš„ä»£ä»·æä¾›ç›®å‰å¸¸ç”¨çš„ç³»ç»ŸAPIsï¼Œå¹¶ä¸”
ç§»æ¤ç›®å‰å¸¸ç”¨çš„åº“ã€‚æ­¤å¤–ï¼Œunikernelsé•œåƒçš„æ„å»ºä¸åº”è¯¥è¿‡äºç¹çã€‚

\subsection{çŸ¥åçš„Unikernels}\label{subsec:famous-unikernel-projects}
ä¸‹é¢ç®€è¦ä»‹ç»æˆ‘ä»¬è¯¦ç»†è°ƒç ”äº†çš„ä¸ƒä¸ªè¿‘ä¸¤å¹´ä»ç„¶åœ¨ç»´æŠ¤çš„unikernelsã€‚

\subsubsection{ClickOS}\sectionauthor{è“ä¿Šç®}

ClickOS æ˜¯ä¸€ä¸ªåŸºäº Xen çš„é«˜æ€§èƒ½çš„è™šæ‹ŸåŒ–è½¯ä»¶ä¸­é—´ç›’å¹³å°ã€‚ä¸ºäº†è¾¾åˆ°é«˜æ€§èƒ½ï¼Œ
ClickOS å¯¹ Xen çš„ I/O å­ç³»ç»Ÿå®ç°äº†å¹¿æ³›çš„ç¿»ä¿®ï¼ŒåŒ…æ‹¬å¯¹åç«¯äº¤æ¢æœºã€
è™šæ‹Ÿç½‘ç»œè®¾å¤‡å’Œåç«¯å‰ç«¯é©±åŠ¨ç¨‹åºã€‚è¿™äº›æ›´æ”¹ä½¿ ClickOS èƒ½å¤Ÿæ˜¾è‘—åŠ å¿«ä¸­é—´ç›’è¿è¡Œæ—¶çš„ç½‘ç»œè¿æ¥ã€‚\cite{bib:12-clickos}

ClickOS è™šæ‹Ÿæœºåªæœ‰5MiB ï¼Œå¯åŠ¨ä»…éœ€è¦å¤§çº¦30msï¼Œè€Œä¸”å»¶è¿Ÿåªæœ‰45Âµsã€‚
ClickOS å®ç°äº†å¹¿æ³›çš„ä¸­é—´ç›’ï¼ŒåŒ…æ‹¬é˜²ç«å¢™ã€è¿è¥å•†çº§ NAT å’Œ
è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶è¯æ˜ ClickOS å¯ä»¥æ¯ç§’å¤„ç†æ•°ç™¾ä¸‡ä¸ªæ•°æ®åŒ…ï¼Œè¾¾åˆ°ç”Ÿäº§çº§æ€§èƒ½ã€‚\cite{bib:12-clickos}\cite{bib:13-clickos2}

\begin{figure}[!hbt]
\begin{minipage}{0.49\linewidth}
\includegraphics[width=\linewidth]{assets/clickOS_arch.jpg}
\caption{ClickOS çš„æ¶æ„\cite{bib:13-clickos2}}
\end{minipage}
\begin{minipage}{0.49\linewidth}
\includegraphics[width=\linewidth]{assets/ClickOS_networking.png}
\caption{Basic ClickOS networking in Xen\cite{bib:12-clickos}}
\end{minipage}
\end{figure}

\subsubsection{MirageOS}\sectionauthor{è“ä¿Šç®}

MirageOS æ˜¯ä¸€ä¸ªç”¨ OCaml è¯­è¨€ç¼–å†™çš„ï¼Œ
ç”¨äºåœ¨å„ç§äº‘è®¡ç®—å’Œç§»åŠ¨å¹³å°æ„å»ºå®‰å…¨ã€é«˜æ€§èƒ½çš„ç½‘ç»œåº”ç”¨ç¨‹åºçš„åº“æ“ä½œç³»ç»Ÿã€‚
å®ƒå¯ä»¥å°†å¤§å‹æœåŠ¡å™¨åˆ’åˆ†ä¸ºå¾ˆå¤šæ›´å°çš„è™šæ‹Ÿæœºï¼Œä½¿å¾—æœåŠ¡å™¨å…·æœ‰æ›´å¼ºçš„æ‹“å±•æ€§å’Œå®‰å…¨æ€§ã€‚
å…¶ä»£ç å¯ä»¥åœ¨ Linux ã€Mac OS ç­‰ç³»ç»Ÿä¸­å¼€å‘ï¼Œç„¶åç¼–è¯‘æˆä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ã€ä¸“é—¨çš„å†…æ ¸ï¼Œ
å¯ä»¥åœ¨ Xenã€KVM hypervisors æˆ–è½»é‡çº§ hypervisors ä¸‹è¿è¡Œã€‚MirageOS
å·²ç»å‘å±•æˆä¸ºä¸€ä¸ªç”±è¿‘100ä¸ªå¼€æ”¾æºç åº“ç»„æˆçš„æˆç†Ÿåº“ï¼Œå®ç°äº†ä¸€ç³»åˆ—å¹¿æ³›çš„åŠŸèƒ½ï¼Œ
å¹¶ä¸”æ­£å¼€å§‹ä¸ Citrix XenServer ç­‰å•†ä¸šäº§å“é›†æˆã€‚MirageOS
å°† Xen hypervisorså½“æˆä¸€ä¸ªç¨³å®šçš„ç¡¬ä»¶å¹³å°ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä¸“æ³¨äºå®æ–½é«˜æ€§èƒ½åè®®ï¼Œ
æ²¡å¿…è¦ä¸ºæ”¯æŒä¼ ç»Ÿæ“ä½œç³»ç»Ÿé‡Œé¢çš„æˆåƒä¸Šä¸‡ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºè€Œæ“å¿ƒã€‚\cite{bib:11-unikerel2}

\begin{figure}[!hbt]
\includegraphics[width=\linewidth]{assets/figure1.png}
\caption{MirageOS çš„æ¶æ„}\label{fig:mirage-fig1}
\end{figure}

\begin{figure}[!hbt]
\includegraphics[width=\linewidth]{assets/figure2.png}
\caption{MirageOSçš„é€»è¾‘å·¥ä½œæµ}\label{fig:mirage-fig2}
\end{figure}

MirageOSçš„äº®ç‚¹æ˜¯è¾“å…¥åº”ç”¨ç¨‹åºçš„æ‰€æœ‰æºä»£ç ä¾èµ–é¡¹éƒ½è¢«æ˜¾å¼è·Ÿè¸ªï¼ŒåŒ…æ‹¬å®ç°å†…
æ ¸åŠŸèƒ½æ‰€éœ€çš„æ‰€æœ‰åº“ã€‚MirageOS åŒ…æ‹¬ä¸€ä¸ªæ„å»ºç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨
ä¸€ä¸ª SAT è§£ç®—å™¨ï¼ˆä½¿ç”¨ OPAM åŒ…ç®¡ç†å™¨ï¼Œä½¿ç”¨ Mancoosi é¡¹ç›®çš„è§£ç®—å™¨ï¼‰
ä»ä¸€ä¸ªå·²å‘å¸ƒçš„åœ¨çº¿åŒ…é›†ä¸­æœç´¢å…¼å®¹çš„æ¨¡å—å®ç°ã€‚å¾—ç›Šäº OCaml çš„é™æ€ç±»å‹
æ£€æŸ¥ï¼Œåœ¨ç¼–è¯‘æ—¶å°†æ•è·æ¥å£ä¸­çš„ä»»ä½•ä¸åŒ¹é…ã€‚

åœ¨ MirageOS ä¸­ï¼ŒOCaml ç¼–è¯‘å™¨æ¥æ”¶æ•´ä¸ªå†…æ ¸ä»£ç çš„æºä»£ç ï¼Œ
å¹¶å°†å…¶é“¾æ¥åˆ°ä¸€ä¸ªç‹¬ç«‹çš„æœ¬æœºä»£ç å¯¹è±¡æ–‡ä»¶ã€‚å®ƒé“¾æ¥åˆ°æä¾›å¼•å¯¼æ”¯æŒå’Œ
åƒåœ¾å›æ”¶å™¨çš„æœ€å°è¿è¡Œæ—¶ã€‚æ²¡æœ‰æŠ¢å å¼çº¿ç¨‹ï¼Œå†…æ ¸æ˜¯é€šè¿‡ä¸€ä¸ª I/O å¾ªç¯è½®è¯¢
Xen è®¾å¤‡çš„äº‹ä»¶é©±åŠ¨çš„ã€‚\cite{bib:11-unikerel2}

\subsubsection{IncludeOS}\sectionauthor{è“ä¿Šç®}

IncludeOS æ˜¯ä¸€ä¸ªä¸ºå¼€å‘åŸºäº unikernel çš„åº”ç”¨ç¨‹åºè€Œåˆ›å»º C++ API çš„é¡¹ç›®ã€‚\cite{bib:9-includeos}

å½“ IncludeOS æ˜ åƒå¼•å¯¼æ—¶ï¼Œå®ƒé€šè¿‡è®¾ç½®å†…å­˜ã€è¿è¡Œå…¨å±€æ„é€ å‡½æ•°ã€æ³¨å†Œé©±åŠ¨ç¨‹åºå’Œä¸­æ–­å¤„ç†
ç¨‹åºæ¥åˆå§‹åŒ–æ“ä½œç³»ç»Ÿã€‚IncludeOS ä¸æ”¯æŒè™šæ‹Ÿå†…å­˜ï¼Œåº”ç”¨ç¨‹åºå’Œ
unikernel åº“ä½¿ç”¨å•ä¸ªåœ°å€ç©ºé—´ã€‚å› æ­¤ï¼Œæ²¡æœ‰ç³»ç»Ÿè°ƒç”¨æˆ–ç”¨æˆ·ç©ºé—´çš„æ¦‚å¿µ; æ‰€æœ‰æ“ä½œç³»ç»ŸæœåŠ¡
éƒ½é€šè¿‡å¯¹åº“å‡½æ•°çš„ç®€å•è°ƒç”¨ä½¿ç”¨ï¼Œå¹¶ä¸”éƒ½ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œã€‚\cite{bib:10-includeos2}

\noindent IncludeOS æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š\cite{bib:9-includeos}
\begin{itemize}
\item IncludeOSä¸­ç›®å‰æ²¡æœ‰è¿›ç¨‹æŠ¢å ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿçš„è¡Œä¸ºéå¸¸é™æ€ã€‚
åªè¦æœºå™¨æœ¬èº«æ˜¯å¯é¢„æµ‹çš„ï¼Œå»¶è¿Ÿä¹Ÿå°†æ˜¯å®Œå…¨å¯é¢„æµ‹çš„ã€‚å› æ­¤ï¼Œåœ¨è£¸æœºç¡¬ä»¶ä¸Šï¼Œ
IncludeOSå¯è¢«è§†ä¸ºä½å»¶è¿Ÿï¼Œå¯é¢„æµ‹çš„æ“ä½œç³»ç»Ÿã€‚
\item å¯¹ç½‘ç»œçš„æ”¯æŒå¾ˆå¥½ï¼Œä¸ Linux ç›¸æ¯”è¡¨ç°å‡ºè‰²ã€‚
\item IncludeOS ç³»ç»Ÿä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œç¼–è¯‘å’Œä¼˜åŒ–ã€‚åœ¨ç¼–è¯‘å’Œè¿æ¥é˜¶æ®µï¼Œ
ä¼˜åŒ–å™¨å¯ä»¥æ›´å¤šåœ°äº†è§£æ•´ä¸ªç³»ç»Ÿæ­£åœ¨åšä»€ä¹ˆï¼Œå¹¶ä¸”æœ‰å¯èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚
\item IncludeOS ä¸­çš„æ‰€æœ‰ IRQ å¤„ç†ç¨‹åºç®€å•åœ°ï¼ˆåŸå­åœ°ï¼‰æ›´æ–°è®¡æ•°å™¨ï¼Œ
å¹¶åœ¨æœ‰æ—¶é—´æ—¶å°†è¿›ä¸€æ­¥çš„å¤„ç†æ¨è¿Ÿåˆ°ä¸»äº‹ä»¶å¾ªç¯ã€‚è¿™æ¶ˆé™¤äº†å¯¹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„éœ€è¦ï¼Œ
åŒæ—¶ä¹Ÿæ¶ˆé™¤äº†ä¸å¹¶å‘ç›¸å…³çš„é—®é¢˜ï¼Œå¦‚ç«äº‰æ¡ä»¶ã€‚
IncludeOSçš„æ‰€æœ‰ I/O éƒ½æ˜¯å¼‚æ­¥çš„ï¼ŒCPU ä¿æŒå¿™ç¢Œï¼Œä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚
\end{itemize}

\noindent IncludeOS æœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š\cite{bib:9-includeos}
\begin{itemize}
\item IncludeOS ä¸å®ç°æ‰€æœ‰ POSIXã€‚å¼€å‘äººå‘˜è®¤ä¸ºï¼Œ
åªæœ‰åœ¨éœ€è¦æ—¶æ‰ä¼šå®ç° POSIX çš„æŸäº›éƒ¨åˆ†ã€‚å¼€å‘äººå‘˜ä¸å¤ªå¯èƒ½å°†å®Œå…¨éµå®ˆ POSIX ä½œä¸ºä¸€ä¸ªç›®æ ‡ã€‚
\item ä¸MirageOSä¸€æ ·ï¼ŒIncludeOS ä¸­æ²¡æœ‰å®ç°é˜»å¡è°ƒç”¨ï¼Œå› ä¸ºå½“å‰çš„äº‹ä»¶å¾ªç¯æ¨¡å‹æ˜¯ä½¿ç”¨å®ƒçš„æœ€ä½³æ–¹å¼ã€‚
\item IncludeOS ç›®å‰è¿˜ç¼ºå°‘å¯å†™çš„æ–‡ä»¶ç³»ç»Ÿã€‚
\end{itemize}

\subsubsection{RustyHermit}\sectionauthor{é™ˆå»ºç»¿}

\href{https://github.com/hermitcore/rusty-hermit}{RustyHermit}\ æ˜¯
ä¸€ä¸ªåŸºäº Rust çš„ã€è½»é‡çº§çš„ Unikernelï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç”¨æ¥è¯„ä¼°æ“ä½œç³»ç»Ÿæ–°çš„è®¾è®¡çš„ç ”ç©¶é¡¹ç›®ã€‚
å®ƒç”¨ Rust è¯­è¨€å®Œå…¨æ”¹å†™äº† RWTH Aachen University
å¼€å‘çš„ç ”ç©¶é¡¹ç›® \href{http://hermitcore.org/}{HermitCore}\footnote{HermitCore æœ€åˆæ˜¯ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œ
æ˜¯ä¸€ç§é’ˆå¯¹é«˜æ€§èƒ½å’Œäº‘è®¡ç®—çš„å¯ä¼¸ç¼©å’Œå¯é¢„æµ‹çš„è¿è¡Œæ—¶çš„ Unikernelã€‚}ã€‚\cite{bib:14-rusty-hermit}

è¯¥é¡¹ç›®å®Œå…¨ä½¿ç”¨ Rust è¯­è¨€å¼€å‘ï¼ŒRust çš„æ‰€æœ‰æƒæ¨¡å‹ä¿è¯äº†å®ƒçš„å†…å­˜/çº¿ç¨‹å®‰å…¨ï¼Œ
å¹¶ä¸”è®©å¼€å‘è€…èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶å°±æ¶ˆé™¤è®¸å¤šç§ bugsã€‚å› æ­¤ï¼Œä¸é€šç”¨ç¼–ç¨‹è¯­è¨€ç›¸æ¯”ï¼Œä½¿ç”¨ Rust
è¿›è¡Œå†…æ ¸å¼€å‘ä¼šç•™ä¸‹æ›´å°‘çš„æ¼æ´ï¼Œå¾—åˆ°æ›´åŠ å®‰å…¨çš„å†…æ ¸ã€‚

å¼€å‘è€…æ‰©å±•äº† Rust å·¥å…·é“¾ä»¥è‡³äº RustyHermit çš„ build è¿‡ç¨‹
ä¸ Rust é€šå¸¸çš„å·¥ä½œæµç¨‹ç›¸ä¼¼ã€‚ä½¿ç”¨ Rust runtime è€Œä¸”ä¸ç›´æ¥ä½¿ç”¨ OS æœåŠ¡çš„
Rust åº”ç”¨ç¨‹åºèƒ½å¤Ÿç›´æ¥åœ¨ RustyHermit ä¸Šè¿è¡Œè€Œä¸éœ€è¦ä¿®æ”¹ã€‚å› æ­¤ï¼ŒåŸåˆ™ä¸Šï¼Œ
æ¯ä¸€ä¸ªç°æœ‰çš„ Rust åº”ç”¨ç¨‹åºéƒ½å¯ä»¥å»ºç«‹åœ¨ RustyHermit ä¹‹ä¸Šã€‚\cite{bib:17-rusty-hermit2}


RustyHermit ä¸­ä¼˜åŒ–å®ç°äº†ç½‘ç»œæ ˆã€‚å®ƒä½¿ç”¨ \href{https://github.com/smoltcp-rs/smoltcp}{smoltcp}
ä½œä¸ºå®ƒçš„ç½‘ç»œæ ˆï¼Œä½¿ç”¨ \href{https://www.linux-kvm.org/page/Virtio}{Virtio}
ä½œä¸ºå®¢æˆ·æœºå’Œä¸»æœºæ“ä½œç³»ç»Ÿä¹‹é—´çš„æ¥å£ã€‚

Sung, Olivier, Lankes and Ravindran\cite{bib:18-intra-unikernel}
æå‡ºäº†ä¸€ä¸ªä¿®æ”¹ç‰ˆæœ¬çš„ RustyHermitï¼Œè¯¥ç‰ˆæœ¬åˆ©ç”¨Intel MPK(Memory Protection Keys)\cite{bib:19-mpk}ï¼Œ
åœ¨ä¿æŒå•ä¸€åœ°å€ç©ºé—´çš„åŒæ—¶ï¼Œåœ¨ Unikernel å®ä¾‹ä¸­å¼•å…¥å†…å­˜éš”ç¦»ï¼Œ
åŒ…æ‹¬å®‰å…¨å†…æ ¸ä»£ç ä¸ä¸å®‰å…¨å†…æ ¸ä»£ç ä¹‹é—´çš„éš”ç¦»ã€å†…æ ¸ä»£ç ä¸ç”¨æˆ·ä»£ç ä¹‹é—´çš„éš”ç¦»ã€‚
åœ¨ä¸€ç»„å®åŸºå‡†æµ‹è¯•ä¸­ï¼Œå¸¦æœ‰éš”ç¦»åŠŸèƒ½çš„ unikernel ä»…å‡æ…¢äº†0.6\%ã€‚

\subsubsection{Rumprun}\sectionauthor{é™ˆå»ºç»¿}

Rumprun unikernel æ˜¯åœ¨ rump kernels çš„åŸºç¡€ä¸Šå¼€å‘çš„ã€‚
Rumprun ä¸ä»…å¯ä»¥åœ¨åƒ KVM å’Œ Xen è¿™æ ·çš„ç®¡ç†ç¨‹åºä¸Šå·¥ä½œï¼Œ
è¿˜å¯ä»¥åœ¨è£¸é‡‘å±ä¸Šå·¥ä½œã€‚æ— è®ºæœ‰æ²¡æœ‰ POSIX-y æ¥å£ï¼ŒRumprun éƒ½
å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚å¦‚æœæœ‰ POSIX-y æ¥å£ï¼ŒRumprun åˆ™å…è®¸ç°æœ‰çš„ã€
æœªç»ä¿®æ”¹çš„ POSIX åº”ç”¨ç¨‹åºå¼€ç®±å³ç”¨ï¼›å¦‚æœæ²¡æœ‰ POSIX-y æ¥å£ï¼Œ
Rumprun åˆ™å…è®¸æ„å»ºé«˜åº¦è‡ªå®šä¹‰çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å ç”¨çš„ç©ºé—´æœ€å°ã€‚

Rumprun unikernel æ”¯æŒç”¨ Cã€ C++ ã€ Erlangã€ Goã€
Javaã€ Javascript (node.js)ã€ Pythonã€ Ruby å’Œ Rust ç­‰è¯­è¨€ç¼–å†™çš„åº”ç”¨ç¨‹åºã€‚

åœ¨\ \href{https://github.com/rumpkernel/rumprun-packages}{rumprun-packages repository}\
ä¸­å¯ä»¥æ‰¾åˆ°ç”¨äº Rumprun çš„ç°æˆè½¯ä»¶åŒ…ï¼Œæ¯”å¦‚ \texttt{LevelDB},
\texttt{Memcached}, \texttt{nanomsg}, \texttt{Nginx} å’Œ \texttt{Redis}ã€‚

\paragraph{1. Rump kernels}~

Rump kernels çš„ç»„ä»¶æ¥è‡ªæœªç»ä¿®æ”¹çš„ NetBSDï¼Œç”±æ­¤å¼€å‘è€…æä¾›äº†ä¸€ä¸ª POSIX-y APIã€‚
Rump Kernel é¡¹ç›®ä»¥ä¸€ç§å¯ç”¨äºæ„å»ºè½»é‡çº§ã€ç‰¹æ®Šç”¨é€”è™šæ‹Ÿæœºçš„å½¢å¼æä¾›äº† NetBSD çš„
æ¨¡å—åŒ–é©±åŠ¨ç¨‹åºã€‚å› ä¸ºå¼€å‘è€…æ²¡æœ‰åšä¼šå°†é”™è¯¯å¼•å…¥åˆ°åº”ç”¨ç¨‹åºè¿è¡Œæ—¶(application runtime)ã€
libc æˆ–é©±åŠ¨ç¨‹åºä¸­çš„ç§»æ¤å·¥ä½œï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥å¾ˆç¨³å®šåœ°å·¥ä½œã€‚\cite{bib:21-rump-kernel}
\begin{figure}[!hbt]
\includegraphics[width=\linewidth]{assets/rumprun-1.png}
\caption{Anykernelã€
Rump kernel å’Œ Rumprun Unikernel çš„å…³ç³»}
\end{figure}

\begin{quote}
â€œAnykernelâ€æ¦‚å¿µæŒ‡çš„æ˜¯ä¸€ç§ä¸æ¶æ„æ— å…³çš„é©±åŠ¨ç¨‹åºæ–¹æ³•ï¼Œåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œé©±åŠ¨ç¨‹åºæ—¢å¯ä»¥ç¼–è¯‘åˆ°å®å†…æ ¸ä¸­ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºç”¨æˆ·ç©ºé—´è¿›ç¨‹è¿è¡Œï¼Œå…·æœ‰å¾®å†…æ ¸é£æ ¼ï¼Œå¹¶ä¸”ä¸éœ€è¦ä¿®æ”¹ä»£ç ã€‚\\
\hspace*{\fill}â€”â€”ç»´åŸºç™¾ç§‘
\end{quote}

\paragraph{2. Rumprun}~

Rumprun å¯ç”¨äºå°†å‡ ä¹ä»»ä½•ä¸ POSIX å…¼å®¹çš„ç¨‹åºè½¬æ¢ä¸ºä¸€ä¸ªå¯å·¥ä½œçš„
Unikernelã€‚ä½¿ç”¨ Rumprunï¼Œç†è®ºä¸Šå¯ä»¥å°† Linux æˆ–è€… ç±»Unixç³»ç»Ÿä¸Šçš„å¤§éƒ¨åˆ†
ç¨‹åºç¼–è¯‘æˆ Unikernelã€‚Rumprun ä»¥å¼€å‘ NetBSD å†…æ ¸ä¸­çš„é©±åŠ¨ç¨‹åºå¹¶åœ¨ç”¨æˆ·ç©ºé—´
ä¸­è¿›è¡Œæµ‹è¯•çš„éœ€æ±‚ä¸ºå‡ºå‘ç‚¹ï¼Œä¸»è¦çš„å·¥ä½œæ˜¯é‡æ„è¿™ä¸ªä»£ç åº“ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒä¸€ä¸ªåº“æ“ä½œç³»ç»Ÿã€‚\cite{bib:24-rumrun}

\begin{figure}[!hbt]
\begin{minipage}{0.49\linewidth}
\includegraphics[width=\linewidth]{assets/rumprun-2-cut.png}
\caption{Rumprun çš„æ¶æ„}
\end{minipage}
\begin{minipage}{0.49\linewidth}
\includegraphics[width=\linewidth]{assets/rumprun-3-cut.png}
\caption{Rumprun çš„å·¥ä½œæµç¨‹ç¤ºä¾‹}
\end{minipage}
\end{figure}

Rumprun ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼š

\begin{itemize}
\item single address-space
    \begin{itemize}
    \item no processes
    \item no virtual memory
    \item no signals
    \end{itemize}
\item toolchain
    \begin{itemize}
    \item still experimental
    \end{itemize}
\item threading
    \begin{itemize}
    \item cooperative
    \item single-core
        \begin{itemize}
        \item need to spawn multiple unikernels to use multiple cores
        \end{itemize}
    \end{itemize}
\end{itemize}

æˆ‘åœ¨è°ƒç ”çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œrump kernel çš„å¥½å¤šå®˜æ–¹æ–‡æ¡£éƒ½ä¼šé‡å®šå‘åˆ°
\url{https://rumpkernel.org}è¿™ä¸ªç½‘å€ï¼Œè€Œè¿™ä¸ªç½‘å€ç›®å‰åªæœ‰ä¸€äº› IT Newsï¼Œ
å¹¶éå’Œ rump kernel ç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥çŒœæµ‹è¯¥é¡¹ç›®ç›®å‰å·²ç»æ— äººç»´æŠ¤ã€‚

\subsubsection{Nanos}\sectionauthor{é™ˆå»ºç»¿}

\href{https://github.com/nanovms/nanos}{Nanos}\ ä¸€ä¸ªæ¯”è¾ƒæ–°çš„æ­£åœ¨å¼€å‘ä¸­çš„ Unikernelã€‚

\begin{itemize}
\item Nanos æ˜¯ä¸€ä¸ªæ–°çš„å†…æ ¸ï¼Œæ—¨åœ¨åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­è¿è¡Œä¸€ä¸ªä¸”ä»…æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚
ä¸ Windows æˆ– Linux ç­‰é€šç”¨æ“ä½œç³»ç»Ÿç›¸æ¯”ï¼Œå®ƒæœ‰å‡ ä¸ªé™åˆ¶â€”â€”å³å®ƒæ˜¯ä¸€ä¸ªå•è¿›ç¨‹ç³»ç»Ÿï¼Œ
ä¸æ”¯æŒè¿è¡Œå¤šä¸ªç¨‹åºï¼Œä¹Ÿä¸å…·å¤‡é€šè¿‡ ssh è¿›è¡Œç”¨æˆ·æˆ–è¿œç¨‹ç®¡ç†çš„æ¦‚å¿µã€‚
\item Nanos çš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªæ¯” Linux å®‰å…¨å¾—å¤šçš„ç³»ç»Ÿã€‚
å®ƒåšåˆ°è¿™ä¸€ç‚¹çš„å‡ ä¸ªä¾èµ–ï¼šæ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œæ¯ä¸ªè™šæ‹Ÿæœºåªè¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œé™åˆ¶æ¯ä¸ªè™šæ‹Ÿæœºä¸­åŒ…å«çš„ä»£ç æ•°é‡ã€‚
\item Nanos å¹¶ä¸æ‰“ç®—åœ¨è£¸é‡‘å±ä¸Šè¿è¡Œï¼Œæ‰€ä»¥å¼€å‘è€…åŠªåŠ›ä½¿å…¶å†…æ ¸å°½å¯èƒ½ç®€å•ã€‚
\end{itemize}

\subsubsection{Unikraft}\sectionauthor{å¼ å­è¾°}
Unikraftæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–°çš„unikernelã€‚å®ƒåœ¨è®¾è®¡æ—¶å°±å……åˆ†è€ƒè™‘
äº†ç°æœ‰çš„unikernelsçš„ä¼˜ç¼ºç‚¹ã€‚å®ƒåœ¨ä¿æŒunikernelçš„æç®€åŒ–ã€
é«˜æ•ˆçš„åŒæ—¶ï¼Œå¼•å…¥äº†å®Œæ•´çš„POSIXå…¼å®¹å±‚ï¼Œä½¿å¼€å‘è€…å¯ä»¥è½»æ¾åœ°å°†ç°æœ‰çš„ä¸ºLinux
ç¼–å†™çš„ä»£ç ç§»æ¤åˆ°unikernelä¸Šã€‚Unikraftç”±è‹¥å¹²ä½è€¦åˆçš„æ¨¡å—ç»„æˆï¼Œå†…å­˜åˆ†é…å™¨ã€
è°ƒåº¦å™¨ã€ç½‘ç»œæ ˆã€å¼•å¯¼ä»£ç éƒ½æ˜¯ç‹¬ç«‹çš„å¾®å‹åº“ã€‚Unikraftçš„APIå³ä¸ºå¾®å‹åº“æœ¬èº«ï¼Œ
è¿™æ„å‘³ç€å¯ä»¥åœ¨ç”Ÿæˆæ—¶è½»æ¾åœ°æ·»åŠ æˆ–ç§»é™¤APIsã€‚\cite{bib:unikraft}

Unikraftéµä»å¦‚ä¸‹è®¾è®¡åŸåˆ™ï¼š
\begin{itemize}
\item å†…æ ¸åº”è¯¥æ˜¯å®Œå…¨æ¨¡å—åŒ–çš„ï¼Œä»¥ä¾¿å…è®¸unikernelè¢«å½»åº•è€Œè½»æ¾çš„å®šåˆ¶ã€‚
åœ¨Unikraftä¸­ï¼Œå†…å­˜åˆ†é…å™¨ã€è°ƒåº¦å™¨ã€ç½‘ç»œæ ˆã€å¼•å¯¼ç¨‹åºç­‰ç³»ç»ŸåŸä»¶éƒ½æ˜¯
ç‹¬ç«‹çš„å¾®å‹åº“ã€‚
\item å†…æ ¸åº”è¯¥æä¾›æ³¨é‡æ•ˆç‡ã€è‰¯å®šä¹‰çš„APIï¼Œè€Œä¸”å…è®¸ç”¨æˆ·è½»æ¾åœ°
ä¸ºäº†æ»¡è¶³è‡ªå·±çš„ç¨‹åºçš„æ€§èƒ½è¦æ±‚é€‰æ‹©ã€ç»„è£…å®ƒä»¬ã€‚åœ¨Unikraftä¸­ï¼Œè¿™äº›APIs
å°±æ˜¯å¾®å‹åº“æœ¬èº«ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥è½»æ¾åœ°åœ¨æ„å»ºæ—¶å¢å‡ï¼Œè€Œä¸”æä¾›æ›´å¤š
çš„å¾®å‹åº“å³å¯æ‹“å±•å®ƒä»¬åŠŸèƒ½ã€‚
\end{itemize}

ç›®å‰ï¼ŒUnikraftå·²ç»æ”¯æŒSQLite, nginx, Redisç­‰ç¨‹åºï¼ŒC/C++, Go, Python, Ruby,
Web Assembly and Luaç­‰ç¼–ç¨‹è¯­è¨€æˆ–è¿è¡Œç¯å¢ƒã€‚

åœ¨æ¶æ„æ–¹é¢ï¼ŒUnikraftèåˆäº†å®å†…æ ¸çš„å•åœ°å€ç©ºé—´å¸¦æ¥çš„é«˜æ•ˆæ€§å’Œå¾®å†…æ ¸çš„æ¨¡å—åŒ–å¸¦æ¥çš„
å¯æ‹“å±•æ€§ã€‚OSçš„åŠŸèƒ½è¢«åˆ†å‰²æˆè‹¥å¹²ç»†ç²’å­åº¦çš„ç»„ä»¶ï¼Œè€Œå„ä¸ªç»„ä»¶ä¹‹é—´é€šè¿‡è‰¯å®šä¹‰çš„APIs
é€šä¿¡ã€‚Unikraftç”¨ç²¾å¿ƒè®¾è®¡çš„APIså’Œé™æ€é“¾æ¥è·å¾—é«˜æ•ˆç‡ï¼Œè€Œä¸æ˜¯ä¸ºäº†æ•ˆç‡ç ´åAPI
çš„è¾¹ç•Œã€‚Unikraftå¤§è‡´åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
\begin{description}
\item[å¾®å‹åº“]å¾®å‹åº“æ˜¯å®ç°ä¸€éƒ¨åˆ†çš„Unikraftçš„APIsçš„è½¯ä»¶ç»„ä»¶ï¼Œ
Unikraftçš„ä½œè€…æœ‰æ„å°†å®ƒä»¬åˆ†å‰²åˆ°äº†ä¸åŒçš„åº“ä¸­ï¼Œå¹¶å°½å¯èƒ½é™ä½å®ƒä»¬ä¹‹é—´çš„ä¾èµ–ã€‚
å®ç°ç›¸åŒAPIsçš„å¾®å‹åº“å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚æ¯”å¦‚ï¼ŒUnikraftå†…æ ¸å°±æä¾›äº†å¤šç§å®ç°
\texttt{ukalloc}æ¥å£çš„å†…å­˜åˆ†é…å™¨ã€‚
\item[æ„å»ºç³»ç»Ÿ]å®ƒä¸ºç”¨æˆ·æä¾›åŸºäºKconfigçš„é…ç½®èœå•\footnote{åœ¨å®éªŒ1ä¸­ï¼Œ
æˆ‘ä»¬åœ¨å®šåˆ¶Linuxå†…æ ¸æ—¶ï¼Œè¿è¡Œ\texttt{make menuconfig}åçœ‹åˆ°çš„å°±æ˜¯Kconfigèœå•ã€‚}ï¼Œ
ç”¨æˆ·å¯ç”¨å®ƒé€‰æ‹©è¦ç”¨å“ªäº›å¾®å‹åº“ï¼Œè¦ä¸ºå“ªä¸ªå¹³å°å’Œå“ªä¸ªCPUæ¶æ„æ„å»ºã€‚
\end{description}
\begin{figure}[!hbt]
\includegraphics[width=\linewidth]{assets/Unikraft-architecture.png}
\caption{Unikraftçš„æ¶æ„ï¼ˆé»‘è‰²æ¡†å†…çš„æ˜¯APIsï¼‰å…è®¸ç”¨æˆ·ç¨‹åºæ¥å…¥ä¸åŒå±‚æ¬¡çš„APIsï¼Œä¹Ÿ
å…è®¸ç”¨æˆ·é€‰æ‹©ä¸åŒçš„APIå®ç°ã€‚}\label{fig:unikraft-arch}
\end{figure}

å›¾\ \ref{fig:unikraft-arch}\ å±•ç¤ºäº†Unikraftçš„æ¶æ„ã€‚ä½¿ç”¨ä¸åŒå±‚æ¬¡çš„APIså’Œ
æ›¿æ¢APIå®ç°çš„èƒ½åŠ›ç»™å¼€å‘è€…æä¾›äº†å¤šç§ä¼˜åŒ–å¯èƒ½ã€‚é¦–å…ˆï¼Œæœªç»ä¿®æ”¹çš„ç¨‹åºï¼ˆå¦‚ç”¨Cè¯­è¨€
å†™çš„Hello Worldå’Œnginxï¼‰å¯ä»¥ä½¿ç”¨\texttt{musl}ï¼ˆå›¾\ \ref{fig:unikraft-arch}\ çš„â‘ ï¼‰
æˆ–\texttt{nolibc}æä¾›çš„POSIXå…¼å®¹å±‚ï¼Œå¹¶è‡ªåŠ¨è·å¾—ä½å¯åŠ¨æ—¶é—´ã€ä½å†…å­˜æ¶ˆè€—å’Œ
æ›´é«˜çš„ååé‡ï¼Œå› ä¸ºåœ¨Unikraftä¸­ï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯é«˜æ•ˆçš„å‡½æ•°è°ƒç”¨ã€‚

ç±»ä¼¼åœ°ï¼Œç¨‹åºçš„å¼€å‘è€…å¯ä»¥è½»æ¾é€‰æ‹©åˆé€‚çš„å†…å­˜åˆ†é…å™¨ï¼ˆâ‘¥ï¼‰ä»¥è¾¾åˆ°æœ€é«˜æ•ˆç‡ï¼Œç”šè‡³
åœ¨åŒä¸€ä¸ªunikernelä¸­ä½¿ç”¨å¤šç§åˆ†é…å™¨ã€‚

å…³æ³¨å¿«é€Ÿå¼•å¯¼çš„å¼€å‘è€…ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„éµå®ˆ\texttt{ukboot} APIçš„å¼•å¯¼ä»£ç ï¼ˆâ‘¤ï¼‰ã€‚
å¯¹äºç½‘ç»œå¯†é›†å‹ç¨‹åºï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„å¥—æ¥å­—æ¥å£ï¼ˆâ‘¡ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨æ›´åº•å±‚ã€æ›´é«˜æ•ˆ
çš„\texttt{uknetdev} APIï¼ˆâ‘¦ï¼‰ä»¥ä¾¿å¤§å¹…æé«˜ååé‡ã€‚

ç±»ä¼¼åœ°ï¼Œæ•°æ®åº“è¿™æ ·çš„ç¡¬ç›˜å¯†é›†å‹ç¨‹åºå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„\texttt{vfscore}å¾®å‹åº“ï¼ˆâ‘¢ï¼‰ï¼Œ
æˆ–è€…ç”¨\texttt{ukblock} APIæé«˜ååé‡ï¼ˆâ‘§ï¼‰ã€‚

è°ƒåº¦å™¨ä¹Ÿæ˜¯å¯æ’æ‹”çš„ï¼ˆâ‘£ï¼‰ï¼Œè€Œä¸”æ¯ä¸ªCPUæ ¸å¯ä»¥è¿è¡Œä¸åŒçš„è°ƒåº¦å™¨ã€‚


ä¸å…¶ä»–unikernelsç›¸æ¯”ï¼ŒUnikraftçš„ç³»ç»Ÿé•œåƒæ›´å°ã€è¿è¡Œæ‰€éœ€å†…å­˜æ›´å°ã€ååé‡æ›´å¤§ï¼š
\begin{figure}[H]
\centering
\begin{minipage}{0.32\linewidth}
\includegraphics[width=1\linewidth]{assets/Unikraft-image-size.png}
\caption{}
\label{fig:unikraft-image-size}
\end{minipage}
\begin{minipage}{0.32\linewidth}
\includegraphics[width=1\linewidth]{assets/Unikraft-memory.png}
\caption{}
\end{minipage}
\begin{minipage}{0.32\linewidth}
\includegraphics[width=1\linewidth]{assets/Unikraft-throughput.png}
\caption{}
\end{minipage}
\end{figure}

Unikraftåœ¨æå‡æ•ˆç‡çš„åŒæ—¶å…¼é¡¾äº†å®‰å…¨æ€§ã€‚æ ¹æ®NCC Group\cite{bib:unikernel-secuirty}ï¼Œ
è™½ç„¶ unikernel ç›¸æ¯”å®¹å™¨ä½“ç§¯æ›´å°ã€éš”ç¦»æ€§æ›´å¥½ï¼Œä½†æ˜¯ç”±äºä¸å­˜åœ¨å†…æ ¸æ€-ç”¨æˆ·æ€éš”ç¦»ï¼Œ
ä¸”ç¼ºä¹W\^{}Xã€stack canaryç­‰å®‰å…¨ç‰¹æ€§ï¼Œunikernel å…¶å®æ¯”ä¼ ç»Ÿçš„å®¹å™¨æ›´ä¸å®‰å…¨ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ unikernel ä¸Šçš„ç¨‹åºçš„æ¼æ´ï¼Œæ§åˆ¶ unikernel æ‰€åœ¨çš„è™šæ‹Ÿæœºï¼Œ
è¿›è€Œæœªç»æˆæƒè®¿é—®èµ„æºã€‚

æ‰€ä»¥ï¼Œä¸èƒ½ç‰‡é¢åœ°æŠŠå®‰å…¨æ€§ä¸éš”ç¦»æ€§ç­‰åŒã€‚è€Œä¸”æˆ‘ä»¬ä¸èƒ½
ç‰‡é¢åœ°è®¤ä¸ºä½¿ç”¨ Rust è¿™æ ·çš„å®‰å…¨çš„ç¨‹åºè®¾è®¡è¯­è¨€å°±èƒ½ä¿è¯å®‰å…¨ï¼Œ
å› ä¸ºå®Œæ•´çš„ unikernel ä¸Šä¸åªåŒ…å«å®‰å…¨çš„ç³»ç»Ÿä»£ç ï¼ˆæˆ–è€…è¯´åº“ä»£ç ï¼‰ï¼Œè¿˜åŒ…å«å¯èƒ½ä¸å®‰å…¨çš„ç”¨æˆ·ä»£ç ï¼Œ
è€Œåè€…å¯ä»¥å¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å®‰å…¨ã€‚å› æ­¤ï¼Œè¦å®ç°å®‰å…¨çš„ unikernelï¼Œä¸èƒ½ä»…ä»…ä¾é å®‰å…¨çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œ
è€Œéœ€è¦é¢å¤–çš„å®‰å…¨ç‰¹æ€§ã€‚

NCC Groupæåˆ°äº†ASLRã€åˆ†é¡µä¿æŠ¤ï¼ˆå¦‚W\^{}Xæ”¿ç­–ã€å†…éƒ¨æ•°æ®åŠ å›ºã€ä¿æŠ¤é¡µã€ç©ºé¡µé¢æ¼æ´ç­‰ï¼‰ã€
æ ˆä¿æŠ¤æ ‡å¿—\footnote{å®ƒçš„è‹±æ–‡stack canaryæ¥è‡ªé‡‘ä¸é›€æ›¾ç»è¢«ç”¨æ¥æ£€æŸ¥ç…¤çŸ¿çš„æœ‰æ¯’æ°”ä½“çš„å…¸æ•…\cite{bib:canary}ã€‚}ã€å †åŠ å›ºã€æ ‡å‡†åº“åŠ å›ºç­‰å®‰å…¨æªæ–½ã€‚

å®ƒæµ‹è¯•äº† rumprun å’Œ includeOS ä¸¤ä¸ª unikernelsï¼Œå¹¶å‘ç°å®ƒä»¬å‡ ä¹æ²¡æœ‰å®ç°ä»»ä½•å®‰å…¨ç‰¹æ€§ã€‚

å°½ç®¡ Unikraft ä½¿ç”¨ C è¯­è¨€å®ç°ï¼Œä½†å®ƒæ”¯æŒï¼ˆæˆ–è®¡åˆ’æ”¯æŒï¼‰
\href{https://github.com/unikraft/unikraft/tree/staging/lib/uksp}{Stack SP}ã€
\href{https://github.com/unikraft/unikraft/tree/staging/lib/ubsan}{UBSAN}ã€
\href{https://github.com/unikraft/unikraft/pull/421}{ARM BTI}ã€\href{https://github.com/unikraft/unikraft/pull/191}{KASAN}ã€\href{https://github.com/unikraft/unikraft/pull/239}{PIE}ã€True Random Number Generatorã€
Intel CETã€ARM SBç­‰å®‰å…¨ç‰¹æ€§ã€‚\cite{bib:unikraft-secuirty}

\subsubsection{æ¯”è¾ƒ}\sectionauthor{å¼ å­è¾°}
è¡¨\ \ref{table:unikernel-compare}\ æ¯”è¾ƒäº†æˆ‘ä»¬è¯¦ç»†è°ƒç ”çš„unikernelsã€‚å› ä¸ºç°æœ‰çš„
èµ„æ–™å¹¶æ²¡æœ‰åŒ…å«æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¡¨ä¸­çš„ä¸€äº›ä¿¡æ¯æ˜¯ä¾é é˜…è¯»æºä»£ç è·å–çš„ã€‚
\small
\begin{longtable}{|c*{7}{|>{\centering\arraybackslash}p{0.095\linewidth}}|}
\caption{Unikernelsçš„æ¯”è¾ƒ}\label{table:unikernel-compare}\\
\hline
&ClickOS&\resizebox{\linewidth}{\height}{MirageOS}&\resizebox{\linewidth}{\height}{IncludeOS}&\resizebox{\linewidth}{\height}{RustyHermit}&Nanos&Rumprun&Unikraft\\\hline
\endfirsthead
\hline
&ClickOS&\resizebox{\linewidth}{\height}{MirageOS}&\resizebox{\linewidth}{\height}{IncludeOS}&\resizebox{\linewidth}{\height}{RustyHermit}&Nanos&Rumprun&Unikraft\\\hline
\endhead
å®ç°è¯­è¨€&C++&OCaml&C++&Rust&C&C&C\\\hline
æ”¯æŒæ¶æ„&x86-32ã€x86-64&x86-64ã€ARM-64&x86-32ã€x86-64ã€ARM-64&x86-64ã€ARM-64&x86-64ã€ARM-64ã€RISCV-64&x86-32ã€x86-64ã€ARM-64&x86-64ã€ARM-32ã€ARM-64\\\hline
æ”¯æŒå¹³å°&Xen&KVMã€Xen&KVMã€Virtual Boxã€VMWareã€x86ç‰©ç†æœº&QEMUã€Uhyve&ä¼—å¤šï¼ŒåŒ…æ‹¬ä½†ä¸é™äºXenã€KVMã€VMWareã€Virtual Boxç­‰&Xenã€åµŒå…¥å¼è®¾å¤‡&KVMã€Xenã€Solo5ã€Linuxç”¨æˆ·æ€\\\hline
æ”¯æŒè¯­è¨€&Cã€C++&OCaml&Cã€C++&Rustã€Cã€C++ã€Goã€Fortran&ä¼—å¤šï¼ŒåŒ…æ‹¬ä½†ä¸é™äºCã€Goã€PHPã€Nodeã€Rubyã€Luaã€Perlç­‰ï¼Œç†è®ºä¸Šæ”¯æŒä»»ä½•ELFæ–‡ä»¶&ä¼—å¤šï¼ŒåŒ…æ‹¬ä½†ä¸é™äºCã€C++ã€Erlangã€Goã€Javaã€Javascript (node.js)ã€Pythonã€Ruby ã€Rustç­‰&ä¼—å¤šï¼ŒåŒ…æ‹¬ä½†ä¸é™äºCã€C++ã€Goã€Pythonã€Rubyã€Web Assemblyã€Luaç­‰\\\hline
æ„å»ºç³»ç»Ÿ&Click configuration language&Opam&Conanã€CMake&cargoã€CMake&ç³»ç»Ÿä¸ç”¨æˆ·ç¨‹åºåˆ†åˆ«æ„å»ºï¼Œç³»ç»Ÿä½¿ç”¨Makefileæ„å»º&buildrump&Kraftã€Kconfig\\\hline
å®‰å…¨æ€§&ä¸è¯¦&ç”¨å®‰å…¨è¯­è¨€å®ç°ï¼Œæ”¯æŒrandom device&è¾ƒå·®ï¼Œç”šè‡³å…³é—­äº†ä¸€äº›C++ç¼–è¯‘å™¨æ”¯æŒçš„å®‰å…¨ç‰¹æ€§&
ç”¨å®‰å…¨è¯­è¨€å®ç°ï¼Œæ”¯æŒå †æ ˆä¿æŠ¤ã€åº”ç”¨ç¨‹åºå †æ ˆä¸æ“ä½œç³»ç»Ÿåº“å †æ ˆåˆ†ç¦»ï¼Œæœ‰æ”¯æŒé¡µä¿æŠ¤çš„è¡ç”Ÿä½œå“&æ”¯æŒASLRã€é¡µä¿æŠ¤&æœ‰é™ï¼Œ\texttt{.text}æ®µä¸å¯å†™ï¼Œæœ‰ä¸€å®šçš„å †ä¿æŠ¤ï¼Œé»˜è®¤å¼•å…¥å¤§é‡æ— ç”¨åº“&æ”¯æŒStack SPã€UBSANã€ARM BTIã€PIEã€Intel CETã€random deviceç­‰å®‰å…¨ç‰¹æ€§\\\hline
API&ä¸“ç”¨API&OCamlæ ‡å‡†åº“ï¼Œå’Œå¤§é‡å…¶ä»–ç”¨OCamlå®ç°çš„åº“&ä¸å®Œæ•´çš„Cã€C++ã€POSIX APIæ”¯æŒ&Rustæ ‡å‡†åº“ï¼Œéƒ¨åˆ†Cã€C++ã€Goã€Fortran API&æ— ï¼Œä¾é ç³»ç»Ÿè°ƒç”¨ä¸ç”¨æˆ·ç¨‹åºé€šä¿¡&Cã€POSIX APIå’Œå¤§é‡è½¯ä»¶åŒ…ï¼Œé»˜è®¤å¼€å¯ç³»ç»Ÿè°ƒç”¨&ä¸“ç”¨APIã€POSIX APIã€C APIå’Œä¼—å¤šåº“\\\hline
ç½‘ç»œ&æœ‰&æœ‰&æœ‰&ç”¨smoltcpå®ç°&æœ‰&æœ‰&å¯é€‰æ‹©lwipå’Œmtcpä¸¤ç§å®ç°\\\hline
å†…å­˜ç®¡ç†&æœ‰&æœ‰ï¼Œæ”¯æŒåƒåœ¾å›æ”¶&æœ‰&æœ‰&æœ‰&æœ‰&æœ‰ï¼Œå¯ä»¥é€‰æ‹©å¤šç§åˆ†é…å™¨\\\hline
çº¿ç¨‹ç®¡ç†&æœ‰&æ— æŠ¢å ï¼Œæœ‰è¿›ç¨‹é€šä¿¡æ”¯æŒ&æœ‰&æœ‰ï¼Œæ”¯æŒä¼˜å…ˆçº§&æœ‰&æ— æŠ¢å &æ”¯æŒæŠ¢å å’Œæ— æŠ¢å ä¸¤ç§è°ƒåº¦å™¨ï¼Œæœ‰è¿›ç¨‹é€šä¿¡æ”¯æŒ\\\hline
æ–‡ä»¶ç®¡ç†&æ— &æ”¯æŒFATå’Œmmap&æ”¯æŒmmapå’Œè¯»FAT32&å¯ä»¥æ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿåç«¯ï¼Œç›®å‰æ”¯æŒvirtio-fså’Œmmap&æœ‰&æœ‰&æ”¯æŒ9pfså’Œmmap\\\hline
å¤‡æ³¨&åŸºäºMiniOS&&&&ç›¸æ¯”unikernelï¼ŒNanosæ›´åƒä¸€ä¸ªå¾®å‹å†…æ ¸&åŒ…å«å¤§é‡NetBSDçš„ä»£ç &\\\hline
\end{longtable}
\normalsize

\section{ç«‹é¡¹ä¾æ®}\sectionauthor{å¼ å­è¾°}
æˆ‘ä»¬è°ƒç ”çš„unikernelé¡¹ç›®çš„ä¸è¶³ä¹‹å¤„å¯ä»¥æ¦‚æ‹¬ä¸ºï¼ˆå¹¶ä¸æ¯ä¸ªunikerneléƒ½æœ‰æ‰€æœ‰ç¼ºç‚¹ï¼‰ï¼š
\begin{itemize}
\item ç³»ç»Ÿå†…çš„ç»„ä»¶è€¦åˆåº¦è¿‡é«˜ï¼Œç³»ç»Ÿä¸æ˜“è£å‰ªæˆ–æ‹“å±•ã€‚åœ¨æ‹“å±•æ–¹é¢åšå¾—æ¯”è¾ƒå¥½çš„unikernelsæœ‰
MirageOSã€Rumprunå’ŒUnikraftã€‚
\item éœ€è¦ä½¿ç”¨ä¸“ç”¨çš„å·¥å…·æ„å»ºç³»ç»Ÿé•œåƒã€‚å¯¹äºåªæœ‰å‡ ä¸ªæºæ–‡ä»¶çš„å°å‹é¡¹ç›®ï¼Œä½¿ç”¨ä¸“ç”¨çš„å·¥å…·å¹¶ä¸
æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¯¹äºç”±æˆåƒä¸Šä¸‡ä¸ªæºæ–‡ä»¶ç»„æˆçš„å¤§å‹é¡¹ç›®ï¼Œæ›´æ”¹æ„å»ºç¯å¢ƒæœ¬èº«å°±æ˜¯ä¸€é¡¹æµ©å¤§
çš„å·¥ç¨‹ã€‚ç›®å‰ï¼ŒNanoså…è®¸ç”¨æˆ·ç¨‹åºä½¿ç”¨ç‹¬ç«‹çš„å·¥å…·æ„å»ºï¼ŒMirageOSå’ŒRustHermitçš„æ„å»ºå·¥å…·
æ˜¯å®ƒä»¬çš„è¯­è¨€çš„é»˜è®¤å·¥å…·ã€‚
\item å°†å®‰å…¨æ€§ä¸éš”ç¦»æ€§ç­‰åŒï¼Œå¿½è§†äº†å•ä¸ªunikernelè™šæ‹Ÿæœºçš„å®‰å…¨ã€‚ç›®å‰ï¼Œåœ¨æ–‡æ¡£ä¸­æ˜ç¡®æåˆ°
å®‰å…¨æªæ–½çš„unikernelsæœ‰RustyHermitã€Nanoså’ŒUnikraftã€‚
\item æ ¸å¿ƒä»£ç ä½¿ç”¨ä¸å®‰å…¨çš„ç¨‹åºè®¾è®¡è¯­è¨€ç¼–å†™ã€‚ä½¿ç”¨å®‰å…¨çš„ç¼–ç¨‹è¯­è¨€å†™çš„unikernelsåªæœ‰MirageOSå’Œ
RustyHermitã€‚ç”¨ä¸å®‰å…¨çš„ç¨‹åºè®¾è®¡è¯­è¨€éš¾ä»¥é¿å…å®ç°æ—¶å¼•å…¥çš„å®‰å…¨æ¼æ´ã€‚
\item ä¸æ”¯æŒRISC-Væ¶æ„ã€‚ç›®å‰åªæœ‰Nanosæ”¯æŒRISC-Væ¶æ„ã€‚
\end{itemize}
è™½ç„¶è¯´å…¼å®¹æ€§ä¹Ÿæ˜¯unikernelsçš„ä¸€å¤§ä¸è¶³ï¼Œä½†æ˜¯è®¸å¤šunikernelsçš„å¼€å‘è€…å·²ç»åœ¨å°½åŠ›è§£å†³
å®ƒï¼Œä»¥è‡³äºé™¤äº†MirageOSå¤–çš„unikernelséƒ½æä¾›äº†æˆ–å¤šæˆ–å°‘çš„Cæ ‡å‡†åº“æ”¯æŒã€‚

Nanosåœ¨å…¼å®¹æ€§ã€æ˜“æ„å»ºæ€§æ–¹é¢åšå¾—éƒ½å¾ˆå¥½ï¼Œä¹Ÿæ”¯æŒRISC-Væ¶æ„ï¼Œå¯æ˜¯å®ƒä¼¼ä¹ä¸ºäº†æ”¯æŒ
ç›´æ¥è¿è¡ŒELFæ–‡ä»¶ï¼ŒæŠ›å¼ƒäº†unikernelsçš„æœ€é‡è¦çš„æ— ç³»ç»Ÿè°ƒç”¨çš„ç‰¹æ€§ï¼›Unikraftå£°ç§°å¯
é…ç½®ä¸ºPOSIXå…¼å®¹ï¼Œè€Œä¸”ç³»ç»Ÿæ¶æ„æ¯”è¾ƒæ¸…æ™°ï¼Œå¯æƒœå®ƒä¸æ”¯æŒRISC-Vï¼Œè€Œä¸”é•œåƒçš„æ„å»ºéœ€è¦ä¸“ç”¨
å·¥å…·ã€‚Nanoså’ŒUnikraftçš„å…±åŒç¼ºé™·æ˜¯ä½¿ç”¨ä¸å®‰å…¨çš„Cè¯­è¨€ç¼–å†™ã€‚MirageOSä½¿ç”¨å®‰å…¨çš„è¯­è¨€ç¼–å†™ï¼Œ
å¹¶ä¸”æœ‰ä¸°å¯Œçš„è½¯ä»¶åŒ…èµ„æºï¼Œå¯æ˜¯å®Œå…¨ä¸æ”¯æŒç°æœ‰çš„ç¨‹åºï¼›æƒ³å°†ç¨‹åºç§»æ¤åˆ°MirageOSä¸Šå¿…é¡»ç”¨OCaml
é‡æ„ç¨‹åºã€‚RustHermitæ˜¯å¯¹ç”¨Cè¯­è¨€å®ç°çš„HermitCoreçš„é‡æ„ï¼Œæˆ‘ä»¬å—å®ƒçš„å¯å‘ï¼Œä¹Ÿå†³å®šç”¨Rust
é‡æ„ä¸€ä¸ªç°æœ‰çš„unikernelã€‚

æˆ‘ä»¬å°ç»„è®¡åˆ’ä»¿ç…§Unikraftçš„æ¶æ„ï¼Œç”¨Rustè¯­è¨€ç¼–å†™èƒ½åœ¨RISC-Væ¶æ„+ QEMUå¹³å°ä¸Š
è¿è¡Œçš„unikernelâ€”â€”Runikraftã€‚Runikraftçš„æ ¸å¿ƒä»£ç ä½¿ç”¨Rustç¼–å†™ï¼Œä½†
å…è®¸ç”¨æˆ·ä»£ç ä½¿ç”¨ä»»ä½•è¯­è¨€ç¼–å†™ã€‚Runikraftå¼ºè°ƒæ„å»ºç³»ç»Ÿé•œåƒçš„ç®€æ´ï¼Œç”¨æˆ·åªéœ€è¦
ä¿®æ”¹ç°æœ‰çš„é¡¹ç›®çš„ç¼–è¯‘å‚æ•°å°±å¯ä»¥æ„å»ºåŸºäºRunikraftçš„ç³»ç»Ÿé•œåƒï¼Œè€Œä¸å¿…ä½¿ç”¨
ä¸“ç”¨çš„å·¥å…·é“¾ï¼Œæ›´ä¸éœ€è¦é‡æ„ä»£ç ã€‚å…·ä½“çš„æ–¹æ³•æ˜¯å…ˆå°†Runikraftç¼–è¯‘æˆé™æ€åº“ï¼Œ
ç„¶åé€šè¿‡ä¿®æ”¹ç¼–è¯‘å‚æ•°ï¼Œè®©ç”¨æˆ·ç¨‹åºä¸é“¾æ¥æ ‡å‡†åº“ï¼Œè€Œé“¾æ¥åˆ°Runikraftã€‚

Runikraftæ”¯æŒå†…å­˜ç®¡ç†ã€è¿›ç¨‹è°ƒåº¦ã€
è¿›ç¨‹é€šä¿¡å’Œç£ç›˜ç®¡ç†ï¼Œè€Œä¸”è¿™äº›åŠŸèƒ½éƒ½æ˜¯æ˜¯å¯é€‰çš„ä¸”å¯
æ‹“å±•çš„ï¼Œå¦‚æœç”¨æˆ·ä¸éœ€è¦æŸé¡¹åŠŸèƒ½ï¼Œä»–å¯ä»¥ä¸å°†ç›¸å…³æ¨¡å—æ‰“åŒ…è¿›ç³»ç»Ÿé•œåƒä¸­ï¼Œ
å¦‚æœç”¨æˆ·èƒ½å¤Ÿæä¾›æŸäº›åŠŸèƒ½çš„æ›´å¥½å®ç°ï¼Œä»–å¯ä»¥ç”¨è‡ªå·±çš„å®ç°æ›¿æ¢åŸæœ‰çš„æ¨¡å—ã€‚

Runikraftçš„äº®ç‚¹ï¼š
\begin{itemize}
\item ç”¨å®‰å…¨çš„Rustè¯­è¨€ç¼–å†™ï¼›
\item æ”¯æŒæ­£åœ¨è¿…é€Ÿå‘å±•çš„RISC-VæŒ‡ä»¤é›†æ¶æ„ï¼›
\item æ„å»ºæµç¨‹ç®€å•ï¼›
\item æ¨¡å—åŒ–è®¾è®¡ï¼Œåœ¨ä¿æŒunikernelçš„é«˜æ•ˆçš„åŒæ—¶é™ä½ç»´æŠ¤éš¾åº¦ã€‚
\end{itemize}

Runikraftçš„ç›®æ ‡æ˜¯æä¾›æ¯”è¾ƒå®Œæ•´çš„POSIXå…¼å®¹å±‚ã€Linuxå…¼å®¹å±‚å’ŒCæ ‡å‡†åº“ï¼Œ
ä½†æ˜¯è€ƒè™‘åˆ°æ—¶é—´æœ‰é™ï¼Œè¿™äº›åŠŸèƒ½åªèƒ½éƒ¨åˆ†å®ç°ã€‚

æˆ‘ä»¬è€ƒè™‘è¿‡æ”¹å–„unikernelçš„è°ƒè¯•ï¼Œå³zoså°ç»„çš„ç ”ç©¶ï¼Œ
ä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼ŒQEMUäº‹å®ä¸Šå·²ç»æ”¯æŒäº¤äº’å¼çš„è™šæ‹Ÿæœºè°ƒè¯•äº†ã€‚

æˆ‘ä»¬è€ƒè™‘è¿‡ä½†æœ€ç»ˆä¸æ‰“ç®—å®ç°ä¸Linuxçš„äºŒè¿›åˆ¶å…¼å®¹ï¼Œå³
unipanicå°ç»„çš„ç ”ç©¶ï¼Œå› ä¸º
æˆ‘ä»¬è®¤ä¸ºä¸ä¼šå‡ºç°éœ€è¦ç§»æ¤æ— æ³•è·å¾—æºä»£ç çš„ç¨‹åºçš„æƒ…å†µï¼š
\begin{itemize}
\item å¦‚æœæºä»£ç å› è‘—ä½œæƒé—®é¢˜æ— æ³•è·å–ï¼Œ
    \begin{enumerate}
    \item ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ç§»æ¤ï¼Œå³æŠŠ\texttt{syscall}æŒ‡ä»¤æ›¿æ¢ä¸º\texttt{jmp}
    æŒ‡ä»¤åç§»æ¤ã€‚è¿™æ ·å¯ä»¥ä¿æŒæ•ˆç‡ï¼Œä½†ä¼šä¾µçŠ¯è‘—ä½œæƒã€‚
    \item ç›´æ¥ç§»æ¤æœªä¿®æ”¹çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™éœ€è¦\texttt{syscall}ï¼Œä¼šå¼•å…¥ä¸Šä¸‹æ–‡åˆ‡æ¢
    å¼€é”€ï¼Œæ•ˆç‡éš¾ä»¥ä¿è¯ã€‚
    \end{enumerate}
\item å¦‚æœæºä»£ç å› è½¯ä»¶æ— äººç»´æŠ¤æ— æ³•è·å–ï¼Œé‚£è¿™æ ·çš„è¿‡æ—¶è½¯ä»¶æœ¬èº«å°±ä¸åº”è¯¥è¢«ç»§ç»­ä½¿ç”¨ã€‚
\end{itemize}

åœ¨ç³»ç»Ÿæ¶æ„æ–¹é¢ï¼Œæˆ‘ä»¬å°†ä¸»è¦å‚è€ƒUnikraftï¼›
åœ¨æŠ€æœ¯æ–¹é¢ï¼Œæˆ‘ä»¬å°†å‚è€ƒRustyHermitã€Nanoså’ŒChen and Wuçš„\textit{rCore Tutorial Book}\cite{bib:rcore-os}ã€‚

\section{ç†è®ºä¾æ®}
\subsection{Rustè¯­è¨€}\sectionauthor{é™ˆå»ºç»¿}\vspace*{-4ex}
\subsubsection{ä¿è¯å†…å­˜å®‰å…¨çš„æ–¹å¼}
åœ¨é«˜çº§è¯­è¨€ä¸­ï¼ŒæŸä¸ªå†…å­˜ä½ç½®è¦åœ¨ç¨‹åºä¸­èƒ½è¢«è®¿é—®ï¼Œå¿…ç„¶å°±ä¼šä¸ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡å»ºç«‹å…³è”å…³ç³»ã€‚
è¿™ä¼šå¼•å‡ºå†…å­˜çš„ä¸æ­£ç¡®è®¿é—®å¼•å‘çš„å†…å­˜å®‰å…¨é—®é¢˜ã€‚è¿™äº›é—®é¢˜åœ¨C/C++ä¸­éƒ½æ˜¯éœ€è¦å¼€å‘è€…éå¸¸å°å¿ƒåœ°
è‡ªå·±å¤„ç†ã€‚è€Œ Rust çš„è¯­è¨€ç‰¹æ€§åˆ™ä¸ºä¸Šé¢çš„é—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚\cite{bib:feasibility-8}
\begin{table}[H]
\centering
\caption{Rustå¯¹å†…å­˜å®‰å…¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ}
\begin{tabular}{|c|c|}
\hline
\textbf{é—®é¢˜} & \textbf{Rust çš„è§£å†³æ–¹æ¡ˆ}\\\hline
ä½¿ç”¨æœªåˆå§‹åŒ–å†…å­˜&ç¼–è¯‘å™¨ç¦æ­¢è¯»å–æœªèµ‹å€¼å˜é‡\\\hline
å¯¹ç©ºæŒ‡é’ˆè§£å¼•ç”¨&ä½¿ç”¨\texttt{Option}æšä¸¾æ›¿ä»£ç©ºæŒ‡é’ˆ\\\hline
æ‚¬å‚æŒ‡é’ˆ&ç”Ÿå‘½å‘¨æœŸæ ‡è¯†ä¸ç¼–è¯‘å™¨æ£€æŸ¥\\\hline
ç¼“å†²åŒºæº¢å‡º&ç¼–è¯‘å™¨æ£€æŸ¥ï¼Œæ‹’ç»è¶…è¶Šç¼“å†²åŒºè¾¹ç•Œçš„æ•°æ®è®¿é—®\\\hline
éæ³•é‡Šæ”¾å†…å­˜&è¯­è¨€çº§çš„ RAII æœºåˆ¶ï¼Œå”¯ä¸€çš„æ‰€æœ‰è€…æ‰æœ‰æƒé‡Šæ”¾å†…å­˜\\\hline
\end{tabular}
\end{table}
\subsubsection{ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ–¹å¼}
Rust é€šè¿‡ä¸€æ•´å¥—è®¾è®¡éå¸¸ç²¾è‰¯çš„åŸºç¡€è®¾æ–½æ¥ä¿è¯è¿™ä¸€ç‚¹ï¼Œè¿™äº›åŸºç¡€è®¾æ–½é…åˆç±»å‹æ£€æŸ¥å’Œ
å€Ÿç”¨æ¨¡å‹â€œå¼ºè¿«â€ç¨‹åºå‘˜å†™å‡ºæ­£ç¡®çš„ä»£ç ï¼ŒæŠŠåˆ«çš„è¯­è¨€åœ¨è¿è¡Œæ—¶çš„å´©æºƒæˆ–æ³„éœ²æš´éœ²åœ¨ç¼–è¯‘æœŸï¼Œ
ä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

\noindent åŸºç¡€è®¾æ–½ï¼š

\begin{enumerate}
\item è¿›è¡Œè¯­ä¹‰é™åˆ¶çš„\texttt{Send} / \texttt{Sync} ã€\texttt{Trait}ã€‚
\item å…±äº«ä¸å¯å˜æ‰€æœ‰æƒçš„\texttt{Arc} (\texttt{Rc}çš„å¤šçº¿ç¨‹ç‰ˆæœ¬)ã€‚
\item æä¾›å†…éƒ¨å¯å˜æ€§çš„\texttt{Mutex} / \texttt{Rwlock}ã€‚
\item ç®¡é“æ¨¡å‹\texttt{channel}ã€‚
\item å…¶ä»–çš„ä¸€äº›çº¿ç¨‹ç›¸å…³çš„APIã€‚
\end{enumerate}

\noindent çº¿ç¨‹ç›¸å…³çš„å¸¸è§APIä¸è®¾æ–½ï¼š

\begin{enumerate}
\item \texttt{std::thread::spawn}ï¼Œ\texttt{spawn}æ¥æ”¶ä¸€ä¸ªé—­åŒ…å¹¶æ‰§è¡Œ,è¿”å›ä¸€ä¸ª
\texttt{JoinHandle}ç±»å‹çš„å€¼ï¼Œå®ƒæ‹¥æœ‰çº¿ç¨‹æ‰€æœ‰æƒï¼›
\item  \texttt{join()}å‡½æ•°ï¼Œè¯¥å‡½æ•°ä½œç”¨åœ¨çº¿ç¨‹å¥æŸ„\texttt{JoinHandle}ç±»å‹çš„å€¼ä¸Šï¼Œ
ä½¿å¾—çˆ¶çº¿ç¨‹èƒ½å¤Ÿç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼›
\item \texttt{move}+é—­åŒ…ï¼Œ\texttt{move}é—­åŒ…å¸¸å¸¸ä¸\texttt{thread}å’Œ\texttt{spawn}
ä¸€èµ·ä½¿ç”¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®ï¼Œä½¿ç”¨\texttt{move}å…³é”®å­—å¼ºåˆ¶é—­åŒ…è·å–
å…¶ä½¿ç”¨çš„ç¯å¢ƒå€¼çš„æ‰€æœ‰æƒã€‚
\end{enumerate}

Rust æ‰€æ‹¥æœ‰çš„è¿™äº›è®¾æ–½ä»¥åŠè‡ªèº«çš„ç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬ç¼–å†™å‡ºæ­£ç¡®çš„ä»£ç ä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚\cite{bib:feasibility-9}

\subsubsection{Unsafe Rust}
åœ¨è¿›è¡Œåº•å±‚ç³»ç»Ÿç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä½¿ç”¨Rust çš„unsafeå…³é”®å­—ï¼Œä½¿ç”¨è¯¥å…³é”®å­—å¯ä»¥ä½¿æˆ‘ä»¬å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

è§£å¼•ç”¨åŸç”ŸæŒ‡é’ˆï¼Œè¿™å¯¹äºå’ŒCè¯­è¨€å’Œæ±‡ç¼–è¯­è¨€ç¨‹åºäº¤äº’å¾ˆæœ‰ç”¨ã€‚
è°ƒç”¨ä¸€ä¸ªä¸å®‰å…¨çš„å‡½æ•°æˆ–æ–¹æ³•ï¼ˆä¾‹å¦‚Cè¯­è¨€å‡½æ•°ï¼‰ã€‚
è®¿é—®å’Œä¿®æ”¹é™æ€å˜é‡ï¼Œåè€…æ˜¯Rustä¸­çš„"å…¨å±€å˜é‡"ã€‚
ä½¿ç”¨Unsafe Rustä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘Rustç¼–è¯‘å™¨çš„å®‰å…¨æ£€æŸ¥ï¼Œä½†ç‰ºç‰²çš„ç¨è®¸å®‰å…¨æ€§å´å¯ä»¥æ¢æ¥
çµæ´»æ€§çš„å·¨å¤§æé«˜ã€‚åœ¨ä¸ç¡¬ä»¶æŠ½è±¡è¿›è¡Œäº¤äº’æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½
éœ€è¦ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚

\subsection{Rustä¸Cäº¤äº’}
Rust ä¸­æä¾›äº†\texttt{extern}å…³é”®å­—æ¥ç®€åŒ–åˆ›å»ºå’Œä½¿ç”¨å¤–éƒ¨æ¥å£ï¼ˆForeign Function
Interface, FFIï¼‰çš„è¿‡ç¨‹ã€‚FFI æ˜¯ç¼–ç¨‹è¯­è¨€å®šä¹‰å‡½æ•°çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒå…è®¸å…¶ä»–ï¼ˆå¤–éƒ¨çš„ï¼‰ç¼–ç¨‹è¯­è¨€
æ¥è°ƒç”¨è¿™äº›å‡½æ•°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªé›†æˆäº†Cæ ‡å‡†åº“ä¸­çš„\texttt{abs}å‡½æ•°çš„ç¤ºä¾‹ä»£ç ï¼š
\begin{lstlisting}[numbers=left]
	extern "C" {
		fn abs(input: i32) -> i32;
	}
	fn main(){
		unsafe {
			println!("Absolue value of -3 according to C: {}", abs(-3));
		}
	}
\end{lstlisting}
è¿™æ®µä»£ç åœ¨\texttt{extern "C"}å—ä¸­åˆ—å‡ºäº†å®ƒæƒ³è¦è°ƒç”¨çš„å¤–éƒ¨å‡½æ•°å’Œç­¾åï¼Œå…¶ä¸­çš„\texttt{"C"}æŒ‡æ˜
äº†å¤–éƒ¨å‡½æ•°ä½¿ç”¨çš„åº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆApplication Binary Interface, ABIï¼‰ï¼šå®ƒè¢«ç”¨æ¥å®šä¹‰å‡½æ•°åœ¨
æ±‡ç¼–å±‚é¢çš„è°ƒç”¨æ–¹å¼ã€‚

è¦åœ¨å…¶ä»–è¯­è¨€ä¸­è°ƒç”¨ Rust å‡½æ•°ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨\texttt{extern}æ¥åˆ›å»ºä¸€ä¸ªå…è®¸å…¶ä»–è¯­è¨€è°ƒç”¨ Rust
å‡½æ•°çš„æ¥å£ã€‚åˆ›å»ºæ—¶éœ€è¦å°†\texttt{extern}å…³é”®å­—åŠå¯¹åº”çš„ ABI æ·»åŠ åˆ°å‡½æ•°ç­¾åçš„\texttt{fn}å…³é”®å­—
å‰ï¼Œå¹¶ä¸ºè¯¥å‡½æ•°æ·»åŠ \texttt{\#[no\_mangle]}æ³¨è§£æ¥é¿å… Rust åœ¨ç¼–è¯‘æ—¶æ”¹å˜å®ƒçš„åç§°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ç¼–è¯‘å¹¶é“¾æ¥åè¢« C è¯­è¨€ä»£ç è®¿é—®çš„å‡½æ•°å®šä¹‰ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
	#[no_mangle]
	pub extern "C" fn call_from_c() {
		println!("Just called a Rust function from C!");
	}
\end{lstlisting}
è¿™ä¸€ç±»å‹çš„\texttt{extern}åŠŸèƒ½ä¸éœ€è¦ä½¿ç”¨\texttt{unsafe}ã€‚

\subsection{Rustçš„æ¡ä»¶ç¼–è¯‘}\label{subsec:cond-compile}
Rusté€šè¿‡cfgå±æ€§ï¼Œå¯¹æ¡ä»¶ç¼–è¯‘æä¾›äº†æ”¯æŒã€‚è¿™äº›é…ç½®åœ¨Cargo.tomlä¸­æä¾›ï¼Œä¾‹å¦‚ï¼š

\begin{lstlisting}[numbers=left,language=Rust]
[features]
# no features by default
default = []

# The â€œsecure-passwordâ€ feature depends on the bcrypt package.
secure-password = ["bcrypt"]

# A feature with no dependencies is used mainly for conditional compilation, like `#[cfg(feature = "go-faster")]`.
go-faster = []
\end{lstlisting}

åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥é‡‡ç”¨cfgå±æ€§ä¿®é¥°å‡½æ•°ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
// This function is only included when compiling for a unixish OS with a 32-bit architecture
#[cfg(all(unix, target_pointer_width = "32"))]
fn on_32bit_unix() {
	// ...
}
\end{lstlisting}
ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç±»ä¼¼\texttt{\#\textbf{ifdef}}çš„æ–¹å¼è¿›è¡Œæ¡ä»¶ç¼–è¯‘ï¼š
\begin{lstlisting}[numbers=left,language=Rust]
let machine_kind = if cfg!(unix) {
	"unix"
} else if cfg!(windows) {
	"windows"
} else {
	"unknown"
};

println!("I'm running on a {} machine!", machine_kind);
\end{lstlisting}
\cite{bib:feasibility-e}

\subsection{RISC-V ISA}\sectionauthor{å´éªä¸œ}\vspace*{-4ex}
\subsubsection{ç‰¹æƒç‰¹æƒæ¨¡å‹}
åœ¨ç¼–å†™unikernelæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç‰¹æƒæŒ‡ä»¤å¤„ç†å¤–è®¾ä¸­æ–­ã€æ§åˆ¶æœºå™¨çŠ¶æ€ï¼Œ
å› æ­¤éœ€è¦äº†è§£RISC-Vçš„ç‰¹æƒæ¨¡å‹ã€‚

æˆªè‡³ç›®å‰(2022.4)ï¼ŒRISC-V å…±å®šä¹‰äº†å››ä¸ªç‰¹æƒçº§åˆ«ï¼Œç”±é«˜åˆ°ä½æ’åˆ—é¡ºæ¬¡ä¸ºï¼š

\begin{description}
\item[æœºå™¨çº§åˆ«ï¼ˆMï¼‰] RISC-Vä¸­ç¡¬ä»¶çº¿ç¨‹å¯ä»¥æ‰§è¡Œçš„æœ€é«˜æƒé™æ¨¡å¼ã€‚
åœ¨Mæ¨¡å¼ä¸‹è¿è¡Œçš„ hart å¯¹å†…å­˜ã€I/O å’Œä¸€äº›å¯¹äºå¯åŠ¨å’Œé…ç½®ç³»ç»Ÿæ¥è¯´å¿…è¦çš„åº•å±‚
åŠŸèƒ½æœ‰ç€å®Œå…¨çš„ä½¿ç”¨æƒã€‚å› æ­¤å®ƒæ˜¯å”¯ä¸€æ‰€æœ‰æ ‡å‡† RISC-V å¤„ç†å™¨éƒ½å¿…é¡»å®ç°çš„æƒé™æ¨¡å¼ã€‚\cite{bib:feasibility-a}
\item[è¶…çº§ç›‘ç®¡è€…çº§åˆ«ï¼ˆHï¼‰] ä¸ºäº†æ”¯æŒè™šæ‹Ÿæœºç›‘è§†å™¨ã€‚ä½†ç›®å‰è¯¥çº§åˆ«å¹¶æ²¡æœ‰è¢«æ­£å¼åŠ å…¥åˆ°æ–‡æ¡£ä¸­ã€‚
\item[ç›‘ç®¡è€…çº§åˆ«ï¼ˆSï¼‰] ä¸ºäº†æ”¯æŒç°ä»£æ“ä½œç³»ç»Ÿï¼Œå¦‚ Linuxï¼ŒFreeBSD å’Œ Windows ã€‚
\item[ç”¨æˆ·çº§åˆ«ï¼ˆUï¼‰] ç”¨äºè¿è¡Œåº”ç”¨ç¨‹åºï¼Œé€‚ç”¨äºå®‰å…¨åµŒå…¥å¼ç³»ç»Ÿã€‚
\end{description}

æ ‡å‡†çš„ RISC-V ä¸ºè¶…è¿‡4000ä¸ª CSR é¢„ç•™äº†12ä½çš„ç¼–ç ç©ºé—´(\texttt{[11ï¼š0]})ã€‚
å…¶ä¸­ï¼Œ\texttt{[11ï¼š8]} ä½æ ¹æ®ç‰¹æƒçº§åˆ«å¯¹ CSR çš„è¯»å†™æƒé™è¿›è¡Œç¼–ç ã€‚
æ³¨æ„ï¼šä»»ä½•è¯•å›¾è®¿é—®ä¸å­˜åœ¨çš„ CSR çš„è¡Œä¸ºå‡ä¼šå¼•å‘æŒ‡ä»¤å¼‚å¸¸ï¼Œå°è¯•å†™å…¥åªè¯»å¯„å­˜å™¨ä¹Ÿä¼šå¼•å‘æŒ‡ä»¤å¼‚å¸¸ã€‚
å‰©ä½™çš„8ä½ç¼–ç  \texttt{[7:0]} å°†æŒ‡å®šç›¸åº”çš„å¯„å­˜å™¨åœ°å€ä½ç½®ã€‚å…·ä½“ç»†èŠ‚å¦‚ä¸‹æ‰€ç¤ºï¼š\cite{bib:feasibility-b}\cite{bib:feasibility-c}

\begin{lstlisting}[numbers=left]
CSR [11:10]ï¼šå¯¹è¯»å†™æ¨¡å¼è¿›è¡Œçº¦æŸ
00		read/write
01		read/write
10		read/write
11		read-only
CSR [9:8]ï¼šå¯¹è®¿é—®æœ€ä½æƒé™è¿›è¡Œçº¦æŸ
00		Unprivileged and User-Level CSRs
01		Supervisor-Level CSRs
10		Hypervisor and VS CSRs
11		Machine-Level CSRs
\end{lstlisting}


ç›®å‰ RISC-V æ”¯æŒçš„ç‰¹æƒæŒ‡ä»¤æ ¼å¼ä¸ºï¼š
{
    \small
    \newcommand{\instbit}[1]{\mbox{\scriptsize #1}}
    \newcommand{\instbitrange}[2]{~\instbit{#1} \hfill \instbit{#2}~}
    %\centering

    \begin{longtable}{p{0in}p{0.4in}p{0.05in}p{0.05in}p{0.05in}p{0.05in}p{0.4in}p{0.6in}p{0.4in}p{0.6in}p{0.7in}l}
    \caption{RISC-V ç‰¹æƒæŒ‡ä»¤}\\
    &
    \multicolumn{1}{l}{\instbit{31}} &
    \multicolumn{1}{r}{\instbit{27}} &
    \instbit{26} &
    \instbit{25} &
    \multicolumn{1}{l}{\instbit{24}} &
    \multicolumn{1}{r}{\instbit{20}} &
    \instbitrange{19}{15} &
    \instbitrange{14}{12} &
    \instbitrange{11}{7} &
    \instbitrange{6}{0} \\
    \cline{2-11}
    \endfirsthead
    &
    \multicolumn{1}{l}{\instbit{31}} &
    \multicolumn{1}{r}{\instbit{27}} &
    \instbit{26} &
    \instbit{25} &
    \multicolumn{1}{l}{\instbit{24}} &
    \multicolumn{1}{r}{\instbit{20}} &
    \instbitrange{19}{15} &
    \instbitrange{14}{12} &
    \instbitrange{11}{7} &
    \instbitrange{6}{0} \\
    \cline{2-11}
    \endhead

    &
    \multicolumn{4}{|c|}{funct7} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{funct3} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{opcode} & R-type \\
    \cline{2-11}


    &
    \multicolumn{6}{|c|}{imm[11:0]} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{funct3} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{opcode} & I-type \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Trap-Return Instructions} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001000} &
    \multicolumn{2}{c|}{00010} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SRET \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0011000} &
    \multicolumn{2}{c|}{00010} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & MRET \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Interrupt-Management Instructions} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001000} &
    \multicolumn{2}{c|}{00101} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & WFI \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Supervisor Memory-Management Instructions} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.VMA \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Memory-Management Instructions} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0010001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HFENCE.VVMA \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HFENCE.GVMA \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Virtual-Machine Load and Store Instructions} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110000} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.B \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110000} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.BU \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.H \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.HU \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.W \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110010} &
    \multicolumn{2}{c|}{00011} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLVX.HU \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00011} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLVX.WU \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110001} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.B \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.H \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110101} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.W \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf Hypervisor Virtual-Machine Load and Store Instructions, RV64 only} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110100} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.WU \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110110} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{rd} &
    \multicolumn{1}{c|}{1110011} & HLV.D \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110111} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{100} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HSV.D \\
    \cline{2-11}


    &
    \multicolumn{10}{c}{} & \\
    &
    \multicolumn{10}{c}{\bf \emph{Svinval} Memory-Management Extension} & \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SINVAL.VMA \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001100} &
    \multicolumn{2}{c|}{00000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.W.INVAL \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0001100} &
    \multicolumn{2}{c|}{00001} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & SFENCE.INVAL.IR \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0010011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HINVAL.VVMA \\
    \cline{2-11}


    &
    \multicolumn{4}{|c|}{0110011} &
    \multicolumn{2}{c|}{rs2} &
    \multicolumn{1}{c|}{rs1} &
    \multicolumn{1}{c|}{000} &
    \multicolumn{1}{c|}{00000} &
    \multicolumn{1}{c|}{1110011} & HINVAL.GVMA \\
    \cline{2-11}


    \end{longtable}
}

ä»¥ CSR è®¿å­˜æŒ‡ä»¤ä¸ºä¾‹ã€‚å…¶æ ‡å‡†æ ¼å¼ä¸ºï¼š
\begin{table}[H]
    \centering
    \caption{çŠ¶æ€æ§åˆ¶å¯„å­˜å™¨ï¼ˆCSRï¼‰}
    \begin{tabular}{|r|c|>{\ttfamily}l>{\ttfamily}l|}
        \hline
        è¯»/å†™&I&CSRRW&rd,csr,rs1\\
        è¯»\&è®¾ç½®ä½&I&CSRRS&rd,csr,rs1\\
        è¯»\&æ¸…é™¤ä½&I&CSRRC&rd,csr,rs1\\
        è¯»/å†™\ ç«‹å³æ•°&I&CSRRWI&rd,csr,imm\\
        è¯»\&è®¾ç½®ä½\ ç«‹å³æ•°&I&CSRRSI&rd,csr,imm\\
        è¯»\&æ¸…é™¤ä½\ ç«‹å³æ•°&I&CSRRCI&rd,csr,imm\\\hline
    \end{tabular}
\end{table}

é™¤ç›®å‰ RISC-V æ”¯æŒçš„ç‰¹æƒæŒ‡ä»¤æ ¼å¼å¤–ï¼Œ\texttt{ecall}æŒ‡ä»¤ç”¨äºç³»ç»Ÿè°ƒç”¨ã€‚

\subsubsection{ç›‘ç®¡è€…äºŒè¿›åˆ¶æ¥å£}
ä¸ºäº†é™ä½Sæ¨¡å¼çš„ç¨‹åºåœ¨ä¸åŒRISC-Vçš„è®¾å¤‡ä¹‹é—´çš„ç§»æ¤éš¾åº¦ï¼Œ
RISC-Vå¼•å…¥äº†ç›‘ç®¡è€…äºŒè¿›åˆ¶æ¥å£ï¼ˆ\textbf{S}upervisor \textbf{B}inary \textbf{I}nterfaceï¼‰ã€‚
å®ƒåœ¨Mæ¨¡å¼è¿è¡Œï¼Œä¸ºè¿è¡Œåœ¨Sæ¨¡å¼ä¸‹çš„æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›ç¡¬ä»¶æŠ½è±¡ã€‚

ä¸Uæ¨¡å¼çš„ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨é™·å…¥Sæ¨¡å¼ç±»ä¼¼ï¼ŒSæ¨¡å¼çš„ç³»ç»Ÿå†…æ ¸ä¹Ÿå¯ä»¥ç”¨SBIè°ƒç”¨é™·å…¥Mæ¨¡å¼ï¼Œ
ä»¥ä½¿ç”¨SBIæä¾›çš„æœåŠ¡ã€‚

\begin{figure}[tbh!]
\centering
\includegraphics[width=0.7\linewidth]{assets/riscv-sbi-intro1.png}
\caption{ä¸å«Hæ‹“å±•çš„RISC-Vç³»ç»Ÿ}
\label{fig:riscv-sbi}
\end{figure}

å¦‚ä¸‹ä¸º\texttt{arch/riscv/kernel/sbi.c}ä¸­çš„éƒ¨åˆ†ä»£ç ï¼Œä½¿ç”¨\texttt{ecall}æŒ‡ä»¤æ—¶ï¼Œ
å°†EIDå†™åœ¨\texttt{a7} å¯„å­˜å™¨ï¼ŒFIDå†™åœ¨\texttt{a6}å¯„å­˜å™¨ï¼Œå‚æ•°å†™åœ¨ \texttt{a0}-\texttt{a5} å¯„å­˜å™¨ï¼Œ
åé¢ä¼šæ ¹æ®EIDå’ŒFIDçš„ä¸åŒè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ã€‚
\begin{lstlisting}[language=C,numbers=left]
struct sbiret sbi_ecall(int ext, int fid, unsigned long arg0,
unsigned long arg1, unsigned long arg2,
unsigned long arg3, unsigned long arg4,
unsigned long arg5)
{
	struct sbiret ret;

	register uintptr_t a0 asm ("a0") = (uintptr_t)(arg0);
	register uintptr_t a1 asm ("a1") = (uintptr_t)(arg1);
	register uintptr_t a2 asm ("a2") = (uintptr_t)(arg2);
	register uintptr_t a3 asm ("a3") = (uintptr_t)(arg3);
	register uintptr_t a4 asm ("a4") = (uintptr_t)(arg4);
	register uintptr_t a5 asm ("a5") = (uintptr_t)(arg5);
	register uintptr_t a6 asm ("a6") = (uintptr_t)(fid);
	register uintptr_t a7 asm ("a7") = (uintptr_t)(ext);
	asm volatile ("ecall"
	: "+r" (a0), "+r" (a1)
	: "r" (a2), "r" (a3), "r" (a4), "r" (a5), "r" (a6), "r" (a7)
	: "memory");
	ret.error = a0;
	ret.value = a1;

	return ret;
}
\end{lstlisting}â€‹

ä¾‹å¦‚å¯ä»¥ç”¨å¦‚ä¸‹ç¨‹åºå®ç°ä¸€ä¸ªæ‰“å°ä¸€ä¸ªå­—ç¬¦åˆ°ç³»ç»Ÿæ§åˆ¶å°ä¸Šçš„\texttt{putchar}å‡½æ•°ï¼š
\begin{lstlisting}[language=C]
    void sbi_console_putchar(int ch)
    {
    	sbi_ecall(SBI_EXT_0_1_CONSOLE_PUTCHAR, 0, ch, 0, 0, 0, 0, 0);
    }
\end{lstlisting}

ç”¨SBIå¯ä»¥é™ä½å¼€å‘ç³»ç»Ÿçš„éš¾åº¦ï¼Œä½†æ˜¯ä¼šå¼•å…¥\texttt{ecall}æŒ‡ä»¤ï¼Œè€Œunikernelçš„é«˜æ•ˆæ­£æ˜¯
ä¾é é¿å…\texttt{ecall}å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¼šåœ¨å‰æœŸä½¿ç”¨SBIæä¾›çš„æœåŠ¡ï¼ŒåæœŸä¼šç”¨è‡ªå·±ç¼–å†™
çš„virtioé©±åŠ¨ç¨‹åºä»£æ›¿SBIã€‚


\subsubsection{KVMå¯¹RISC-Væ¶æ„çš„æ”¯æŒ}
KVM (Kernel-based Virtual Machineï¼ŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº)  ï¼Œæ˜¯ä¸€ç§å†…å»ºäº Linux ä¸­çš„
å¼€æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å…·ä½“è€Œè¨€ï¼ŒKVM å¯ä»¥å°† Linux è½¬å˜ä¸ºè™šæ‹Ÿç›‘æ§ç¨‹åºï¼Œä»è€Œä½¿ä¸»æœºè®¡ç®—æœºèƒ½å¤Ÿè¿è¡Œ
å¤šä¸ªéš”ç¦»çš„è™šæ‹Ÿç¯å¢ƒï¼Œå³è™šæ‹Ÿå®¢æˆ·æœºæˆ–è™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚
\begin{figure}[!hbt]
	\centering
	\includegraphics[width=0.9\linewidth]{assets/riscv-sbi-intro2.png}
	\caption{è™šæ‹ŸåŒ–ä¸‹çš„ç‰¹æƒç­‰çº§}
	\label{fig:w4}
\end{figure}

å¦‚å›¾\ref{fig:w4}ï¼Œä¸ºäº†æ”¯æŒè™šæ‹ŸåŒ–ï¼ŒRISC-V è§„èŒƒå®šä¹‰äº† RISC-V H-extension ï¼Œåœ¨åŸæ¥çš„3çº§
ç‰¹æƒæ¶æ„çš„åŸºç¡€ä¸Šå¯¹åŸæœ‰çš„ Supervisor æ¨¡å¼è¿›è¡Œäº†æ‰©å±•ï¼Œå¼•å…¥äº† Hypervisor-Extended Supervisor mode(HS)ã€‚
æ­¤æ—¶ï¼Œåœ¨ Machine Mode ä¸‹è¿è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„ã€å¯¹å…¨éƒ¨èµ„æºå…·å¤‡æ“ä½œèƒ½åŠ›çš„ Firmware ï¼Œè™šæ‹Ÿæœºè½¯ä»¶
Hypervisor è¿è¡Œåœ¨ HS æ¨¡å¼ï¼Œè™šæ‹Ÿæœº VM è¿è¡Œåœ¨è™šæ‹ŸåŒ–çš„ Supervisor æ¨¡å¼ï¼Œåº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œåœ¨
è™šæ‹Ÿæ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œè¿è¡Œåœ¨ Virtualized User modeã€‚

ä¸ºäº†å®ç° Supervisor ä¸ Hypervisor-extended supervisor æ¨¡å¼çš„åˆ‡æ¢ï¼ŒRSIC-V å°†åŸæ¥
Supervisor æ¨¡å¼ä¸‹çš„ CSR å¤åˆ¶ä¸€ä»½åˆ°Hypervisorï¼Œä»è€Œè®©æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹æ‹¥æœ‰ä¸¤ä»½ supervisor
å¯„å­˜å™¨ï¼ŒåŠ å¿«ä¸¤ä¸ªæ¨¡å¼ä¹‹é—´çš„åˆ‡æ¢è¿‡ç¨‹ã€‚

ç”±äº RISC-V æ²¡æœ‰ä¸ºä¸åŒè™šæ‹ŸåŒ–è½¯ä»¶è®¾è®¡ä¸“é—¨çš„ç‰¹æƒæ¨¡å¼ï¼Œè€Œæ˜¯è®¾è®¡äº†ç»Ÿä¸€çš„ç‰¹æƒæ¨¡å¼ï¼Œè¿™è¯´æ˜å®ƒå¯¹
1ç±»ï¼ˆå¦‚Xvisorï¼‰ã€ 2ç±»ï¼ˆå¦‚KVMï¼‰è™šæ‹ŸåŒ–è½¯ä»¶éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚ RISC-V å¯ä»¥é€šè¿‡ CSR å¯„å­˜å™¨æ³¨å…¥
ä¸­æ–­ï¼Œå› æ­¤ä¸éœ€è¦ä¸ºè™šæ‹ŸåŒ–è€Œç‰¹æ®Šè®¾è®¡ä¸­æ–­æ§åˆ¶å™¨å¤–è®¾ã€‚æ­¤å¤–ï¼ŒRISC-V å¯ç›´æ¥å€ŸåŠ©ç‰¹æ®Šçš„å¯„å­˜å™¨ä½æ”¯æŒ
åµŒå¥—è™šæ‹ŸåŒ–ï¼Œè€Œ Aarch64 è¦ç­‰åˆ° v8.3 ç‰ˆæœ¬ä¹‹åæ‰æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚RISC-V çš„æ—¶é’Ÿå’Œæ ¸é—´ä¸­æ–­å¯é€šè¿‡
SBI è½¯ä»¶è¾…åŠ©å®Œæˆï¼Œè€Œ Aarch64 éœ€è¦ç‰¹æ®Šè®¾è®¡çš„è®¡æ—¶å™¨å¤–è®¾æ¥æ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½ã€‚\cite{bib:feasibility-d}

\subsection{QEMU}\sectionauthor{å´éªä¸œ}

QEMUæ˜¯ä¸€æ¬¾é€šç”¨ã€å¼€æºçš„æœºå™¨æ¨¡æ‹Ÿå™¨å’Œè™šæ‹ŸåŒ–å™¨ã€‚

å½“ç”¨ä½œæœºå™¨æ¨¡æ‹Ÿå™¨æ—¶ï¼ŒQEMUå¯ä»¥æŠŠä¸€ä¸ªæœºå™¨ï¼ˆå¦‚ARM boardï¼‰çš„ç³»ç»Ÿæˆ–ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼ˆå¦‚ä½ çš„PCï¼‰ã€‚
å€ŸåŠ©åŠ¨æ€ç¿»è¯‘ï¼Œå®ƒè¾¾åˆ°äº†éå¸¸å¥½çš„æ€§èƒ½ã€‚

å½“ç”¨ä½œè™šæ‹ŸåŒ–å™¨æ—¶ï¼ŒQEMUé€šè¿‡ç›´æ¥åœ¨å®¿ä¸»æœºCPUä¸Šè¿è¡Œå®¢æˆ·æœºä»£ç ï¼Œè¾¾åˆ°äº†æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½ã€‚QEMUæ”¯æŒä¸¤ç§æ¨¡å¼
çš„è™šæ‹ŸåŒ–ï¼šåœ¨Xen hypervisorä¸‹æ‰§è¡Œï¼Œæˆ–è€…ä½¿ç”¨Linuxå†…æ ¸æ¨¡å—KVMã€‚å½“ä½¿ç”¨KVMæ—¶ï¼ŒQEMUå¯ä»¥è™šæ‹ŸåŒ–x86ã€
æœåŠ¡å™¨å’ŒåµŒå…¥PowerPCã€64ä½ POWERã€S390ã€32ä½å’Œ64ä½ARMã€RISC-V\cite{bib:qemu7}ä»¥åŠMIPSå®¢æˆ·æœºã€‚\cite{bib:feasibility-1}

\noindent QEMUå…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

\begin{description}
\item[å®Œæ•´ç³»ç»Ÿçš„æ¨¡æ‹Ÿ] Run operating systems for any machine, on any supported architecture.
\item[ç”¨æˆ·æ€çš„æ¨¡æ‹Ÿ] Run programs for another Linux/BSD target, on any supported architecture.
\item[è™šæ‹ŸåŒ–] Run KVM and Xen virtual machines with near native performance.\cite{bib:feasibility-1}
\end{description}

\subsection{Unikraftæ¶æ„åˆ†æ}\sectionauthor{å¼ å­è¾°}\vspace*{-4ex}
\subsubsection{ä»£ç é£æ ¼}\label{ssubsec:code-style}
Unikraftçš„ä»£ç ç»„ç»‡æ–¹å¼å……åˆ†ä½“ç°äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæ ¸å¿ƒä»£ç è¢«æ”¾åœ¨äº†\texttt{arch/}ã€\texttt{include/}å’Œ
\texttt{plat/}ä¸‰ä¸ªç›®å½•ä¸‹ï¼Œè€Œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰åŠŸèƒ½éƒ½ç”±ä½äº\texttt{lib/}ç›®å½•ä¸‹çš„micro-librariesæä¾›ã€‚
ä¸€ä¸ªmicro-libraryè¢«æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼š
\begin{itemize}
\item \texttt{include/}ï¼šmicro-libraryçš„APIï¼›
\item \texttt{Config.uk}ï¼šmenu-configé…ç½®ï¼›
\item \texttt{exportsyms.uk}ï¼šå¯¼å‡ºçš„ç¬¦å·ï¼›
\item \texttt{Makefile.uk}ï¼šè‡ªåŠ¨æ„å»ºç³»ç»Ÿçš„é…ç½®ï¼›
\item \texttt{*.c}ï¼šmicro-libraryçš„å®ç°ã€‚
\item \texttt{extra.ld}ï¼šï¼ˆå¯é€‰ï¼‰é“¾æ¥å™¨é…ç½®ã€‚
\end{itemize}

æ¯”å¦‚ï¼Œ\texttt{uksched}çš„ç›®å½•ç»“æ„ï¼š
{\linespread{1}
\begin{verbatim}
    uksched
    â”œâ”€â”€ Config.uk
    â”œâ”€â”€ exportsyms.uk
    â”œâ”€â”€ extra.ld
    â”œâ”€â”€ include
    â”‚Â Â  â””â”€â”€ uk
    â”‚Â Â      â”œâ”€â”€ sched.h
    â”‚Â Â      â”œâ”€â”€ thread_attr.h
    â”‚Â Â      â”œâ”€â”€ thread.h
    â”‚Â Â      â”œâ”€â”€ wait.h
    â”‚Â Â      â””â”€â”€ wait_types.h
    â”œâ”€â”€ Makefile.uk
    â”œâ”€â”€ sched.c
    â”œâ”€â”€ thread_attr.c
    â””â”€â”€ thread.c
\end{verbatim}}

Unikraftç”¨UNIXå‘½åé£æ ¼ï¼Œå‡½æ•°åå’Œç»“æ„ä½“
ä»¥\texttt{uk\_\hspace{0cm}\textit{<micro-library\hspace{0cm}å\hspace{0cm}>}\hspace{0cm}\_}
å¼€å¤´ï¼Œç»“æ„ä½“åå\textit{é€šå¸¸}é™„åŠ \texttt{\_t}ï¼Œ
æ¯”å¦‚\texttt{uk\_malloc}ã€\texttt{uk\_alloc\_malloc\_func\_t}ã€‚
Unikraftä½¿ç”¨é¢å‘å¯¹è±¡è®¾è®¡ï¼Œæ¯ä¸ªmicro-libraryä¸­é€šå¸¸æœ‰ä¸åº“åŒåçš„ç»“æ„ä½“ï¼Œå¦‚\texttt{uk\_sched}ï¼Œ
åº“ä¸­çš„å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é€šå¸¸æ˜¯æ‰§è¡Œè¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå¦‚
\texttt{\textbf{struct} uk\_sched *uk\_sched\_create(\textbf{struct} uk\_alloc *a, \textbf{size\_t} prv\_size)}ã€‚

\subsubsection{ç¼–è¯‘è¿è¡Œæµç¨‹}
ä»¥ç¼–è¯‘\href{https://github.com/unikraft/app-helloworld}{hello worldç¨‹åº}ä¸ºä¾‹ï¼Œä»‹ç»ç¼–è¯‘å¹¶
è¿è¡ŒåŸºäºUnikraftçš„unikernelçš„æµç¨‹ã€‚

é¦–å…ˆè¦ä¿®æ”¹\texttt{Makefile}ï¼ŒæŠŠ\texttt{UK\_ROOT}æ”¹ä¸ºunikraftæºä»£ç çš„ç›®å½•ï¼Œæ¯”å¦‚
\texttt{UK\_ROOT ?= \linebreak\$(PWD)/../unikraft}ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸ä¿®æ”¹\texttt{Makefile}è€Œä¿®æ”¹
å‘½ä»¤è¡Œå‚æ•°ã€‚

ç”¨\texttt{make menuconfig}é…ç½®ï¼Œç„¶åç”¨\texttt{make}ç¼–è¯‘ã€‚
\begin{figure}[!hbt]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/unikraft-menuconfig}
\vspace*{-3ex}
\caption{é…ç½®Unikraft}
\label{fig:unikraft-menuconfig}
\end{figure}
Hello worldç¨‹åºä¸Unikraftçš„å„ä¸ªè¢«ä½¿ç”¨çš„micro-librarieså…ˆè¢«åˆ†åˆ«ç¼–è¯‘æˆäº†\texttt{.o}æ–‡ä»¶ï¼Œ
å†é“¾æ¥æˆä¸€ä¸ªunikernelé•œåƒã€‚ä¸€å…±ç”Ÿæˆäº†\texttt{libkvmplat}ã€\texttt{libkvmpci}ã€\texttt{libkvmvirtio}ã€
\texttt{apphelloworld}ã€\texttt{libnolibc}ã€\texttt{libukalloc}ã€\texttt{libukallocbbuddy}ã€
\texttt{libukargparse}ã€\texttt{libukboot}ã€\texttt{libukbus}ã€\texttt{libukdebug}ã€
\texttt{libuksglist}ã€\texttt{libuktime}ã€\texttt{libuktimeconv}å’Œ\texttt{libx86\_64arch}ç­‰ä¸­é—´æ–‡ä»¶ã€‚
æœ€åçš„è¾“å‡ºæ˜¯18.0KiBå¤§çš„\texttt{app-\linebreak helloworld\_kvm-x86\_64.gz}ã€‚

è¯¦ç»†çš„ç¼–è¯‘æ—¥å¿—ä½äºæˆ‘ä»¬çš„ä»“åº“çš„\href{https://github.com/OSH-2022/x-runikraft/tree/d22ccf0c1b248667148fd8953b71b6e0258de6a3/reference/Unikraft%20helloworld}{reference/Unikraft helloworld/}ç›®å½•ã€‚

ç”¨\texttt{qemu-system-x86\_64 -kernel build/app-helloworld\_kvm-x86\_64 -nographic}\linebreak è¿è¡Œhello worldç¨‹åºã€‚

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/unikraft-run}
\vspace*{-3ex}
\caption{è¿è¡Œhello world}
\label{fig:unikraft-run}
\end{figure}


\subsubsection[å¼€æœºæµç¨‹]{å¼€æœºæµç¨‹ï¼ˆKVM+AMD64ï¼‰}
\begin{enumerate}
\item bootloaderï¼ˆç”±è™šæ‹Ÿæœºçš„å›ºä»¶å®ç°ï¼‰ã€‚
\item \texttt{\_libkvmplat\_start32}ï¼ˆä½äº\texttt{plat/kvm/x86/entry64.S}ï¼‰ï¼š
    \begin{enumerate}
    \item enable paeï¼›
    \item enable long modeï¼›
    \item load pml4 pointerï¼›
    \item enable pagingï¼›
    \item \texttt{jmp \_libkvmplat\_start64}ã€‚
    \end{enumerate}
\item \texttt{\_libkvmplat\_start64}ï¼š
    \begin{enumerate}
    \item ä¸€ç³»åˆ—å¤æ‚çš„åˆå§‹åŒ–ï¼›
    \item \texttt{call \_libkvmplat\_entry}ã€‚
    \end{enumerate}
\item \texttt{\_libkvmplat\_entry}ï¼ˆä½äº\texttt{plat/kvm/x86/setup.c}ï¼‰ï¼Œ
å®ƒæ¥å—\texttt{struct multiboot\_info*}å‚æ•°ï¼š
    \begin{enumerate}
    \item \texttt{\_init\_cpufeatures}ï¼›
    \item \texttt{\_libkvmplat\_init\_console}ï¼›
    \item \texttt{traps\_init}ï¼›
    \item \texttt{intctrl\_init}ï¼›
    \item \texttt{\_mb\_get\_cmdline}ï¼šæŠŠmultiboot\_infoä¸­çš„å‘½ä»¤è¡Œå‚æ•°å¤åˆ¶åˆ°æ•°æ®æ®µ
    çš„\texttt{char\linebreak cmdline[8192]}ï¼›
    \item \texttt{\_mb\_init\_mem}ï¼šå¤„ç†ä¸å†…å­˜åˆ†æ®µæœ‰å…³çš„æ“ä½œï¼›
    \item \texttt{\_mb\_init\_initrd`}ï¼›
    \item (\texttt{CONFIG\_HAVE\_SMP})\footnote{è¡¨ç¤ºåœ¨å¼€å¯æŸä¸ªé…ç½®æ—¶æ‰§è¡Œã€‚} \texttt{acpi\_init}ï¼›
    \item (\texttt{CONFIG\_HAVE\_SYSCALL}) \texttt{\_init\_syscall}ï¼›
    \item (\texttt{CONFIG\_HAVE\_X86PKU}) \texttt{\_check\_ospke}ï¼›
    è°ƒç”¨\texttt{\_libkvmplat\_newstack}ä»å¼•å¯¼æ ˆåˆ‡æ¢èµ°ã€‚
    \end{enumerate}
    å¯ä»¥çœ‹å‡ºï¼ŒAMD64çš„å¼€æœºæµç¨‹å¾ˆå¤æ‚ï¼Œåœ¨ARMv8ä¸­ï¼Œç³»ç»Ÿçš„èµ·ç‚¹æ˜¯ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™
    çš„\texttt{\_libkvmplat\_entry}ï¼Œå®ƒè°ƒç”¨ç”¨Cè¯­è¨€ç¼–å†™çš„\texttt{\_libkvmplat\_start}ï¼Œ
    ä¹‹åçš„æµç¨‹ä¸AMD64ç›¸åŒã€‚
\item \texttt{\_libkvmplat\_entry2}ï¼šæŠŠcmdlineä¼ é€’ç»™\texttt{ukplat\_entry\_argp}ã€‚
\item \texttt{ukplat\_entry\_argp}ï¼šæŠŠå‘½ä»¤è¡Œå‚æ•°æ‹†æˆargc+argvçš„å½¢å¼ï¼Œç„¶åè°ƒç”¨\texttt{ukplat\_entry}ã€‚
\item \texttt{ukplat\_entry}ï¼š
    \begin{enumerate}
    \item è°ƒç”¨\texttt{ctorfn}æ³¨å†Œçš„æ„é€ å‡½æ•°ï¼ˆ\texttt{ctors.h}æä¾›äº†æ³¨å†Œæ„é€ å‡½æ•°çš„æœºåˆ¶ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKLIBPARAM})è¿›ä¸€æ­¥åˆ†æå‘½ä»¤è¡Œå‚æ•°ï¼›
    \item (\texttt{!CONFIG\_LIBUKBOOT\_NOALLOC}) ä¾æ¬¡å°è¯•åœ¨æ¯ä¸€å—å†…å­˜åŒºåŸŸä¸Šåˆå§‹åŒ–
    åˆ†é…å™¨\linebreakï¼ˆ\texttt{uk\_<name>\_init}ï¼‰ï¼Œ
    æˆåŠŸåˆ›å»ºåˆ†é…å™¨åï¼Œå°†å‰©ä½™çš„å†…å­˜åŒºåŸŸåŠ å…¥åˆ†é…å™¨\linebreakï¼ˆ\texttt{uk\_alloc\_addmem}ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKALLOC}) åˆå§‹åŒ–ä¸­æ–­ï¼ˆ\texttt{ukplat\_irq\_init}ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKSCHED}) åˆå§‹åŒ–è°ƒåº¦å™¨\texttt{uk\_sched\_default\_init}ï¼›
    \item (\texttt{CONFIG\_LIBUKSCHED}?)
        \begin{itemize}
        \item (true)  åˆ›å»ºä¸»çº¿ç¨‹ï¼ˆæ‰§è¡Œ\texttt{main\_thread\_func}ï¼‰â†’å¯åŠ¨è°ƒåº¦å™¨ï¼ˆ\texttt{uk\_sched\_start}ï¼‰ï¼Œ
        \item (false) å¯åŠ¨ä¸­æ–­ï¼ˆ\texttt{ukplat\_lcpu\_enable\_irq}ï¼‰â†’ç›´æ¥è°ƒç”¨\texttt{main\_thread\_func}ã€‚
        \end{itemize}
    \end{enumerate}
\item \texttt{main\_thread\_func}ï¼š
    \begin{enumerate}
    \item è°ƒç”¨init tableä¸Šæ³¨å†Œçš„å‡½æ•°ï¼ˆç”±\texttt{init.h}æä¾›ï¼Œä¸\texttt{ctorfn}ç±»ä¼¼ï¼‰ï¼›
    \item (\texttt{CONFIG\_LIBUKSP})\texttt{uk\_stack\_chk\_guard\_setup}ï¼›
    \item è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„æ„é€ å‡½æ•° \texttt{\_\_preinit\_array}å’Œ\texttt{\_\_init\_array}ï¼›
    \item è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„\texttt{main}ã€‚
    \end{enumerate}
\item \texttt{main}ã€‚
\item å…³æœº/å´©æºƒã€‚
\end{enumerate}

\subsubsection{åˆ†é…å™¨}
åˆ†é…å™¨çš„APIä½äº\texttt{ukalloc}ï¼Œå¯é€‰çš„å®ç°æœ‰\texttt{ukallocbbuddy}ã€\texttt{ukallocpool}ã€
\texttt{ukallocregion}ã€‚\texttt{ukalloc}ç”¨å‡½æ•°æŒ‡é’ˆå®ç°äº†ç±»ä¼¼C++çš„è™šå‡½æ•°çš„è¿è¡Œæ—¶ç»‘å®šï¼Œå…¶ä»–çš„
Unikraft æ¥å£micro-librariesä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„æŠ€æœ¯ã€‚\texttt{\textbf{struct} uk\_alloc}ä¿å­˜
\texttt{malloc}ã€\texttt{free}ç­‰æŒ‡å‘å®ç°çš„å‡½æ•°æŒ‡é’ˆï¼Œ\texttt{uk\_malloc}ç­‰æ¥å£å‡½æ•°
æ¥å—\texttt{uk\_alloc}å‹æŒ‡é’ˆ\texttt{a}ï¼Œå°†å‚æ•°è½¬å‘ç»™\texttt{a}çš„å‡½æ•°æŒ‡é’ˆã€‚æ¯”å¦‚ï¼Œ\texttt{malloc}çš„
å®ç°ï¼š
\begin{lstlisting}[language=C]
static inline void *uk_do_malloc(struct uk_alloc *a, __sz size)
{
	UK_ASSERT(a);
	return a->malloc(a, size);
}

static inline void *uk_malloc(struct uk_alloc *a, __sz size)
{
	if (unlikely(!a)) {
		errno = ENOMEM;
		return __NULL;
	}
	return uk_do_malloc(a, size);
}
\end{lstlisting}

å…·ä½“çš„å®ç°è´Ÿè´£åˆå§‹åŒ–\texttt{uk\_alloc}å˜é‡ï¼Œæ¯”å¦‚\texttt{ukbbuddy}å®ç°äº†ä¼™ä¼´åˆ†é…å™¨ï¼Œå®ƒæä¾›çš„
\texttt{struct uk\_alloc *uk\_allocbbuddy\_init(void *base, size\_t len)}å‡½æ•°ä¼šæŠŠ
è‡ªå·±çš„å®ç°ç»‘å®šåˆ°\texttt{uk\_alloc}ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚

\subsubsection{è°ƒåº¦å™¨}
è°ƒåº¦å™¨APIä½äº\texttt{uksched}ï¼Œå®ƒä¸»è¦åŒ…æ‹¬\texttt{sched}å’Œ\texttt{thread}ä¸¤ä¸ªå­æ¨¡å—ã€‚

\texttt{thread}æ—¢æ˜¯æ¥å£åˆæ˜¯å®ç°ï¼Œå®ƒæä¾›é’ˆå¯¹å•ä¸ªçº¿ç¨‹çš„æ“ä½œï¼Œ
å…¶ä¸­çš„\texttt{\textbf{struct} uk\_thread}ä¿å­˜çº¿ç¨‹æ§åˆ¶å—ï¼Œ
\texttt{uk\_thread\_set\_timeslice}å‡½æ•°è®¾ç½®çº¿ç¨‹æ—¶é—´ç‰‡ï¼Œ\texttt{uk\_thread\_wake}
å‡½æ•°å”¤é†’çº¿ç¨‹ï¼Œæ ¹æ®çº¿ç¨‹çš„æ—¶é—´ç‰‡è®¾ç½®å®šæ—¶å™¨ï¼Œç„¶åæŠŠæ§åˆ¶æƒè½¬äº¤ç»™è¿™ä¸ªçº¿ç¨‹ï¼Œè¿™äº›æ“ä½œéœ€è¦è°ƒç”¨\texttt{ukplat}
çš„APIã€‚

\texttt{sched}æ˜¯åªæ˜¯æ¥å£ï¼Œå®ƒ
è´Ÿè´£ç®¡ç†æ‰€æœ‰çº¿ç¨‹ï¼Œå®ƒè°ƒç”¨\texttt{thread}çš„APIæ“ä½œå•ä¸ªçº¿ç¨‹ã€‚
\texttt{ukschedcoop}æ˜¯\texttt{uksched}çš„å®ç°ä¹‹ä¸€ï¼Œå®ƒå®ç°äº†æœ€åŸºæœ¬éæŠ¢å å¼çš„æ—¶é—´ç‰‡è½®è½¬çº¿ç¨‹è°ƒåº¦å™¨ã€‚
å®ƒä½¿ç”¨åŒé“¾å°¾é˜Ÿåˆ—ï¼ˆtail queueï¼‰ç»´æŠ¤æ‰€æœ‰çº¿ç¨‹ï¼ˆ\texttt{thread\_list}ï¼‰å’Œ
ç¡çœ çŠ¶æ€ï¼ˆå°±ç»ªæˆ–ç­‰å¾…ï¼‰çš„çº¿ç¨‹ï¼ˆ\texttt{sleeping\_threads}ï¼‰ã€‚
æ¯ä¸€è½®è°ƒåº¦ï¼Œ\texttt{ukschedcoop}ä»ç¡çœ çº¿ç¨‹é˜Ÿåˆ—
ä¸­æ‰¾å‡ºä¸€ä¸ªå¤„åœ¨å°±ç»ªæ€çš„çº¿ç¨‹ï¼Œå¹¶å”¤é†’ï¼ˆ\texttt{uk\_thread\_wake}ï¼‰è¿™ä¸ªçº¿ç¨‹ã€‚
å¦‚æœæ²¡æœ‰ä»»ä½•èƒ½æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå°±æŒ‚èµ·CPUï¼ˆ\texttt{ukplat\_lcpu\_halt\_to}ï¼‰ï¼Œ
ç›´åˆ°æŸä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œã€‚\texttt{ukschedcoop}å¹¶ä¸éœ€è¦ä¸ºæ¯ä¸€ä¸ªäº‹ä»¶ç»´æŠ¤ç­‰å¾…é˜Ÿåˆ—ï¼Œ
å› ä¸ºå³ä½¿çº¿ç¨‹ç­‰å¾…çš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œç”±äºå½“å‰çº¿ç¨‹çš„æ‰§è¡Œä¸èƒ½è¢«æŠ¢å ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¹Ÿä¸èƒ½è¢«ç«‹å³å”¤é†’ã€‚

Unikraftçš„è®ºæ–‡ä¸­æåˆ°äº†å®ƒæ‹¥æœ‰æŠ¢å å¼è°ƒåº¦å™¨\texttt{ukpreempt}ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨å®ƒçš„æºä»£ç ä¸­æ‰¾åˆ°ç›¸åº”çš„å®ç°ã€‚

\section{æŠ€æœ¯ä¾æ®}\sectionauthor{å¼ å­è¾°}\vspace*{-4ex}
\subsection{rustcäº¤å‰ç¼–è¯‘}
å…ˆå®‰è£…äº¤å‰ç¼–è¯‘riscv64gcçš„ç¼–è¯‘å™¨ç»„ä»¶ï¼Œ
ç„¶ååœ¨ç¼–è¯‘æ—¶é™„åŠ \texttt{--target riscv64gc-\linebreak unknown-none-elf}é€‰é¡¹å³å¯å®ç°x86-64--riscv64äº¤å‰ç¼–è¯‘ã€‚

è¿˜éœ€è¦å®‰è£…\texttt{rust-objcopy}ä»¥ç”ŸæˆQEMUèƒ½åŠ è½½çš„åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

\noindent å‘½ä»¤ï¼ˆå‡å®šå·²å®‰è£…é€šè¿‡rustupå®‰è£…Rustæ„å»ºå·¥å…·é“¾ï¼‰ï¼š
\begin{lstlisting}
rustup target add riscv64gc-unknown-none-elf
cargo install cargo-binutils
\end{lstlisting}

\subsection{å¯åŠ¨æ“ä½œç³»ç»Ÿ}
æ·»åŠ ç¼–è¯‘é€‰é¡¹\texttt{-Clink-arg=-Tlinker.ld}ä»¥ä¾¿é“¾æ¥å™¨èƒ½è¯»å–è‡ªå®šä¹‰çš„é“¾æ¥è„šæœ¬ï¼š
\begin{multicols}{2}
\begin{lstlisting}[numbers=left]
OUTPUT_ARCH(riscv)
ENTRY(__runikraft_start)
BASE_ADDRESS = 0x80200000;

SECTIONS
{
    . = BASE_ADDRESS;
    skernel = .;

    stext = .;
    .text : {
        *(.text.entry)
        *(.text .text.*)
    }

    . = ALIGN(4K);
    etext = .;
    srodata = .;
    .rodata : {
        *(.rodata .rodata.*)
        *(.srodata .srodata.*)
    }

    . = ALIGN(4K);
    erodata = .;
    sdata = .;
    .data : {
        *(.data .data.*)
        *(.sdata .sdata.*)
    }

    . = ALIGN(4K);
    edata = .;
    .bss : {
        *(.bss.stack)
        sbss = .;
        *(.bss .bss.*)
        *(.sbss .sbss.*)
    }

    . = ALIGN(4K);
    ebss = .;
    ekernel = .;

    /DISCARD/ : {
        *(.eh_frame)
    }
}
\end{lstlisting}
\end{multicols}

åˆå§‹åŒ–å‡½æ•°éœ€è¦ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ï¼š
\begin{lstlisting}[numbers=left]
.extern sbss
.extern ebss

.section .text.entry
.globl __runikraft_start

__runikraft_start:
    #æ¸…ç©ºbssæ®µ
    la t0,sbss
    la t1,ebss
    clean_bss:
        bge t0,t1,clean_bss_end
        sd x0,(t0)
        addi t0,t0,8
        j clean_bss
    clean_bss_end:
    addi t0,zero,0
    addi t1,zero,0
    #åŠ è½½æ ˆæŒ‡é’ˆ
    la sp,stack_top
    call __runikraft_entry_point

.section .bss.stack
    .space 65536
stack_top:
\end{lstlisting}
å®ƒåŠ è½½æ ˆæŒ‡é’ˆï¼Œç„¶åå°†æ§åˆ¶æƒè½¬äº¤ç»™ç”¨Rustå†™çš„æ›´é«˜å±‚çš„åˆå§‹åŒ–å‡½æ•°ã€‚ç›®å‰åè€…è¿˜åªæœ‰é›å½¢ï¼Œå®ƒåªåˆå§‹åŒ–\texttt{rk::plat}æ¨¡å—
çš„å®šæ—¶å™¨å­æ¨¡å—ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·ç¨‹åºçš„å…¥å£\texttt{main}ã€‚
\begin{lstlisting}[language=Rust,numbers=left]
/// ç³»ç»Ÿçš„å…¥å£ï¼Œç”±å¼•å¯¼ç¨‹åºè°ƒç”¨
///
#[no_mangle]
pub fn __runikraft_entry_point()->!{
    time::init();
    unsafe{main();}
    halt();
}
\end{lstlisting}

\texttt{\_\_runikraft\_entry\_point}å’Œ\texttt{\_\_runikraft\_start}éƒ½æ˜¯Runikraftæ ¸å¿ƒç»„ä»¶çš„
\texttt{plat::\linebreak bootstrap}çš„ä¸€éƒ¨åˆ†ï¼Œç›®å‰çš„æ ¸å¿ƒç»„ä»¶è¿˜å®ç°äº†\texttt{plat::console}å’Œ
\texttt{plat::time}ä¸¤ä¸ª\texttt{plat}æ¨¡å—çš„å­æ¨¡å—ï¼Œä»¥åŠ\texttt{bitcount}æ¨¡å—ï¼ˆè¿™ä¸ªæ¨¡å—å®Œå…¨æ˜¯
å¯¹Unikraftçš„\texttt{bitcount.c}çš„ç¿»è¯‘ï¼‰ã€‚ç›®å‰å·²ç»å®ç°äº†\texttt{rkalloc} APIï¼ˆå¯¹åº”Unikraftçš„
\texttt{ukalloc}ï¼Œè¿™ä¸ªAPIæœ‰ä¸€ä¸ªæ¼”ç¤ºç”¨çš„â€œç©ºå®ç°â€\texttt{rkalloc\_empty}ã€‚

ç›®å‰çš„\texttt{main}å‡½æ•°èƒ½ç®€å•æ¼”ç¤º\texttt{plat::console}ã€\texttt{plat::time}å’Œ\texttt{rkalloc}ï¼š
\begin{lstlisting}[language=Rust,numbers=left]
#![no_std]
#![no_main]

use runikraft as rk;

use rkalloc::Alloc;
use rkalloc_empty::RKallocEmpty;
use rk::plat::time;

static mut HEAP_SPACE: [u8;1000] = [0;1000];

#[no_mangle]
fn main() {
    let mut alloc;
    unsafe {
        alloc = RKallocEmpty::new(HEAP_SPACE.as_mut_ptr(),1000);
    }
    rk::println!("Hello, world!");
    let p1 = unsafe{alloc.malloc(10)};
    rk::println!("p1={:?}",p1);
    let p2 = unsafe{alloc.malloc(5)};
    rk::println!("p2={:?}",p2);
    rk::println!("sleep for 10s");
    let start = time::get_ticks();
    loop {
        if (time::get_ticks() - start).as_secs()>=10 {break;}
    }
    let end = time::get_ticks();
    rk::println!("slept for {:?}",end - start);
}
\end{lstlisting}

\subsection{ç¼–è¯‘}
ä¾æ¬¡è¿è¡Œ
\begin{lstlisting}
cargo build --release
rust-objcopy --strip-all build/riscv64gc-unknown-none-elf/release/dev-test -O binary build/riscv64gc-unknown-none-elf/release/dev-test.bin
\end{lstlisting}
å³å¯å®Œæˆç¼–è¯‘ã€‚

\subsection{è¿è¡Œå’Œè°ƒè¯•}
è¿™ä¸€æ­¥éœ€è¦QEMU \texttt{riscv64}ã€\texttt{riscv64-unknown-elf} GDBå’ŒOpenSBIçš„
\texttt{fw\_jump.bin}ã€‚QEMUå¯ä»¥ç”¨\texttt{sudo apt install qemu-system-misc}å®‰è£…ï¼Œ
å½“ç„¶ä¹Ÿå¯ä»¥ç”¨\texttt{sudo apt install qemu-system}å®Œæ•´åœ°å®‰è£…QEMUã€‚ç¬¦åˆè¦æ±‚çš„GDBå¹¶æ²¡æœ‰
è¢«æ”¶å½•åœ¨Ubuntuçš„è½¯ä»¶æºä¸­ï¼Œå¹¸å¥½SiFiveæä¾›äº†ä¸€å¥—é¢„ç¼–è¯‘çš„è°ƒè¯•å·¥å…·é“¾ï¼Œå…¶å¯åœ¨\
\href{https://github.com/sifive/freedom-tools/releases}{sifive/freedom-tools}\
ä¸‹è½½ã€‚ä¸‹è½½å¹¶è§£å‹åï¼Œå¯ä»¥å°†\texttt{riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86\_64-linux-ubuntu14/bin}æ·»åŠ åˆ°\texttt{PATH}ã€‚
QEMUçš„æ–‡æ¡£å£°ç§°å·²ç»é™„å¸¦äº†\texttt{OpenSBI}\cite{bib:qemu-virt}ï¼Œ
ä½†æ˜¯Ubuntu 20.04çš„APTæºä¸­çš„QEMUå¹¶æ²¡æœ‰é™„å¸¦ï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦åˆ°
\ \href{https://github.com/riscv-software-src/opensbi/releases/tag/v1.0}{OpenSBI Version 1.0}\
æ‰‹åŠ¨ä¸‹è½½ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯\linebreak\texttt{opensbi-1.0-rv-bin/share/opensbi/lp64/generic/firmware/fw\_jump.bin}ã€‚
ä¸ºäº†æ–¹ä¾¿åç»­ä½¿ç”¨ï¼Œå¯ä»¥åœ¨\texttt{\tildechar/.bashrc}ä¸­åŠ ä¸Š\texttt{export RISCV\_BIOS=\textit{<PATH\_TO\_fw\_jump.bin>}}ã€‚

ä¸€åˆ‡å®‰è£…å®Œæ¯•åï¼Œå¯ä»¥ç”¨
\begin{lstlisting}
qemu-system-riscv64 -machine virt -nographic -bios $RISCV_BIOS -device loader,file=build/riscv64gc-unknown-none-elf/release/dev-test.bin,addr=0x80200000 -s -S
\end{lstlisting}
å¯åŠ¨ç³»ç»Ÿã€‚ç”¨
\begin{lstlisting}
riscv64-unknown-elf-gdb -ex 'file build/riscv64gc-unknown-none-elf/release/dev-test' -ex 'set arch riscv:rv64' -ex 'target remote localhost:1234'
\end{lstlisting}
è¿›è¡Œäº¤äº’å¼è°ƒè¯•ã€‚

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/debug.png}
\vspace*{-3ex}
\caption{è°ƒè¯•}
\label{fig:debug}
\end{figure}

\begin{figure}[tbh!]
\centering
\vspace*{-3ex}
\includegraphics[width=0.9\linewidth]{assets/run.png}
\vspace*{-3ex}
\caption{è¿è¡Œç»“æœ}
\label{fig:run}
\end{figure}

\begin{comment}

\subsection{Unikernel}
Unikernelæ˜¯ä¸“ä¸€ç”¨é€”çš„ã€å•åœ°å€ç©ºé—´çš„è½»é‡æ“ä½œç³»ç»Ÿã€‚Unikernelsåœ¨è™šæ‹Ÿæœº
ä¸Šè¿è¡Œæ—¶ï¼Œèƒ½å¤Ÿæä¾›æ¯”ä¼ ç»Ÿçš„å®¹å™¨æ›´çŸ­çš„å¯åŠ¨æ—¶é—´ã€æ›´é«˜çš„è¿è¡Œæ•ˆç‡å’Œæ›´å¼ºçš„
éš”ç¦»æ€§ï¼Œå› rnæ­¤unikeelsé€šå¸¸è¢«ç”¨åœ¨äº‘è®¡ç®—é¢†åŸŸã€‚\cite{bib:unikernel}


\noindent ç°æœ‰çš„unikernelsæ™®éå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\cite{bib:unikraft}
\begin{itemize}
\item ç¼–è¯‘å®ƒä»¬å¹¶è®©å®ƒä»¬è¾¾åˆ°é«˜æ•ˆç‡éœ€è¦å¤§é‡ä¸“ä¸šçš„å·¥ä½œï¼Œè€Œä¸”è¿™äº›å·¥ä½œé€šå¸¸
éœ€è¦å¯¹æ¯ä¸ªç›®æ ‡åº”ç”¨ç¨‹åºé‡åšã€‚
\item å®ƒä»¬é€šå¸¸ä¸æ˜¯POSIXå…¼å®¹çš„ï¼Œéœ€è¦ç§»æ¤ç¨‹åºå’Œè¯­è¨€ç¯å¢ƒã€‚
\end{itemize}

\ref{subsec:famous-unikernel-projects}\ å°èŠ‚å°†ç®€è¦ä»‹ç»æˆ‘ä»¬å°ç»„è¯¦ç»†è°ƒç ”çš„ClickOSã€MirageOSã€IncludeOSã€Rusty-Hermitã€Rumprun
å’ŒUnikraftç­‰å…­ä¸ªç›®å‰ä»ç„¶åœ¨ç»´æŠ¤çš„unikernelé¡¹ç›®ã€‚
\end{comment}

\section{å‰ç»æ€§/é‡è¦æ€§åˆ†æ}

\subsection{ä½¿ç”¨å…ˆè¿›çš„å·¥å…·æ„å»º}\sectionauthor{éƒ­è€¸éœ„ and å¼ å­è¾°}

Rustå’ŒRISC-Véƒ½æ˜¯æ–°å…´äº‹ç‰©ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨å¸å–æ—§äº‹ç‰©çš„æ•™è®­çš„åŸºç¡€ä¸Šè¯ç”Ÿçš„ï¼Œ
è€Œä¸”ï¼Œå®è·µè¡¨æ˜ï¼Œä¸¤è€…éƒ½æ­£åœ¨ç»å†è“¬å‹ƒçš„å‘å±•ï¼Œå¹¶æ­£åœ¨åˆ†åˆ«é€æ­¥å–ä»£æ—§äº‹ç‰©ã€‚
å› æ­¤ï¼Œç”¨Ruståœ¨RISC-Vä¸Šå¼€å‘unikernelé¡ºåº”äº†å†å²çš„è¶‹åŠ¿ã€‚

Rust æ˜¯ç”± Mozilla ç ”ç©¶å®¤
ä¸»å¯¼å¼€å‘çš„ä¸€é—¨ç°ä»£ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œè‡ª 2015 å¹´ 5 æœˆå‘å¸ƒ 1.0 ä¹‹åï¼Œä¸€ç›´ä»¥æ¯ 6 å‘¨
ä¸€ä¸ªå°ç‰ˆæœ¬çš„å¼€å‘è¿›åº¦ç¨³å®šå‘å‰æ¨è¿›ã€‚è¯­è¨€è®¾è®¡ä¸Šè·Ÿ C++ ä¸€æ ·å¼ºè°ƒé›¶å¼€é”€æŠ½è±¡å’Œ RAIIã€‚
æ‹¥æœ‰æå°çš„è¿è¡Œæ—¶å’Œé«˜æ•ˆçš„ C ç»‘å®šï¼Œä½¿å…¶è¿è¡Œæ•ˆç‡ä¸ C/C++ ä¸€ä¸ªçº§åˆ«ï¼Œéå¸¸é€‚åˆå¯¹æ€§èƒ½
è¦æ±‚è¾ƒé«˜çš„ç³»ç»Ÿç¼–ç¨‹é¢†åŸŸã€‚åˆ©ç”¨å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿå’Œç‹¬ç‰¹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å®ç°äº†ç¼–è¯‘æœŸå†…å­˜ç®¡ç†ï¼Œ
ä¿è¯å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨çš„åŒæ—¶ä½¿ç¼–è¯‘åçš„ç¨‹åºè¿è¡Œé€Ÿåº¦æå¿«ï¼ŒRust è¿˜æä¾›å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€
çš„æ¨¡å¼åŒ¹é…å’Œç±»å‹æ¨å¯¼ï¼Œè®©ç¨‹åºå†™èµ·æ¥æ›´ç®€æ´ä¼˜é›…ã€‚\cite{bib:2-why-rust}
æ€»åœ°æ¥è¯´ï¼ŒRustæ˜¯ä¸€é—¨èµ‹äºˆæ¯ä¸ªäºº æ„å»ºå¯é ä¸”é«˜æ•ˆè½¯ä»¶èƒ½åŠ›çš„è¯­è¨€ã€‚\cite{bib:1-rust-lang}
Rustå…·æœ‰é«˜æ€§èƒ½ã€å¯é æ€§ã€ç”Ÿäº§åŠ›ä¸‰æ–¹é¢çš„ä¼˜åŠ¿ã€‚

RISC-Væ˜¯äº2010å¹´è¯ç”Ÿè‡ªåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„ç²¾ç®€æŒ‡ä»¤é›†æ¶æ„ï¼Œ
å®ƒçš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªé€šç”¨çš„æŒ‡ä»¤é›†æ¶æ„ï¼Œå®ƒèƒ½é€‚åº”åŒ…æ‹¬ä»æœ€è¢–ççš„åµŒå…¥å¼æ§åˆ¶å™¨ï¼Œ
åˆ°æœ€å¿«çš„é«˜æ€§èƒ½è®¡ç®—æœºç­‰å„ç§è§„æ¨¡çš„å¤„ç†å™¨ï¼›å®ƒèƒ½å…¼å®¹å„ç§æµè¡Œçš„è½¯ä»¶æ ˆå’Œç¼–ç¨‹è¯­è¨€ï¼›
å®ƒèƒ½é€‚åº”æ‰€æœ‰å®ç°æŠ€æœ¯ï¼ŒåŒ…æ‹¬ç°åœºå¯ç¼–ç¨‹é—¨é˜µåˆ—(FPGA)
 ã€ä¸“ç”¨é›†æˆç”µè·¯(ASIC) ã€å…¨å®šåˆ¶èŠ¯ç‰‡ï¼Œç”šè‡³æœªæ¥çš„è®¾å¤‡æŠ€æœ¯ï¼›å®ƒå¯¹æ‰€æœ‰å¾®ä½“ç³»ç»“æ„æ ·å¼éƒ½æœ‰æ•ˆï¼Œ
ä¾‹å¦‚å¾®ç¼–ç æˆ–ç¡¬è¿çº¿æ§åˆ¶ã€é¡ºåºæˆ–ä¹±åºæ‰§è¡Œæµæ°´çº¿ã€å•å‘å°„æˆ–è¶…æ ‡é‡ç­‰ï¼›å®ƒæ”¯æŒå¹¿æ³›çš„ä¸“ä¸šåŒ–ï¼Œ
æˆä¸ºå®šåˆ¶åŠ é€Ÿå™¨çš„åŸºç¡€ï¼›å®ƒæ˜¯ç¨³å®šçš„ï¼ŒåŸºç¡€çš„æŒ‡ä»¤é›†æ¶æ„ä¸åº”è¯¥æ”¹å˜ã€‚\cite{bib:risc-v-manual}
ä¸ä»¥å¾€çš„ISAä¸åŒï¼ŒRISC-Væ˜¯\textit{æ¨¡å—åŒ–}çš„ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸ºRV32Içš„åŸºç¡€ISAï¼Œ
è¿è¡Œä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶æ ˆã€‚RV32Iæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ä¼šæ”¹å˜ã€‚è¿™ä¸ºç¼–è¯‘å™¨ç¼–å†™è€…ï¼Œæ“ä½œç³»ç»Ÿå¼€å‘äººå‘˜å’Œæ±‡
ç¼–è¯­è¨€ç¨‹åºå‘˜æä¾›äº†ç¨³å®šçš„ç›®æ ‡ã€‚æ¨¡å—åŒ–æ¥æºäºå¯é€‰çš„æ ‡å‡†æ‰©å±•ï¼Œæ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦ï¼Œ
ç¡¬ä»¶å¯ä»¥åŒ…å«æˆ–ä¸åŒ…å«è¿™äº›æ‰©å±•ã€‚è¿™ç§æ¨¡å—åŒ–ç‰¹æ€§ä½¿å¾—RISC-Vå…·æœ‰äº†è¢–çåŒ–ã€ä½èƒ½è€—çš„ç‰¹
ç‚¹ï¼Œè€Œè¿™å¯¹äºåµŒå…¥å¼åº”ç”¨å¯èƒ½è‡³å…³é‡è¦ã€‚RISC-Våœ¨è®¾è®¡æ—¶è€ƒè™‘äº†æˆæœ¬ã€ç®€æ´æ€§ã€æ€§èƒ½ã€
æ¶æ„å’Œå…·ä½“å®ç°çš„åˆ†ç¦»ã€æå‡ç©ºé—´ã€
ç¨‹åºå¤§å°å’Œæ˜“äºç¼–ç¨‹/ç¼–è¯‘/é“¾æ¥ä¸ƒä¸ªæ–¹é¢çš„å› ç´ ã€‚

ç›®å‰çš„unikernelä¸­ï¼Œä½¿ç”¨/æ”¯æŒä¸¤è€…ä¸­çš„ä¸€ä¸ªçš„éƒ½å¾ˆå°‘ï¼Œè€Œæ ¹æœ¬æ²¡æœ‰å°†ä¸¤è€…ç»“åˆè€…ã€‚Runi\-kraftçš„
äº®ç‚¹ä¹‹ä¸€å°±æ˜¯å°†ä¸¤è€…ç»“åˆã€‚

\subsection{æ¨¡å—åŒ–è®¾è®¡}\sectionauthor{å¼ å­è¾°}
ç›®å‰çš„å¤§å¤šæ•°unikernelå¼ºè°ƒâ€œuni-â€ï¼Œå®ƒä»¬çš„è®¾è®¡è€…è®¤ä¸ºè¿™æ ·æœ‰åˆ©äºæé«˜æ•ˆç‡ï¼Œ
æ‰€ä»¥ç³»ç»Ÿè¢«è®¾è®¡æˆäº†ä¸€ä¸ªæ•´ä½“ï¼Œè¿™ä¸ªæ•´ä½“å‘ç”¨æˆ·æä¾›èƒ½å¤Ÿè°ƒç”¨å‡½æ•°ã€‚å…·ä½“çš„è¡¨ç°å°±æ˜¯
ç³»ç»Ÿçš„æºä»£ç å †åœ¨ä¸€èµ·ï¼ŒClickOSã€IncludeOSã€MirageOSã€RustyHermitéƒ½æœ‰è¿™æ ·
çš„é—®é¢˜ã€‚ç³»ç»Ÿç¼ºä¹æ˜ç¡®çš„åŠŸèƒ½ç»„ä»¶ï¼Œæ‰€ä»¥ç³»ç»Ÿå¿…é¡»ä½œä¸ºä¸€ä¸ªæ•´ä½“ç»´æŠ¤ã€‚

åœ¨Runikraftä¸­ï¼Œåªæœ‰æå°‘æ•°å¹³å°å±‚çš„ä»£ç è¢«æ”¾åˆ°äº†ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ä¸­ï¼Œè€Œè°ƒåº¦å™¨ã€
åˆ†é…å™¨ç­‰ç»„ä»¶ä¸€å¾‹æ˜¯micro-librariesã€‚è¿™äº›micro-librarieséµå¾ªä¸€å¥—æ˜ç¡®
å®šä¹‰çš„APIsï¼ŒåŒä¸€ä¸ªç³»ç»Ÿæ¨¡å—å¯ä»¥æœ‰å¤šç§å®ç°ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾ä¸ºè‡ªå·±çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç³»ç»Ÿç»„ä»¶çš„å®ç°ã€‚
ä»Unikraftç»™å‡ºçš„åŸºå‡†æµ‹è¯•æ•°æ®çœ‹ï¼Œè¿™ç§æ¨¡å—åˆ’åˆ†ä¸ä¼šé™ä½ç³»ç»Ÿçš„æ•ˆç‡ã€‚

\subsection{åˆ›æ–°ç‚¹}
ä¸å…ˆå‰ç”¨Rustæ”¹å†™FreeRTOSçš„å°ç»„ç±»ä¼¼ï¼Œæˆ‘ä»¬çš„é¡¹ç›®åé‡å·¥ç¨‹ï¼Œæ²¡æœ‰ç†è®ºä¸Šçš„åˆ›æ–°ç‚¹ã€‚
ç”±äºæˆ‘ä»¬äº†è§£çš„æ‰€æœ‰ç”¨Rustå†™çš„æ“ä½œç³»ç»Ÿéƒ½æˆ–å¤šæˆ–å°‘çš„ä½¿ç”¨äº†unstableçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ç”¨stableç‰¹æ€§
ç¼–å†™unikernelä¹Ÿä¸å¤±ä¸ºä¸€ç§æŠ€æœ¯ä¸Šçš„åˆ›æ–°ã€‚

\section{æ¦‚è¦è®¾è®¡}\sectionauthor{å¼ å­è¾°}
\begin{figure}[!hbt]
\centering
\includegraphics[width=\linewidth]{assets/Runikraft-architecture-impl.pdf}
\caption{Runikraftçš„æ¶æ„}\label{fig:runikraft-arch-impl}
\end{figure}
å¹³å°å±‚å°†ä¸åŒçš„å¹³å°å°è£…æˆé€šç”¨çš„\texttt{rkplat} APIï¼Œå®ƒæä¾›ä¸å¹³å°/æ¶æ„å¯†åˆ‡ç›¸å…³çš„åŠŸèƒ½ï¼Œ
æ¯”å¦‚å¤–è®¾é©±åŠ¨ã€å¤–ä¸­æ–­å¤„ç†ã€å†…å­˜åˆ†é¡µã€å®šæ—¶å™¨ã€åŸå­æ“ä½œã€å†…å­˜å±éšœï¼Œæˆ‘ä»¬åªæ”¯æŒRISC-V+QEMU virt
ä¸€ç§å¹³å°ã€‚å¯¹äºRISC-Væ¶æ„ï¼ŒOSesè¿è¡Œåœ¨supervisorç‰¹æƒæ¨¡å¼ï¼Œå®ƒéœ€è¦è¿è¡Œåœ¨machineç‰¹æƒæ¨¡å¼çš„
OpenSBI\cite{bib:feasibility-5}\cite{bib:feasibility-6}çš„ååŠ©æ‰èƒ½å…³æœºã€è®¾ç½®å®šæ—¶å™¨å’Œ
è§¦å‘æ ¸é—´ä¸­æ–­ã€‚

\texttt{rkgpudev}ã€\texttt{rkinputdev}ã€\texttt{rktime}ã€\texttt{rkswrand}ã€\texttt{rkboot}
äº”ä¸ªAPIsçš„åŠŸèƒ½ä¸å¹³å°å¯†åˆ‡ç›¸å…³ï¼Œ
ä½†æ˜¯ä¸ºäº†é™ä½å¼€å‘å’Œç»´æŠ¤éš¾åº¦ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰ç›´æ¥å®ç°ï¼Œè€Œæ˜¯åœ¨\texttt{rkplat}æä¾›çš„åˆçº§æŠ½è±¡çš„åŸºç¡€ä¸Šå®ç°ã€‚
\texttt{rkgpudev}å’Œ\texttt{rbintputdev}åˆ†åˆ«æä¾›æ˜¾ç¤ºè®¾å¤‡å’Œè¾“å…¥è®¾å¤‡çš„æ”¯æŒã€‚
\texttt{rktime}æä¾›è·å–ç³»ç»Ÿæ—¶é—´çš„APIï¼Œ\texttt{rkswrand}æä¾›å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ï¼Œ
\texttt{rkboot}è´Ÿè´£å®ŒæˆOSå…ƒä»¶çš„åˆå§‹åŒ–å¹¶å°†æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·çš„ä»£ç ã€‚

\texttt{rksched}å’Œ\texttt{rklock}æ˜¯ä¸¤ä¸ªä¸è°ƒåº¦å™¨æœ‰å…³çš„APIsï¼Œå‰è€…è´Ÿè´£åˆ›å»ºã€è°ƒåº¦ã€æ’¤é”€çº¿ç¨‹ï¼Œåè€…è´Ÿè´£çº¿ç¨‹é—´
çš„åŒæ­¥å’Œäº’æ–¥ã€‚Runikraftæ”¯æŒå¤šç§è°ƒå–å™¨ï¼Œæ¯”å¦‚ï¼Œå›¾\ \ref{fig:runikraft-arch-impl}\ ä¸­çš„
coopæ˜¯åä½œå¼çš„FCFSè°ƒåº¦å™¨ã€
preemæ˜¯æŠ¢å å¼çš„RRè°ƒåº¦å™¨ã€‚å½“ç„¶ï¼Œä¸ºäº†ç³»ç»Ÿé•œåƒçš„è½»é‡æ€§ï¼Œç”¨æˆ·å¯ä»¥ä¸ä½¿ç”¨ä»»ä½•è°ƒå–å™¨ã€‚

Runikrafté€‰æ‹©æ€§åœ°æä¾›çº¿ç¨‹é€šä¿¡æ¨¡å—ï¼Œå¦‚åŸºäºä¿¡ç®±çš„çº¿ç¨‹é€šä¿¡ï¼ˆ\texttt{rkmpi}ï¼‰ï¼Œ
æ— é”çš„ç¯å½¢ç¼“å†²é˜Ÿåˆ—ï¼ˆ\texttt{rkring}ï¼‰ã€‚
Runikraftä¸åŒºåˆ†çº¿ç¨‹å’Œè¿›ç¨‹ï¼Œå®ƒçš„çº¿ç¨‹åŒæ—¶å…·æœ‰ä¼ ç»Ÿçš„OSesçš„çº¿ç¨‹å’Œè¿›ç¨‹çš„ç‰¹æ€§ï¼š
çº¿ç¨‹ä¹‹é—´æ²¡æœ‰éš”ç¦»æªæ–½ï¼Œä½†æ˜¯çº¿ç¨‹ä¹‹é—´åˆå¯ä»¥ä½¿ç”¨è¿›ç¨‹é€šä¿¡çš„æ–¹æ³•æ›´å®‰å…¨åœ°åŒæ­¥ã€‚

\texttt{rkalloc}æ˜¯åˆ†é…å™¨APIï¼Œå®ƒçš„åç«¯å¯ä»¥æ˜¯\texttt{buddy}ã€\texttt{tinyalloc}ã€\texttt{tlsf}ã€
\texttt{mimalloc}ç­‰åˆ†é…å™¨ã€‚
ç›®å‰ï¼Œæˆ‘ä»¬åªå®ç°äº†å…¶ä¸­çš„\texttt{buddy}ï¼Œå³ä¼™ä¼´åˆ†é…å™¨ã€‚

Runikraftè¿˜æä¾›äº†ä¸€äº›å·¥å…·æ¨¡å—ï¼Œæ¯”å¦‚æ—¶é—´æ ¼å¼è½¬æ¢å·¥å…·\texttt{rktimeconv}ã€
å‘½ä»¤è¡Œå‚æ•°åˆ†æå·¥å…·\texttt{rkargparse}ã€‚æˆ‘ä»¬æ›¾ç»è®¡åˆ’å®ç°è°ƒè¯•å·¥å…·\texttt{rkdebug}ï¼Œä½†æˆ‘ä»¬å‘ç°ï¼Œ
Rustçš„æ ¸å¿ƒåº“æä¾›çš„\texttt{assert}å’Œ\texttt{debug\_assert}å®å·²ç»è¶³å¤Ÿå–ä»£Unikraftçš„\texttt{ukdebug}äº†ï¼Œ
æ‰€ä»¥æœ€ç»ˆæ²¡æœ‰å®ç°ã€‚

\begin{table}[!hbt]
\caption{Unikraftä¸Runikraftçš„ç»„ä»¶çš„å¯¹åº”}
\centering
\begin{tabular}{lll}
\hline
Unikraft&Runikraft&åŠŸèƒ½\\\hline
\texttt{ukalloc}&\texttt{rkalloc}&åˆ†é…å™¨API\\
\texttt{ukallocbuddy}&\texttt{rkallocbuddy}&åˆ†é…å™¨å®ç°â€”â€”ä¼™ä¼´åˆ†é…å™¨\\
\texttt{ukargparse}&\texttt{rkargparse}&kernel arguments parsing\\
\texttt{ukboot}&\texttt{rkboot}&åˆå§‹åŒ–ç³»ç»Ÿ\\
ï¼ˆæ— ï¼‰&\texttt{rkgpudev}&æ˜¾ç¤ºè®¾å¤‡\\
\texttt{uklock}&\texttt{rklock}&äº’æ–¥é”ã€ä¿¡å·é‡\\
\texttt{ukmpi}&\texttt{rkmpi}&åŸºäºä¿¡ç®±çš„é€šä¿¡\\
\texttt{ukplat}&\texttt{rkplat}&å¹³å°ç›¸å…³ä»£ç \\
\texttt{ukring}&\texttt{rkring}&æ— é”ç¯å½¢ç¼“å†²åŒº\\
\texttt{uksched}&\texttt{rksched}&è°ƒåº¦å™¨API\\
\texttt{ukschedcoop}&\texttt{rkschedcoop}&è°ƒåº¦å™¨å®ç°â€”â€”FCFS\\
ï¼ˆæ— ï¼‰&\texttt{rkschedpreem}&è°ƒåº¦å™¨å®ç°â€”â€”RR\\
\texttt{ukswrand}&\texttt{rkswrand}&å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨\\
\texttt{uktimeconv}&\texttt{rktimeconv}&æ—¶é—´æ ¼å¼è½¬æ¢\\
\hline
\end{tabular}
\end{table}

\begin{figure}[!htb]
\centering
\includegraphics[width=\linewidth]{assets/crates-dependency.pdf}
\caption{Runikraftçš„cratesçš„ä¾èµ–å…³ç³»}
\end{figure}

\section{åŠŸèƒ½ç»„ä»¶}\sectionauthor{å¼ å­è¾°}
æœ¬èŠ‚ä»‹ç»Runikraftçš„é‡è¦cratesçš„è®¾è®¡æ€æƒ³ï¼Œä¸å±•ç¤ºå…·ä½“çš„APIsï¼Œä¹Ÿä¸ä»‹ç»å®¹æ˜“å®ç°çš„æ¬¡è¦ç»„ä»¶ã€‚
\subsection[\texttt{rkplat}]{\texttt{rkplat}ï¼šå¹³å°ç›¸å…³ä»£ç }
\texttt{rkplat}ä¸»è¦åŒ…å«\texttt{console}ã€\texttt{irq}ã€
\texttt{lcpu}ã€\texttt{thread}å’Œ\texttt{time}ç­‰æ¨¡å—ã€‚

\texttt{console}æä¾›æœ€åŸºæœ¬çš„æ§åˆ¶å°è¾“å…¥è¾“å‡ºï¼ŒåŒ…æ‹¬Unikrafté£æ ¼çš„\texttt{cink}ã€\texttt{coutk}å’ŒRust
é£æ ¼çš„\texttt{print}ã€\texttt{println}ã€‚

\texttt{irq}æ˜¯ä¸­æ–­å­ç³»ç»Ÿã€‚åœ¨å¼‚å¸¸/ä¸­æ–­å‘ç”Ÿåï¼Œ\texttt{\_\_rkplat\_int\_except\_entry}å°†
åˆ¤æ–­å‘ç”Ÿçš„æ˜¯å¼‚å¸¸è¿˜æ˜¯ä¸­æ–­ã€‚å¯¹äºå¼‚å¸¸ï¼Œæ‰€æœ‰å¯„å­˜å™¨éƒ½ä¼šè¢«ä¿å­˜åˆ°ä¸€æ®µç›¸å¯¹ä¸å®¹æ˜“è¢«ç ´åçš„å†…å­˜åŒºåŸŸï¼Œç„¶å
\texttt{\_\_rkplat\_exception\_handle}ä¼šè¾“å‡ºå¼‚å¸¸ä¿¡æ¯ã€‚å¯¹äºä¸­æ–­ï¼Œåªæœ‰\texttt{t*}å’Œ\texttt{a*}
å¯„å­˜å™¨ä¼šè¢«ä¿å­˜åˆ°å½“å‰åœ¨æ ˆä¸Šï¼Œç„¶åæ§åˆ¶æƒä¼šè¢«äº¤ç»™ä¸­æ–­å­ç³»ç»Ÿçš„\texttt{\_\_rkplat\_irq\_handle}å‡½æ•°ï¼Œ
åè€…ä¼šè°ƒç”¨æœ‰å¹³å°æ— å…³ä»£ç äº‹å…ˆæ³¨å†Œçš„ä¸­æ–­å“åº”å‡½æ•°ã€‚

\texttt{lcpu} å¤„ç†é€»è¾‘å¤„ç†å™¨ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå…³é—­/å¼€å¯ä¸­æ–­ï¼Œè·å–å½“å‰çš„é€»è¾‘å¤„ç†å™¨çš„ç¼–å·ï¼Œå”¤é†’å¦ä¸€ä¸ª
é€»è¾‘å¤„ç†å™¨ï¼Œè¯»å–æ ˆæŒ‡é’ˆã€‚

\texttt{thread}æä¾›åˆ‡æ¢å’Œå¯åŠ¨çº¿ç¨‹çš„åŸè¯­\texttt{start(A)}å’Œ\texttt{switch(A,B)}ã€‚\texttt{start}å°†æ‰§è¡Œæµ
è½¬åˆ°ä¸€ä¸ªä»æœªè¿è¡Œè¿‡çš„çº¿ç¨‹Aã€‚\texttt{switch}å°†æ‰§è¡Œæµä»çº¿ç¨‹Aåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªè°ƒç”¨äº†\texttt{switch}
æˆ–ä»æœªæ‰§è¡Œè¿‡çš„çº¿ç¨‹Bã€‚1. å¦‚æœçº¿ç¨‹Bä»æœªæ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆæ‰§è¡Œæµå°†è½¬åˆ°Bçš„å…¥å£ï¼›2. å¦‚æœçº¿ç¨‹Bå…ˆå‰è°ƒç”¨
äº†\texttt{switch}ï¼Œé‚£ä¹ˆæ‰§è¡Œæµå°†è½¬åˆ°Bçº¿ç¨‹çš„\texttt{switch}å‡½æ•°åçš„æŒ‡ä»¤ï¼Œè¿™æ„å‘³ç€ï¼Œ
Bçº¿ç¨‹ä¼šè§‚å¯Ÿåˆ°\texttt{switch}å‡½æ•°è¿”å›ã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œçº¿ç¨‹Aä¼šè¢«æŒ‚èµ·åˆ°æŸä¸€ä¸ªçº¿ç¨‹è°ƒç”¨\texttt{switch}åˆ‡æ¢åˆ°Aã€‚
\texttt{switch}å‡½æ•°å®ç°äº†â€œè‡ªä¸»â€çš„çº¿ç¨‹åˆ‡æ¢ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„OSesä¸­çš„éœ€è¦supervisorååŠ©çš„çº¿ç¨‹åˆ‡æ¢ï¼Œè¿™ç§æ¨¡å¼å‡å°‘äº†
ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› æ­¤æ›´å¿«é€Ÿåœ°å®Œæˆçº¿ç¨‹çš„åˆ‡æ¢ã€‚%åœ¨ä»‹ç»\texttt{rksched}çš„è®¾è®¡æ—¶ï¼Œå°†è¯¦ç»†ä»‹ç»Runikraftçš„çº¿ç¨‹æ¨¡å‹ã€‚

\texttt{rktime}è´Ÿè´£æŸ¥è¯¢æ—¶é—´å’Œè®¾ç½®å®šæ—¶å™¨ã€‚

æ€»ä½“æ¥è¯´ï¼Œ\texttt{rkplat}æå–äº†å¤šç§ISAsçš„å…±æ€§ï¼Œéšè—äº†ä¸åŒçš„ISAsä¹‹é—´çš„å·®å¼‚ï¼Œä½¿ Runikraftçš„
å…¶ä»–cratesçš„ä»£ç èƒ½ä¸ä¾èµ–ç‰¹å®šçš„ISAã€‚
\subsection[\texttt{rkalloc}]{\texttt{rkalloc}ï¼šåˆ†é…å™¨}
åˆ†é…å™¨çš„APIä½äº\texttt{rkalloc} crateï¼Œå®ç°ä¹‹ä¸€æ˜¯\texttt{rkallocbuddy}ã€‚

\texttt{rkalloc} APIå…¼é¡¾äº†Rusté£æ ¼çš„åˆ†é…å™¨å’ŒCé£æ ¼çš„åˆ†é…å™¨ã€‚é¦–å…ˆï¼Œ\texttt{Alloc} trait
çš„æ¥å£ä¸\texttt{alloc::alloc::GlobalAlloc}å¾ˆæ¥è¿‘ï¼Œåœ¨è§£åˆ†é…æ—¶ï¼Œå¿…é¡»æä¾›åˆ†é…æ—¶ä½¿ç”¨çš„\texttt{size}
å’Œ\texttt{align}ï¼Œè¿™èƒ½é™ä½å®ç°åˆ†é…å™¨çš„éš¾åº¦ã€‚å…¶æ¬¡ï¼Œ\texttt{AllocExt} traitæä¾›ä¸Cçš„\texttt{free}
å…¼å®¹çš„è§£åˆ†é…å‡½æ•°\texttt{dealloc\_ext(ptr: *mut u8)}ï¼Œåœ¨è§£åˆ†é…æ—¶ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªæŒ‡é’ˆã€‚

\texttt{rkallocbuddy}æ˜¯ä¼™ä¼´åˆ†é…å™¨ï¼Œå®ƒå®ç°äº†\texttt{AllocExt} traitã€‚å°½ç®¡æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°
åœ¨Internetä¸Šæ‰¾åˆ°å¤šç§ä¼™ä¼´åˆ†é…å™¨çš„Cå®ç°\cite{bib:buddy-C-1}\cite{bib:buddy-C-2}\cite{bib:buddy-C-3}å’ŒRustå®ç°\cite{bib:buddy-Rust-1}\cite{bib:buddy-Rust-2}\cite{bib:buddy-Rust-3}ï¼Œ
ä½†æ˜¯å®ƒä»¬éƒ½ä¸å®Œå…¨ç¬¦åˆRunikraftçš„è¦æ±‚ã€‚
è¿™æ˜¯å› ä¸ºRustçš„å®ç°ä»¥å®ç°\texttt{GlobalAlloc} traitä¸ºç›®æ ‡ï¼Œä¸æ”¯æŒ\texttt{AllocExt}ï¼›
ä¸€äº›Cçš„å®ç°è™½ç„¶éå¸¸ç²¾å½©ï¼Œä½†æ˜¯éœ€è¦æ”¹å†™æˆRustæ‰èƒ½ä½¿ç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©è‡ªè¡Œå®ç°ä¼™ä¼´åˆ†é…å™¨ã€‚

é¦–å…ˆè€ƒè™‘å¤§å°ä¸º$2^n$çš„è¢«ç®¡ç†çš„å†…å­˜åŒºåŸŸã€‚

æœ€å°çš„å—çš„é•¿åº¦æ˜¯$2^4$ bytesï¼Œèƒ½å®¹çº³2ä¸ªæŒ‡é’ˆï¼›æœ€å¤§çš„å—çš„å¤§å°ä¸º$2^{48}$ bytesï¼Œæ˜¯AMD64æ”¯æŒçš„æœ€å¤§å†…å­˜å®¹é‡ã€‚
ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤ç©ºé—²å—ï¼Œé“¾è¡¨çš„ç»“ç‚¹\texttt{Node}å‚¨å­˜åœ¨å®ƒå¯¹åº”çš„å†…å­˜åŒºåŸŸçš„å¼€å¤´ã€‚
ç”¨æ ‘çŠ¶bitsetç»´æŠ¤æ‰€æœ‰çš„å†…å­˜åŒºå—çš„åˆ†é…æƒ…å†µï¼ˆå…ƒæ•°æ®ï¼‰ï¼š
\begin{itemize}
\item \texttt{[0]}æ˜¯æ ¹ç»“ç‚¹ï¼›
\item \texttt{[i*2+1]}æ˜¯\texttt{[i]}çš„å·¦å­©å­ï¼Œå®ƒå¯¹åº”çš„å†…å­˜åŒºåŸŸæ˜¯\texttt{i}äºŒåˆ†åçš„å‰åŠæ®µï¼›
\item \texttt{[i*2+2]}æ˜¯\texttt{[i]}çš„å³å­©å­ï¼Œå®ƒå¯¹åº”çš„å†…å­˜åŒºåŸŸæ˜¯\texttt{i}äºŒåˆ†åçš„ååŠæ®µï¼›
\item é¡ºåºï¼ˆorderï¼‰ç­‰äº\texttt{k}çš„ç»“ç‚¹åœ¨è¿™ä¸ªbitsetçš„ç´¢å¼•èŒƒå›´æ˜¯\texttt{[$2^{n-k}-1$:$2^{n-k+1}-2$]}ï¼›
\item é¡ºåºç­‰äº\texttt{k}çš„ç»“ç‚¹å…±æœ‰$2^{n-k}$ä¸ªï¼Œæ¯ä¸ªçš„å¤§å°ç­‰äº$2^k$ï¼›
\item æ•´ä¸ªbitsetçš„å¤§å°ç­‰äº$2^{n+1}\div16\div8=2^{n-6}$ bytes
\item \texttt{bitset[i]} = 0 è¡¨ç¤ºç»“ç‚¹iï¼š
    \begin{itemize}
        \item i æ²¡æœ‰è¢«åˆ†é…ï¼Œ
        \item i çš„çˆ¶ç»“ç‚¹å·²ç»è¢«åˆ†é…ï¼›
    \end{itemize}
\item \texttt{bitset[i]} = 1 è¡¨ç¤ºç»“ç‚¹iï¼š
    \begin{itemize}
        \item i è¢«åˆ†é…ï¼Œ
        \item i è¢«äºŒåˆ†æˆäº†ä¸¤ä¸ªå­ç»“ç‚¹ã€‚
    \end{itemize}
\end{itemize}
åˆå§‹æ—¶ï¼Œå…ƒæ•°æ®çš„æ‰€æœ‰ä½éƒ½æ˜¯0ï¼Œå¦‚æœä¸€å—å†…å­˜iè¢«åˆ†é…ï¼Œåˆ™içš„å­©å­ä¸€å®šå…¨æ˜¯0ï¼Œiå’Œiçš„ç¥–å…ˆä¸€å®šå…¨æ˜¯1ã€‚

å…ƒæ•°æ®è¢«å‚¨å­˜åœ¨è¢«ç®¡ç†çš„å†…å­˜åŒºå—çš„æœ«å°¾ï¼Œå®ƒä»¬éœ€è¦å ç”¨$2^{n-10}$ä¸ªæœ€å°çš„å—ã€‚

å½“å†…å­˜åŒºåŸŸçš„å¤§å°sizeä¸æ˜¯2çš„å¹‚æ—¶ï¼Œè®°$n=\lceil\log_2(\mathrm{size})\rceil$ï¼Œ
åˆ™å¯ä»¥å°†å†…å­˜åŒºåŸŸè§†ä¸ºå¤§å°ä¸º$2^n$ä½†æœ«å°¾çš„ä¸€äº›
ç»“ç‚¹å·²ç»è¢«åˆ†é…çš„å†…å­˜åŒºåŸŸã€‚

\subsection[\texttt{rksched}]{\texttt{rksched}ï¼šè°ƒåº¦å™¨}
è°ƒåº¦å™¨çš„APIä½äº\texttt{rksched} crateï¼Œ
å®ç°æœ‰\texttt{rkschedcoop}ã€\texttt{rkschedpreem}ã€‚

åœ¨Runikraftä¸­ï¼Œè°ƒåº¦å™¨ç”±\texttt{Thread}ã€\texttt{Sched}å’Œ\texttt{WaitQ}ç­‰ä¸‰ä¸ªå¯†åˆ‡
é…åˆçš„ç»“æ„ä½“å®ç°ã€‚\texttt{Thread}ä¿å­˜çº¿ç¨‹çš„æ§åˆ¶å—ï¼Œ\texttt{Sched}æŒ‰ç…§ä¸€å®šçš„é¡ºåºå°†CPUæ—¶é—´
åˆ†é…ç»™çº¿ç¨‹ï¼Œ\texttt{WaitQ}ç»´æŠ¤äº‹ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ã€‚

\texttt{Thread}çš„é‡è¦æˆå‘˜æœ‰æ ˆé¡¶æŒ‡é’ˆã€thread local storageæŒ‡é’ˆã€çŠ¶æ€ï¼ˆdetachedã€endedã€runnableï¼‰ã€
å±æ€§ï¼ˆä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡é•¿åº¦ã€æˆªæ­¢æ—¶é—´ç­‰ï¼‰ã€å ç”¨çš„èµ„æºä¸Šé™ï¼ˆCPUæ—¶é—´ã€å†…å­˜ç©ºé—´ç­‰ï¼‰å’ŒæŒ‡å‘æ§åˆ¶çº¿ç¨‹çš„è°ƒåº¦å™¨çš„
è£¸æŒ‡é’ˆã€‚ç›´æ¥ä½¿ç”¨\texttt{Thread}æ—¢ä¸æ–¹ä¾¿ä¹Ÿä¸å®‰å…¨ï¼šé¦–å…ˆï¼Œéœ€è¦åˆ†é…çº¿ç¨‹æ ˆç©ºé—´ï¼ˆstackï¼‰å’Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ç©ºé—´ï¼ˆtlsï¼‰ã€‚
æ¥ç€éœ€å¯¹tlsçš„ä½åœ°å€è°ƒç”¨\texttt{init}ï¼ˆ\texttt{unsafe\{*(tls as *mut Thread).init(...)\}}ï¼‰ï¼Œåˆå§‹åŒ–æ§åˆ¶å—ï¼Œ
\texttt{init}çš„tlså‚æ•°åº”ç­‰äº\texttt{tls+size\_of::<Thread>}ã€‚
ä¹‹åç”¨\texttt{add\_thread}æŠŠçº¿ç¨‹åŠ å…¥è°ƒåº¦å™¨ã€‚è°ƒåº¦å™¨å°†å‘¨æœŸæ€§åœ°æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•æˆ–è¢«killedï¼Œè¿™æ—¶
å¿…é¡»è°ƒç”¨\texttt{exit}ã€‚\texttt{exit}å‡½æ•°ä¼šinvokeè°ƒåº¦å™¨ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ²¡æœ‰é€€å‡ºçš„çº¿ç¨‹ã€‚ç„¶åï¼Œè°ƒåº¦å™¨ä¼š
è°ƒç”¨\texttt{finish}ï¼Œå”¤é†’ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸçš„çº¿ç¨‹ã€‚å¦‚æœçº¿ç¨‹æ˜¯detachedï¼Œè°ƒåº¦å™¨å°†é‡Šæ”¾çº¿ç¨‹çš„æ ˆç©ºé—´å’Œthread local
storageï¼Œå¯¹äºjoinableçº¿ç¨‹ï¼Œåˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹è´Ÿè´£é‡Šæ”¾ç©ºé—´ã€‚è€ƒè™‘åˆ°\texttt{Thread}çš„APIéå¸¸ä¸æ˜“ç”¨ï¼Œ
Runikraftæä¾›äº†\texttt{create\_thread}å’Œ\texttt{destroy\_thread}ä¸¤ä¸ªèƒ½å¤Ÿå®‰å…¨åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„å‡½æ•°ã€‚

\texttt{Thread}å¯¹è±¡è‡ªèº«å…¶å®æ˜¯\texttt{Tailq}çš„ç»“ç‚¹ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„æ–¹å¼æŠŠçº¿ç¨‹åŠ å…¥æˆ–ç§»å‡ºå°±ç»ªé˜Ÿåˆ—ã€‚
ä¸è¿‡ï¼Œ\texttt{WaitQ}æ˜¯Threadçš„\textit{åœ°å€}æ„æˆçš„\texttt{Stailq}ï¼Œè€Œä¸æ˜¯\texttt{Thread}è‡ªèº«
æ„æˆçš„\texttt{Tailq}ï¼Œ
è¿™æ ·åšæ˜¯ä¸ºäº†ä½¿ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸåŒæ—¶ç­‰å¾…å¤šä¸ªäº‹ä»¶ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­ä»»æ„ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶è¢«å”¤é†’ã€‚æ¯å°†çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ
éƒ½éœ€è¦åˆ›å»º\texttt{StailqNode<NonNull<Thread>>}å¯¹è±¡ã€‚ä¸ºäº†ä¸ä½¿ç”¨åˆ†é…å™¨ï¼Œè¿™ä¸ªå¯¹è±¡è¢«åˆ›å»ºåœ¨äº†æ ˆä¸Šï¼Œ
è¿™æ„å‘³ç€ï¼Œéœ€è¦å°†æ‰§è¡Œæ ˆå¯¹è±¡çš„æŒ‡é’ˆä¼ é€’å‡ºå»ã€‚è¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºçº¿ç¨‹è¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—åï¼Œä¼šè¢«ç«‹å³æŒ‚èµ·ï¼Œæ ˆä¸­çš„å¯¹è±¡
ä¸ä¼šè¢«droppedï¼Œå½“ä¸”ä»…å½“çº¿ç¨‹è¢«å”¤é†’ï¼Œ\texttt{StailqNode<...>}å¯¹è±¡è¢«ç§»å‡ºç­‰å¾…é˜Ÿåˆ—åï¼Œåˆ›å»ºåœ¨å †
ä¸Šçš„\texttt{StailqNode<...>}å¯¹è±¡æ‰ä¼šè¢«droppedã€‚

\texttt{Sched}æ˜¯traitï¼Œå®ƒçš„é‡è¦å…¬å¼€æ¥å£æœ‰\texttt{start}ã€\texttt{yield}ã€\texttt{add\_thread}ã€
\texttt{remove\_thread}ã€\linebreak\texttt{thread\_blocked}å’Œ\texttt{thread\_woken}ã€‚åœ¨å®šä¹‰\texttt{Sched}
æ—¶ï¼Œæˆ‘ä»¬è¢«Rustçš„è¡¨è¾¾èƒ½åŠ›çš„ç¼ºé™·å›°æ‰°ï¼š\texttt{Sched}çš„\texttt{\_\_set\_next\_sheduler}åªé€‚åˆ
è¢«rkbootè°ƒç”¨ï¼Œ\texttt{\_\_workload}åªé€‚åˆè¢«å®ç°Sched traitçš„ç»“æ„ä½“è°ƒç”¨ï¼Œå¯æ˜¯ç”±äºRustä¸æ”¯æŒprotected
å’Œfriendï¼Œå®ƒä»¬è¢«è®¾ç½®æˆäº†å…¬å¼€æ¥å£ã€‚

\texttt{Sched}çš„é‡è¦å®ç°\texttt{Schedcoop}æ˜¯æ•´ä¸ªRunikraftä¸­éš¾åº¦æœ€å¤§çš„éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒéœ€è¦æ­£ç¡®å¤„ç†
å¯¹ç§°å¤šå¤„ç†å™¨ï¼ˆSMPï¼‰å¼•èµ·çš„ç‰©ç†å±‚é¢çš„æ•°æ®ç«äº‰ã€‚\texttt{Schedcoop}çš„æ ¸å¿ƒå‡½æ•°æ˜¯\texttt{schedule}ï¼Œ
åœ¨ä¸å¤„ç†SMPæ—¶ï¼Œå®ƒçš„æ‰§è¡Œæµç¨‹æ˜¯
\begin{lstlisting}[numbers=left,mathescape,language=Rust]
// exit_thread, ready_thread, waiting_threadæ˜¯Tailq

current $\leftarrow$ å½“å‰çº¿ç¨‹
//æ”¾ç½®å½“å‰çº¿ç¨‹
if current.is_exited()
    æŠŠcurrentåŠ å…¥exit_thread
else if currentä¸å±äºä»»ä½•ä¸€ä¸ªé“¾è¡¨
    æŠŠcurrentåŠ å…¥ready_thread

//å¤„ç†é€€å‡ºé˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
for thread in exit_thread
    if thread != current
        thread.finish()
        if thread.is_detached()
            destroy_thread(thread)

//å¤„ç†ç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹
current_time $\leftarrow$ å½“å‰æ—¶é—´
sleep_until $\leftarrow$ current_time + 10s
for thread in waiting_thread
    if thread.wakeup_time <= current_time
        æŠŠthreadç§»å‡ºwait_thread
        if thread.is_exited()
            æŠŠthreadåŠ å…¥exit_thread
        else
            æŠŠthreadåŠ å…¥ready_thread
    else
        sleep_until = min(thread.wakeup_time,sleep_until)

//åˆ‡æ¢çº¿ç¨‹
if ready_threadéç©º
    front $\leftarrow$ ready_threadçš„å¤´ç»“ç‚¹
    å°†frontç§»å‡ºready_thread
    if front != current
        //rkplatçš„threadæ¨¡å—çš„switchåŸè¯­
        switch(current,front)
    return
else
    ç­‰å¾…åˆ°sleep_until
    è½¬åˆ°ç¬¬5è¡Œ
\end{lstlisting}
å®ƒå°šä¸”æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡20\tildechar28è¡Œçš„éå†\texttt{waiting\_thread}çš„æ—¶é—´å¤æ‚åº¦å¾ˆé«˜ï¼Œä½¿ç”¨
å¹³è¡¡æ ‘å¯ä»¥é™ä½è¿™éƒ¨åˆ†çš„å¤æ‚åº¦ã€‚

\texttt{schedule}å¹¶ä¸æ˜¯å”¯ä¸€èƒ½ä¿®æ”¹\texttt{ready\_thread}å’Œ\texttt{waiting\_thread}çš„
å‡½æ•°ã€‚\texttt{add\_thread}ã€\texttt{thread\_blocked}å’Œ\texttt{thread\_woken}å‡½æ•°éƒ½
èƒ½ä¿®æ”¹è¿™ä¸¤ä¸ª\texttt{Tailq}sã€‚\texttt{thread\_blocked}åªä¼šè¢«åŒæ­¥è°ƒç”¨ï¼Œå³çº¿ç¨‹åªèƒ½é˜»å¡è‡ªèº«ï¼Œ
ä½†æ˜¯åœ¨SMPåœºæ™¯ä¸‹ï¼Œ\texttt{add\_thread}å’Œ\texttt{thread\_woken}ä¼šè¢«å¼‚æ­¥è°ƒç”¨ï¼Œå³è¿è¡Œåœ¨ä¸€ä¸ª
ç¡¬ä»¶çº¿ç¨‹ä¸Šçš„ç³»ç»Ÿçº¿ç¨‹å¯ä»¥åˆ›å»ºå’Œå”¤é†’è¿è¡Œåœ¨å¦å¤–ä¸€ä¸ªç¡¬ä»¶çº¿ç¨‹ä¸Šçš„ç³»ç»Ÿçº¿ç¨‹ã€‚è‡ªä¸»çš„çº¿ç¨‹åˆ‡æ¢ä½¿åŠ é”å¾ˆå›°éš¾ï¼Œ
å› ä¸ºåœ¨å®Œæˆè°ƒåº¦æ—¶ï¼Œæ§åˆ¶æƒå·²ç»åˆ°äº†å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åŠ çš„é”å¿…é¡»åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¢«é‡Šæ”¾ã€‚æˆ‘ä»¬æœ€ç»ˆ
é‡‡ç”¨çš„è§£å†³æ–¹æ³•æ˜¯å°†å¼‚æ­¥çš„åŠ å…¥å’Œå”¤é†’è¯·æ±‚å»¶è¿Ÿåˆ°\texttt{scheduler}å‡½æ•°æ‰§è¡Œï¼Œå¼‚æ­¥çš„\texttt{add\_thread}
å’Œ\texttt{thread\_woken}è°ƒç”¨åªä¼ é€’æ“ä½œã€‚åœ¨ä¿®æ”¹åçš„\texttt{schedule}å‡½æ•°ä¸­ï¼Œåœ¨å¤„ç†äº†é€€å‡ºé˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
åï¼Œéœ€è¦ä¾æ¬¡å¤„ç†å¼‚æ­¥åŠ å…¥çš„çº¿ç¨‹å’Œå¼‚æ­¥å”¤é†’çš„çº¿ç¨‹ã€‚

åœ¨åä½œå¼è°ƒåº¦å™¨çš„åŸºç¡€ä¸Šï¼Œåªéœ€è¦åœ¨åˆå§‹åŒ–è°ƒåº¦å™¨æ—¶æ³¨å†Œä¸­æ–­å“åº”å‡½æ•°ï¼Œå¹¶ä¸”
åœ¨\texttt{switch}å‰è®¾ç½®å®šæ—¶å™¨ï¼Œå°±å¯ä»¥å¾ˆè½»æ¾åœ°å®ç°æŠ¢å å¼è°ƒåº¦å™¨ã€‚

å°½ç®¡Unikraftçš„paperå£°ç§°è‡ªå·±çš„APIæ¸…æ™°ä¸”è‰¯å®šä¹‰ï¼Œä½†å®ƒçš„çº¿ç¨‹APIå´è®¾è®¡å¾—æœ‰äº›æ··ä¹±ã€‚
Runikraftæ‰¿è¢­Unikraftï¼ŒæŠŠè°ƒåº¦å™¨çš„åŠŸèƒ½åˆ†æ•£åˆ°äº†\texttt{Sched}ã€\texttt{Thread}å’Œ\texttt{Waitq}
ä¸‰ä¸ªéœ€è¦å¯†åˆ‡é…åˆçš„ç»“æ„ä½“ä¸­ã€‚æˆ‘ä»¬ä¸å¾—ä¸è°¨æ…åœ°åˆ’åˆ†å‡½æ•°çš„åŠŸèƒ½è¾¹ç•Œï¼Œè¿™ç»™æˆ‘ä»¬çš„å¼€å‘å¸¦æ¥äº†ä¸€å®šçš„æŒ‘æˆ˜ã€‚

\subsection[\texttt{rkboot}]{\texttt{rkboot}ï¼šç³»ç»Ÿåˆå§‹åŒ–}
åœ¨ç”¨æˆ·è§†è§’ä¸‹ï¼Œ\texttt{main}å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£åœ°å€ã€‚ç„¶è€Œåœ¨æ‰§è¡Œ\texttt{main}å‡½æ•°
å‰ï¼Œç”¨æˆ·æœŸæœ›è®¾å¤‡å’Œç³»ç»Ÿçš„å…ƒä»¶éƒ½å·²å®Œæˆåˆå§‹åŒ–è€Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œ\texttt{main}ä¸å¯èƒ½æ˜¯OSçš„
å…¥å£ï¼Œåœ¨æ‰§è¡Œ\texttt{main}ä¹‹å‰ï¼ŒOSä¸€å®šä¼šæ‰§è¡Œåˆå§‹åŒ–ä»£ç ã€‚åœ¨Runikraftä¸­ï¼Œç»å¤§éƒ¨åˆ†åˆå§‹åŒ–ç”±
\texttt{rkboot}å®Œæˆï¼Œè€Œå°‘æ•°å¹³å°ç›¸å…³çš„åˆå§‹åŒ–ç”±\texttt{rkplat::bootstrap}å®Œæˆã€‚

å¯¹äºQEMUçš„\texttt{virt}æœºå™¨ï¼Œå†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ˜¯\texttt{0x80200000}ï¼Œåœ¨å¼€å§‹æ‰§è¡Œå†…æ ¸
ä»£ç æ—¶ï¼Œåªæœ‰ä¸€ä¸ªç¡¬ä»¶çº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè€Œå…¶ä»–çš„å¤„åœ¨æŒ‚èµ·çŠ¶æ€ï¼Œ\texttt{a0}å¯„å­˜å™¨ä¿å­˜ç€å½“å‰çš„ç¡¬ä»¶çº¿ç¨‹çš„IDï¼Œ
\texttt{a1}å¯„å­˜å™¨ä¿å­˜ç€æŒ‡å‘å±•å¼€çš„è®¾å¤‡æ ‘ï¼ˆFDTï¼‰çš„æŒ‡é’ˆã€‚æ­¤æ—¶ï¼Œæ ˆæŒ‡é’ˆå°šæœªåˆå§‹åŒ–ï¼ŒBSSæ®µä¹Ÿæ²¡æœ‰è¢«æ¸…é›¶ã€‚

Runikraftå¼€æœºåæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯\texttt{\_\_runikraft\_start}ï¼Œå®ƒæ¸…ç©ºbssæ®µï¼Œåˆå§‹åŒ–å¼‚å¸¸/ä¸­æ–­å“åº”å‡½æ•°ï¼Œ
åŠ è½½æ ˆæŒ‡é’ˆï¼Œç„¶åè°ƒç”¨\texttt{\_\_runikraft\_entry\_point}ï¼Œåè€…åˆå§‹åŒ–ç¡¬ä»¶çº¿ç¨‹æœ¬åœ°æ•°æ®ï¼Œå¹¶ä¸”æŠŠ\texttt{a1}
ä¿å­˜åˆ°\texttt{DEVICE\_PTR}ã€‚è‡³æ­¤ï¼Œå¹³å°å±‚çš„åˆå§‹åŒ–ç»“æŸã€‚\texttt{\_\_runikraft\_entry\_\linebreak point}æŠŠæ§åˆ¶
å‰äº¤ç»™\texttt{rkboot}å‰ä¼šåˆ‡æ¢æ ˆï¼Œåˆ‡æ¢å‰çš„æ ˆè¢«ç§°ä¸ºearly boot stackï¼Œåˆ‡æ¢åçš„æ ˆè¢«ç§°ä¸ºmain stackã€‚
åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼ŒRunikraftå¯ä»¥åœ¨early boot stackä¸Šè°ƒç”¨å¼‚å¸¸å¤„ç†å‡½æ•°ã€‚

\texttt{rkboot}çš„å…¥å£æ˜¯\texttt{rkplat\_entry}ã€‚å®ƒä¾æ¬¡åˆå§‹åŒ–å…¨å±€åˆ†é…å™¨ã€
\texttt{rkplat::irq}ã€\texttt{rkplat::\linebreak device}ã€\texttt{rkplat::time}å’Œè°ƒåº¦å™¨ï¼Œ
å…¶ä¸­åˆ†é…å™¨å’Œè°ƒåº¦å™¨çš„åˆå§‹åŒ–å—\texttt{rkboot}çš„featuresçš„å½±å“ï¼Œæ¯”å¦‚åœ¨å¼€å¯\texttt{have\_scheduler}
featureæ—¶ï¼Œrkbootä¼šåœ¨æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹ä¸Šåˆ›å»ºåˆ†é…å™¨ï¼Œå¹¶ä¸”åœ¨åä¸ºâ€œmainâ€çš„çº¿ç¨‹ä¸­æ‰§è¡Œç”¨æˆ·çš„\texttt{main}å‡½æ•°ï¼Œ
å¦‚æœæ²¡æœ‰å¼€å¯è¿™ä¸ªfeatureï¼Œ\texttt{rkboot}å°†ç›´æ¥è°ƒç”¨\texttt{main}ã€‚

\section{æµ‹è¯•ç³»ç»Ÿ}\sectionauthor{é™ˆå»ºç»¿}
æµ‹è¯•ç³»ç»Ÿåœ¨æ•´ä¸ªé¡¹ç›®ä¸­å æœ‰é‡è¦åœ°ä½ã€‚Runikraft çš„æ¨¡å—åŒ–è®¾è®¡æ„å‘³ç€ç³»ç»Ÿçš„
å„ä¸ªåŠŸèƒ½æ¨¡å—æ˜¯äº’ä¸å¹²æ‰°çš„ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„APIã€‚è¿™ç§æ¨¡å—åŒ–è®¾è®¡ä¸ºæµ‹è¯•
å¸¦æ¥æå¤§çš„ä¾¿åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œå•ç‹¬æµ‹è¯•ï¼Œä»è€Œå¯ä»¥æ›´å¿«åœ°å‘ç°ç³»ç»Ÿè®¾è®¡
ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜å¹¶è¿›è¡Œä¿®å¤ã€‚

æˆ‘ä»¬çš„æµ‹è¯•ç³»ç»Ÿå°±æ˜¯åŸºäºè¿™ç§æ¨¡å—åŒ–çš„ç‰¹æ€§æ­å»ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä»»æ„å¤šçš„ç‹¬ç«‹çš„æ¨¡å—æµ‹è¯•ï¼Œ
ä½¿ç”¨å‘½ä»¤\texttt{make test}ä¾¿å¯ä»¥è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œä½¿ç”¨å‘½ä»¤\texttt{make TEST\_LIST=<testname>}
ä¾¿å¯ä»¥åªè¿è¡ŒæŸä¸ªç‰¹å®šçš„æµ‹è¯•ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚åœ¨\texttt{test/}ä¸­æ·»åŠ æµ‹è¯•ç¨‹åºçš„æ­¥éª¤å¦‚ä¸‹ï¼š

\begin{enumerate}
\item åˆ›å»ºç›®å½• \texttt{<test name>}ã€‚
\item åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»º \texttt{Cargo.toml}ï¼š
    \begin{itemize}
    \item package.name = test-<test name>ã€‚
    \end{itemize}
\item åœ¨\texttt{<test name>/src/main.rs}ä¸­å†™æµ‹è¯•ä»£ç ã€‚
\item å¦‚æœä½ çš„ç¨‹åºéœ€è¦ç‰¹æ®Šçš„ qemu å‘½ä»¤è¡Œå‚æ•°æ‰èƒ½è¿è¡Œï¼Œå¦‚GPUæµ‹è¯•ç¨‹åºéœ€è¦
    virtio-gpu è®¾å¤‡ï¼Œåˆ›å»º\texttt{<test name>/run\_flags.txt}å¹¶æŠŠç‰¹æ®Šçš„å‘½ä»¤è¡Œå‚æ•°
    å†™åœ¨æ­¤å¤„ã€‚
\end{enumerate}

\subsection{å®ç°æ–¹æ³•}

æœ€åˆæˆ‘ä»¬å°è¯•ä½¿ç”¨ Rust ä¸­æä¾›çš„é›†æˆæµ‹è¯•æ–¹å¼è¿›è¡Œæ¨¡å—æµ‹è¯•\cite{bib:rust-test}ï¼Œ
ä½†stable Rustç›®å‰å°šä¸æ”¯æŒåœ¨å¼€å¯\texttt{\#![no\_std]}æ—¶çš„é›†æˆæµ‹è¯•ï¼Œ
æˆ‘ä»¬åªå¥½æ”¾å¼ƒè¿™ç§é›†æˆæµ‹è¯•æ–¹å¼ï¼Œè½¬è€Œé‡‡ç”¨å…¶ä»–æ–¹å¼ã€‚æœ€ç»ˆæˆ‘ä»¬é‡‡ç”¨makefile+shå®Œæˆæµ‹è¯•ã€‚

æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ªåä¸º\texttt{test}çš„æ–‡ä»¶å¤¹ï¼Œæ¥å­˜æ”¾å„ä¸ªæ¨¡å—æµ‹è¯•ã€‚
æŒ‰ç…§ä¸Šé¢æè¿°çš„æ–¹å¼æ·»åŠ ä¸€ä¸ªæ¨¡å—æµ‹è¯•ï¼Œå…¶ä¸­æœ‰\texttt{main.rs}æ–‡ä»¶ï¼Œå› æ­¤ä¾¿å¯ä»¥æŒ‰ç…§ä¸‹é¢
çš„æ­¥éª¤è¿›è¡Œè¿è¡Œï¼ˆ\texttt{@testname@}æ˜¯æµ‹è¯•çš„åç§°ï¼‰ï¼š

\begin{enumerate}
\item ç”Ÿæˆ\texttt{@testname@.bin}æ–‡ä»¶ï¼š
    \begin{lstlisting}
cd $(TEST_ROOT_DIR)/@testname@ && env RUSTFLAGS="-Clink-arg=-T$(SRC_ROOT_DIR)/linker.ld  --cfg __alloc_error_handler --extern __alloc_error_handler=$(MAKE_ROOT_DIR)/liballoc_error_handler.rlib" cargo build --offline
rm $(TEST_ROOT_DIR)/@testname@/Cargo.lock
riscv64-linux-gnu-objcopy --strip-all $(TEST_BUILD_DIR)/test-@testname@ -O binary @testname@.bin
    \end{lstlisting}
\item è¿è¡Œ\texttt{@testname@.bin}æ–‡ä»¶ï¼š
    \begin{lstlisting}
qemu-system-riscv64 -machine virt -nographic -bios $(MAKE_ROOT_DIR)/opensbi/platform/generic/firmware/fw_jump.bin -kernel @testname@.bin
    \end{lstlisting}
\end{enumerate}

è¿™æ ·å°±æˆåŠŸæ‰§è¡Œäº†ä¸€ä¸ªæµ‹è¯•ã€‚å†åˆ©ç”¨ shell è„šæœ¬ä¸éš¾å®ç°å¤šä¸ªæ¨¡å—çš„æµ‹è¯•ã€‚

\subsection{æµ‹è¯•ç¼–å†™}

åœ¨å®Œæˆæµ‹è¯•ç³»ç»Ÿçš„é…ç½®åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è¿›è¡Œæµ‹è¯•çš„ç¼–å†™äº†ã€‚æµ‹è¯•ç¼–å†™çš„æ€è·¯å¤§è‡´æ˜¯ï¼š
è°ƒç”¨æƒ³è¦æµ‹è¯•çš„æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œä½¿ç”¨\texttt{assert\_eq!}æˆ–\texttt{assert!}å°†
å¾—åˆ°çš„ç»“æœä¸é¢„æœŸç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç»“æœä¸€è‡´ï¼Œè¯´æ˜å¯¹åº”å‡½æ•°ç¼–å†™æ­£ç¡®ã€‚å¯¹æ¨¡å—ä¸­çš„
æ¯ä¸ªå‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œè¿™æ ·å°±å®Œæˆäº†å¯¹ä¸€ä¸ªæ¨¡å—çš„æµ‹è¯•ã€‚

æœ€ç»ˆæˆ‘ä»¬å®Œæˆäº†alloc\_buddy0ã€alloc\_buddy1ã€global\_alloc0ã€gpu0ã€list0ã€lock0ã€
plat\_\linebreak thread\_context0ã€plat\_time0ã€rand0ã€rand1ã€sched\_coop0ã€sched\_coop1ã€
sched\_preem0ã€slist0ã€stailq0ã€tailq0ã€timeconv0å…±17ä¸ªæ¨¡å—çš„æµ‹è¯•ã€‚

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æˆ‘ä»¬ç¡®å®æ‰¾åˆ°äº†ä¸€äº›ä»£ç ä¸Šçš„é—®é¢˜å¹¶è¿›è¡Œäº†ä¿®å¤ï¼Œæµ‹è¯•ç³»ç»Ÿå®ç°å¾—å¾ˆæˆåŠŸã€‚

\section{é…ç½®ç³»ç»Ÿ}\sectionauthor{é™ˆå»ºç»¿}
å®ç°é…ç½®ç³»ç»Ÿçš„ç›®çš„æ˜¯å¯ä»¥è®©ç”¨æˆ·æ›´åŠ æ–¹ä¾¿åœ°æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡ŒæŸäº›å‚æ•°çš„é…ç½®ï¼Œ
æ¯”å¦‚\texttt{HEAP\_SIZE}ã€\texttt{STACK\_SIZE}ã€\texttt{LCPU\_MAXCOUNT}ã€
\texttt{PAGE\_SIZE}ç­‰ï¼Œ
è¿˜å¯ä»¥é€‰æ‹©å¯ç”¨æˆ–ç¦ç”¨å­æ¨¡å—ä¸­çš„featuresï¼Œæ¯”å¦‚\texttt{rkplat}ä¸­çš„å¦‚ä¸‹æ‰€ç¤ºçš„featureséƒ½å¯ä»¥è¿›è¡Œé€‰æ‹©é…ç½®ï¼š

\begin{lstlisting}[language=sh]
[features]
    has_smp = []            # å¯¹ç§°å¤šå¤„ç†å™¨æ”¯æŒ
    save_fp = []            # åœ¨çº¿ç¨‹åˆ‡æ¢æ—¶ä¿å­˜æµ®ç‚¹å¯„å­˜å™¨
    driver_uart = []        # ä¸²å£è®¾å¤‡é©±åŠ¨
    driver_ns16550 = ["driver_uart"]     # ns16550é©±åŠ¨
    driver_virtio = ["volatile", "bitflags"]
    driver_virtio_blk = ["driver_virtio"]
    driver_virtio_console = ["driver_virtio"]
    driver_virtio_gpu = ["driver_virtio"]
    driver_virtio_input = ["driver_virtio"]
    driver_virtio_net = ["driver_virtio"]
    driver_virtio_entropy = ["driver_virtio"]
    driver_virtio_all = ["driver_virtio_blk","driver_virtio_console","driver_virtio_gpu","driver_virtio_input","driver_virtio_net","driver_virtio_entropy"]
    driver_rtc = []         # çœŸå®æ—¶é—´æ—¶é’Ÿé©±åŠ¨
    driver_goldfish_rtc = ["driver_rtc"]
\end{lstlisting}

ç”¨æˆ·æ¥åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œä½¿ç”¨\texttt{make menuconfig}ä¾¿å¯ä»¥å¼€å¯\texttt{menuconfig}ç•Œé¢è¿›è¡Œé…ç½®ï¼š

\begin{figure}[H]
\centering
\includegraphics[width=0.8\linewidth]{assets/runikraft-menuconfig-1.png}
\caption{}
\label{fig:runikraft-menuconfig-1}
\end{figure}

é…ç½®ç³»ç»Ÿå¹¶ä¸æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œç”¨æˆ·å¯ä»¥ä¸ä½¿ç”¨menuconfigï¼Œç›´æ¥ä¿®æ”¹\texttt{default\_config.rs}ä¸­çš„ébool
å‹ç¼–è¯‘å‚æ•°ï¼Œé€šè¿‡æ ‡å‡†çš„cargoçš„.tomlè¯­æ³•å¼€å¯featuresã€‚

\subsection{å®ç°æ–¹æ³•}

é¦–å…ˆæ˜¯\texttt{kconfig}çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å‚è€ƒäº†Chamberlain\cite{bib:kconfig}çš„ä½¿ç”¨æ–¹å¼ï¼Œ
åœ¨\texttt{support/scripts}ä¸­å¤ç”¨ä»–çš„\texttt{build.Makefile}å’Œ\texttt{objects.Makefile}ï¼Œ
å¹¶å¼•å…¥ submodule https://github.com/linux-kdevops/kconfigåˆ°\texttt{kconfig}æ–‡ä»¶å¤¹ï¼Œ
ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æŒ‰ç…§ kconfig çš„è¯­æ³•ç¼–å†™å¯¹åº”çš„\texttt{Kconfig}æ–‡ä»¶ï¼š

\begin{lstlisting}
mainmenu "Runikraft/0.1.0 Configuration"

menu "Memory and CPU Configuration"
    config HEAP_SIZE
        int "Heap size(MiB)"
        default 16
    ...
    menu "Limit Configuration"
        ...
    endmenu

    ...
endmenu

menu "Library Configuration"
    source "lib/rkplat/config"
	source "lib/rkboot/config"
endmenu

...
endmenu
\end{lstlisting}

å…¶ä¸­ç”¨\texttt{source "lib/@libname@/config"}å¼•å…¥ç›¸åº”æ¨¡å—ä¸­å¯¹åº”çš„é…ç½®èœå•ã€‚
æ¯”å¦‚å­æ¨¡å—\texttt{rkplat}çš„é…ç½®èœå•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

\begin{figure}[H]
\centering
\includegraphics[width=0.7\linewidth]{assets/runikraft-menuconfig-2.png}
\caption{}
\label{fig:runikraft-menuconfig-2}
\end{figure}

è¿™æ ·æˆ‘ä»¬æœ€ç»ˆçš„é…ç½®ç»“æœå°±ä¼šä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸­çš„\texttt{.config}æ–‡ä»¶ä¸­ã€‚

åœ¨å¾—åˆ°\texttt{.config}æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥ä¾¿è¦è§£å†³å¦‚ä½•æ ¹æ®\texttt{.config}ä¸­çš„å†…å®¹è¿›è¡Œæ¡ä»¶ç¼–è¯‘ã€‚
\texttt{menuconfig}ç”Ÿæˆçš„\texttt{.config}æ–‡ä»¶å¤§è‡´æ˜¯ä¸‹é¢è¿™æ ·ï¼š

\begin{lstlisting}[language={[gnu]make}]
#
# Memory and CPU Configuration
#
CONFIG_HEAP_SIZE=16
...

#
# Limit Configuration
#
CONFIG_MEMORY_SIZE=-1
CONFIG_OPEN_FILES=1024
...
# end of Limit Configuration
...
# end of Memory and CPU Configuration
...
\end{lstlisting}

è¿™å¹¶ä¸æ–¹ä¾¿å¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬åªå¥½é‡‡ç”¨ä¸€äº›ä¸é‚£ä¹ˆé€šç”¨çš„æ–¹æ³•æ¥å®Œæˆæ–‡ä»¶çš„è¯»å–å’Œé…ç½®æ–‡ä»¶çš„è¾“å‡ºã€‚

ä¸Šé¢å·²ç»æåˆ°ï¼ŒRunikraft ä¸­æ˜¯æœ‰ä¸¤éƒ¨åˆ†é…ç½®å†…å®¹çš„ï¼Œä¸€éƒ¨åˆ†æ˜¯ä¸€äº›å…¨å±€å˜é‡çš„æ•°å€¼ï¼Œ
å¦ä¸€éƒ¨åˆ†æ˜¯å­æ¨¡å—ä¸­featuresçš„å¯ç”¨æˆ–ç¦ç”¨ã€‚

å…¨å±€å˜é‡çš„é»˜è®¤æ•°å€¼å­˜æ”¾åœ¨ä¸€ä¸ªåä¸º\texttt{default\_config.rs}çš„æ–‡ä»¶ä¸­ï¼Œ
æˆ‘ä»¬éœ€è¦æ ¹æ®\linebreak\texttt{.config}çš„å†…å®¹æ¥ç”Ÿæˆä¸€ä¸ªå’Œ\texttt{default\_config.rs}
çš„æ ¼å¼ä¸€æ ·çš„æ–‡ä»¶\texttt{\$\{CONFIG\_DIR\}/\linebreak config.rs}ï¼Œç„¶åå†æ‰§è¡Œ\texttt{cargo build}æ—¶ä¼ å…¥ç¯å¢ƒå˜é‡\texttt{RUNIKRAFT\_CONFIG\_FILE=\linebreak"\$\{CONFIG\_DIR\}/config.rs"}ï¼Œ
è¿™æ ·å®Œæˆäº†å…¨å±€å˜é‡æ•°å€¼çš„ä¸ªæ€§åŒ–é…ç½®ã€‚

featuresçš„å¯ç”¨ä½¿ç”¨çš„æ˜¯\texttt{--features @featurename@}åŠ åœ¨\texttt{cargo build}çš„
åé¢çš„æ–¹å¼ï¼ˆä¸åŠ åœ¨åé¢é»˜è®¤ç¦ç”¨ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦æ ¹æ®\texttt{.config}çš„å†…å®¹æ¥ç”Ÿæˆç±»ä¼¼äºä¸‹é¢è¿™æ ·çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š

\begin{lstlisting}
--features rkplat/has_smp --features rkplat/driver_uart --features rkplat/driver_ns16550 --features rkplat/driver_virtio --features rkplat/driver_virtio_blk --features rkplat/driver_virtio_console --features rkplat/driver_virtio_gpu --features rkplat/driver_virtio_input --features rkplat/driver_virtio_net --features rkplat/driver_rtc --features rkplat/driver_goldfish_rtc --features rkboot/have_scheduler --features rkboot/sched_coop
\end{lstlisting}

è¿™æ ·å°±å®Œæˆäº†å­æ¨¡å—featuresçš„å¯ç”¨æˆ–ç¦ç”¨ã€‚

è€Œä¸Šé¢çš„ä¸¤é¡¹è½¬æ¢å·¥ä½œæˆ‘ä»¬æ˜¯ç”¨ C++ ç¨‹åºæ¥å®ç°çš„ã€‚ä¸Šé¢å·²ç»æåˆ°ï¼Œmenuconfigç”Ÿæˆçš„\texttt{.config}æ–‡ä»¶å¹¶ä¸æ–¹ä¾¿å¤„ç†ï¼Œ
å› æ­¤æˆ‘ä»¬çš„ C++ ç¨‹åºé‡‡ç”¨çš„æ˜¯ä¸é‚£ä¹ˆé€šç”¨çš„æ–¹å¼æ¥å®Œæˆè½¬æ¢çš„ï¼Œ
è¯¦ç»†ä»£ç ä½äº\texttt{support/handle\_config.cpp}ä¸­ï¼Œè¿™é‡Œä¸å†å±•ç¤ºã€‚

\section{æ€»ç»“}
ç»è¿‡ä¸¤ä¸ªæœˆçš„ä¸æ‡ˆåŠªåŠ›ï¼Œæˆ‘ä»¬æœ€ç»ˆå®ç°äº†æ”¯æŒå¯¹ç§°å¤šå¤„ç†å™¨çš„æŠ¢å å¼çš„ RR è°ƒåº¦å™¨ã€
å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨ã€æ˜¾ç¤ºè®¾å¤‡é©±åŠ¨ã€ä¿¡å·é‡åŸè¯­ã€åŸºäºä¿¡ç®±çš„IPCç­‰cratesï¼Œ
æˆ‘ä»¬æ”¯æŒçš„è®¾å¤‡æœ‰ ns16550ã€goldfish-rtcã€virtio-blkã€virtio-consoleã€
virtio-rngã€virtio-gpuã€virtio-inputã€virtio-netã€‚
æˆ‘ä»¬è¿˜å®ç°äº†åŸºäº kconfig çš„åŠŸèƒ½å®šåˆ¶ç³»ç»Ÿã€‚å°½ç®¡æˆ‘ä»¬å®ç°çš„åŠŸèƒ½ä¸æœ€åˆçš„è®¾è®¡ä»æœ‰å·®è·ï¼Œä½†
å·²ç»è¶³ä»¥ç”¨Runikraftå†™å‡ºæœ‰å®ç”¨ä»·å€¼çš„ç¨‹åºäº†ã€‚ä¸ºäº†å±•ç¤º Runikraftï¼Œ
æˆ‘ä»¬å†™äº†åŸºäº Runikraft çš„æ•°ç‹¬ç¨‹åºï¼ˆå›¾\ \ref{fig:sudoku}ï¼‰ï¼Œå®ƒæ‹¥æœ‰ç®€å•çš„å›¾å½¢ç•Œé¢ï¼Œä½¿ç”¨äº† \texttt{rkallocbuddy}ã€\texttt{rkschedpreem}ã€\texttt{rklock}ã€\texttt{rkgpudev}ç­‰ cratesï¼Œ
èƒ½å¤Ÿæ¯”è¾ƒå…¨é¢åœ°å±•ç¤º Runikraft çš„åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨ release é…ç½®æ„å»ºæ—¶ï¼Œæ•°ç‹¬ç¨‹åºçš„é•œåƒå¤§å°åªæœ‰ 100KiBï¼Œç”±æ­¤
å¯è§ï¼Œå¼•å…¥å›¾å½¢ç•Œé¢ä¸ä¼šæ˜¾è‘—å¢å¤§é•œåƒçš„å¤§å°ï¼Œè¿™å¯¹æ‹“å®½Unikernelsçš„åº”ç”¨èŒƒå›´æœ‰ç§¯ææ„ä¹‰ã€‚

\begin{figure}[tbh!]
\centering
\includegraphics[width=0.6\linewidth]{assets/sudoku}
\caption{æ•°ç‹¬ç¨‹åº}
\label{fig:sudoku}
\end{figure}


Runikrafté‡‡ç”¨äº†å…¨æ–°çš„æ–¹å¼ç»„ç»‡ç³»ç»Ÿï¼Œç³»ç»Ÿç”±ç‹¬ç«‹çš„cratesç»„æˆï¼Œæ¯ä¸ªcrateéƒ½å¯ä»¥ç‹¬ç«‹å‘å¸ƒå’Œå®‰è£…ã€‚
è¿™å¯¹ç›®å‰çš„è‡ªç”±æ“ä½œç³»ç»Ÿçš„å¼€å‘å’Œå‘å¸ƒæœ‰å€Ÿé‰´æ„ä¹‰ã€‚

åœ¨Rust 1.59ä¹‹å‰ï¼Œå†…è”æ±‡ç¼–ä¸èƒ½åœ¨stable channelçš„ç¼–è¯‘å™¨ä¸­ä½¿ç”¨ï¼Œä½¿å¾—ç”¨stable Rustå†™æ“ä½œç³»ç»Ÿå˜å¾—ä¸å¯èƒ½ã€‚
åœ¨Rust 1.59å‘å¸ƒåæ‰å¼€å§‹å¼€å‘çš„Runikraftæ˜¯æˆ‘ä»¬å·²çŸ¥çš„å”¯ä¸€çš„
ç”¨stable Rustå¼€å‘çš„æ“ä½œç³»ç»Ÿã€‚Runikraftçš„æˆåŠŸå¼€å‘æ„å‘³ç€ç”¨Rustå†™æ“ä½œç³»ç»Ÿä¸å†æ˜¯è¯•éªŒæ€§åŠŸèƒ½ï¼Œ
æ ‡å¿—ç€Rustå·²ç»èƒ½èƒœä»»æ“ä½œç³»ç»Ÿçš„å¼€å‘ã€‚

\section{ç›¸å…³å·¥ä½œ}

\subsection{å®‰å…¨å®¹å™¨}\sectionauthor{è“ä¿Šç®}
ã€Šé¡¹ç›®èƒŒæ™¯ã€‹ä¸­å·²æŒ‡å‡ºï¼Œå®¹å™¨æ˜¯äº‘è®¡ç®—é¢†åŸŸçš„å¸¸ç”¨çš„éš”ç¦»æ‰‹æ®µï¼Œè€Œç”±äºå®¹å™¨å¹¶ä¸æ˜¯æ²™ç›’ï¼Œ
å®ƒæä¾›çš„éš”ç¦»èƒ½åŠ›ä¸è¶³ä»¥è¿è¡Œæ½œåœ¨çš„æ¶æ„ä»£ç ï¼Œå®‰å…¨å®¹å™¨åº”è¿è€Œç”Ÿã€‚ä»è®¾è®¡ç›®æ ‡çœ‹ï¼Œå®‰å…¨
å®¹å™¨çš„éš”ç¦»èƒ½åŠ›ä¸unikernelsç­‰åŒã€‚å®‰å…¨å®¹å™¨çš„ç›®æ ‡æ˜¯èƒ½å¤Ÿç›´æ¥è¿è¡ŒELFäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
è€Œunikernelsé€šå¸¸è¦æ±‚ä»æºä»£ç é‡æ–°ç¼–è¯‘ã€‚

Kata Containerså’ŒgVisoréƒ½ä½¿ç”¨Goè¯­è¨€å®ç°ã€‚

Kata Containersçš„å®ç°æ€è·¯æ˜¯è½»é‡çº§è™šæ‹Ÿæœºï¼Œå®ƒæ˜¯å®¹å™¨å‘uniKernelçš„è¿‡æ¸¡ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯\cite{bib:kata}ï¼š
\begin{description}
\item[å®‰å…¨] Runs in a dedicated kernel, providing isolation of network,
I/O and memory and can utilize hardware-enforced isolation with virtualization VT extensions.
\item[å…¼å®¹] Supports industry standards including OCI container format,
Kubernetes CRI interface, as well as legacy virtualization technologies.
\item[é«˜æ•ˆ] Delivers consistent performance as standard Linux containers;
increased isolation without the performance tax of standard virtual machines.
\item[ç®€æ´] Eliminates the requirement for nesting containers inside full
blown virtual machines; standard interfaces make it easy to plug in and get started.
\end{description}

gVisorçš„å®ç°æ€è·¯æ˜¯åŠè™šæ‹ŸåŒ–æ“ä½œç³»ç»Ÿï¼Œå®ƒåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œä»¥æ‹¦æˆªç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ä¸º
åº”ç”¨ç¨‹åºæä¾›æœåŠ¡ã€‚å®ƒä¸ä¼ ç»Ÿå®¹å™¨çš„å…³é”®åŒºåˆ«æ˜¯æ²¡æœ‰ç®€å•åœ°å°†åº”ç”¨ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨é‡å®šå‘
ç»™å®¿ä¸»æœºå†…æ ¸ï¼Œè€Œæ˜¯å®ç°äº†å¤§å¤šæ•°å†…æ ¸åŸè¯­ï¼Œå¹¶åŸºäºè¿™äº›åŸè¯­å®ç°ç³»ç»Ÿè°ƒç”¨ã€‚gVisorä¸unikernelçš„
åŒºåˆ«æ˜¯gVisoræ²¡æœ‰æ¨¡æ‹Ÿç¡¬ä»¶ï¼Œè€Œåªæ˜¯æ¨¡æ‹Ÿäº†ä¸€ä¸ªLinuxå†…æ ¸ï¼›
unikernelæœ¬èº«æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨è™šæ‹Ÿç¡¬ä»¶ä¸Šçš„æ“ä½œç³»ç»Ÿã€‚
gVisorçš„ç‰¹ç‚¹ï¼š\cite{bib:gvisor}
\begin{description}
\item[å®¹å™¨åŸç”Ÿå®‰å…¨] By providing each container with its own application kernel, gVisor limits the attack surface of the host. This protection does not limit functionality: gVisor runs unmodified binaries and integrates with container orchestration systems, such as Docker and Kubernetes, and supports features such as volumes and sidecars.

\item[èµ„æºé«˜æ•ˆ] Containers are efficient because workloads of different shapes and sizes can be packed together by sharing host resources. gVisor uses host-native abstractions, such as threads and memory mappings, to co-operate with the host and enable the same resource model as native containers.

\item[è·¨å¹³å°] Modern infrastructure spans multiple cloud services and data centers, often with a mix of managed services and virtualized or traditional servers. The pluggable platform architecture of gVisor allows it to run anywhere, enabling consistent security policies across multiple environments without having to rearchitect your infrastructure.
\end{description}

\subsection{åµŒå…¥å¼ç³»ç»Ÿ}\sectionauthor{é™ˆå»ºç»¿}
å¤§éƒ¨åˆ†unikernelsåªæ‰“ç®—åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œï¼Œä½†æ˜¯IncludeOSå’ŒRumprunæ”¯æŒåœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šè¿è¡Œï¼Œ
å¾€å¹´çš„ridiculous-includeoså°ç»„ä¹Ÿåšè¿‡å°†unikernelç§»æ¤åˆ°åµŒå…¥å¼è®¾å¤‡çš„ç ”ç©¶ã€‚
å¯è§åµŒå…¥å¼è®¾å¤‡ä¹Ÿæ˜¯unikernelæ½œåœ¨çš„åº”ç”¨é¢†åŸŸã€‚åµŒå…¥å¼ç³»ç»Ÿçš„ç±»å‹ä¸°å¯Œå¤šæ ·ï¼Œè¿™é‡Œç€é‡ä»‹ç»ç‰©è”ç½‘ï¼ˆIoTï¼‰ç³»ç»Ÿã€‚

ç›®å‰ï¼Œç‰©è”ç½‘æ“ä½œç³»ç»Ÿä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œä¸€æ˜¯ç”±ä¼ ç»Ÿçš„åµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿ(RTOS)å‘å±•è€Œæ¥ï¼Œ
æ¯”å¦‚FreeRTOSã€LiteOSã€RT-Threadï¼›äºŒæ˜¯ç”±äº’è”ç½‘å…¬å¸çš„äº‘å¹³å°å»¶ä¼¸è€Œæ¥ï¼Œ
åŸºäºä¼ ç»Ÿæ“ä½œç³»ç»Ÿè¿›è¡Œâ€œå‰ªè£â€å’Œå®šåˆ¶çš„IoT OSï¼Œæ¯”å¦‚Ali OS Thingsã€TencentOS tinyã€Win10 IOTã€‚\cite{bib:iot-sys}

\href{https://github.com/OpenAtomFoundation/TencentOS-tiny}{TencentOS Tiny} æ˜¯è…¾è®¯
é¢å‘ç‰©è”ç½‘é¢†åŸŸå¼€å‘çš„å®æ—¶æ“ä½œç³»ç»Ÿï¼Œå…·æœ‰ä½åŠŸè€—ï¼Œä½èµ„æºå ç”¨ï¼Œæ¨¡å—åŒ–ï¼Œå®‰å…¨å¯é ç­‰ç‰¹ç‚¹ï¼Œ
å¯æœ‰æ•ˆæå‡ç‰©è”ç½‘ç»ˆç«¯äº§å“å¼€å‘æ•ˆç‡ã€‚

TencentOS tiny æä¾›ç²¾ç®€çš„ RTOS å†…æ ¸ï¼Œå†…æ ¸ç»„ä»¶å¯è£å‰ªå¯é…ç½®ï¼Œ
å¯å¿«é€Ÿç§»æ¤åˆ°å¤šç§ä¸»æµ MCU (å¦‚ STM32 å…¨ç³»åˆ—)åŠæ¨¡ç»„èŠ¯ç‰‡ä¸Šã€‚è€Œä¸”ï¼Œ
åŸºäº RTOS å†…æ ¸æä¾›äº†ä¸°å¯Œçš„ç‰©è”ç½‘ç»„ä»¶ï¼Œå†…éƒ¨é›†æˆä¸»æµç‰©è”ç½‘åè®®æ ˆ
ï¼ˆå¦‚CoAP/MQTT/TLS/DTLS/LoRaWAN/NB-IoTç­‰ï¼‰ï¼Œå¯åŠ©åŠ›ç‰©è”ç½‘ç»ˆç«¯è®¾å¤‡åŠ
ä¸šåŠ¡å¿«é€Ÿæ¥å…¥è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°ã€‚

\href{https://github.com/ms-rtos}{MS-RTOS} (Micro Safe RTOS) æ˜¯ç¿¼è¾‰ä¿¡æ¯å…¨æ–°è®¾è®¡çš„ä¸€æ¬¾é¢å‘æœªæ¥çš„
å®‰å…¨å®æ—¶æ“ä½œç³»ç»Ÿï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯å¼€åˆ›æ€§åœ°åœ¨æ²¡æœ‰ MMU å’Œèµ„æºå—é™çš„ MCUï¼ˆå¦‚Cortex-M3ï¼‰ä¸Šä¹Ÿèƒ½æ”¯æŒå¤šè¿›ç¨‹ä¸åŠ¨æ€è£…è½½æŠ€æœ¯ï¼Œä½¿å¾—åº”ç”¨ä¸ç³»ç»Ÿèƒ½åˆ†ç¦»å¼€å‘ã€ç‹¬ç«‹å‡çº§ï¼›
MS-RTOS æ”¯æŒå†…æ ¸ç©ºé—´å†…å­˜ä¿æŠ¤ï¼ˆåº”ç”¨ç¨‹åºé€šè¿‡ syscall è®¿é—®å†…æ ¸ï¼‰ï¼Œ
ä½¿å¾—å†…æ ¸æœ‰ç€éå¸¸é«˜çš„å®‰å…¨æ€§ã€‚MS-RTOS åœ¨æä¾›è¶³å¤Ÿä¸°å¯ŒåŠŸèƒ½çš„åŒæ—¶ï¼Œä¿æŒäº†é«˜æ•ˆç®€æ´çš„å®ç°ï¼Œ
å¯¹ ROMã€RAM æ¶ˆè€—æä½ï¼Œç‰¹åˆ«é€‚ç”¨äºå¯¹ç¡¬ä»¶æˆæœ¬æ•æ„Ÿã€å®‰å…¨æ€§è¦æ±‚ç‰¹åˆ«é«˜çš„äº§å“ã€‚\cite{bib:ms-rtos}

\begin{description}
\item[å¤šè¿›ç¨‹] å…è®¸è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ç”¨æˆ·ä»£ç å·¥ä½œåœ¨ CPU ç”¨æˆ·æ€ï¼Œ
é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰è®¿é—®å†…æ ¸èµ„æºï¼Œåˆ©ç”¨ MPU å®ç°è¿›ç¨‹åœ°å€ç©ºé—´ç›¸äº’éš”ç¦»ã€‚
\item[åŠ¨æ€è£…è½½] é©±åŠ¨ä¸åº”ç”¨ç¨‹åºåˆ†ç¦»å¼€å‘ï¼Œåº”ç”¨ä¸ç³»ç»Ÿç‹¬ç«‹å‡çº§ï¼Œ
åº”ç”¨ç¨‹åºç›´æ¥åœ¨ FLASH ä¸­è¿è¡Œï¼ˆæ— éœ€åŠ è½½åˆ° RAM æ‰§è¡Œï¼ŒèŠ‚çº¦ RAMï¼Œè¿è¡Œé€Ÿåº¦æ›´å¿«ï¼‰ã€‚
\item[å†…æ ¸å®‰å…¨] è¿›ç¨‹ç”¨æˆ·ä»£ç å·¥ä½œåœ¨ CPU ç”¨æˆ·æ€ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨
ï¼ˆsyscallï¼‰è¿›å…¥å†…æ ¸, ä¿æŠ¤å†…æ ¸ä¸è¢«è¿›ç¨‹ç ´åï¼Œåˆ©ç”¨ MPU åšåˆ°è¿›ç¨‹åœ°å€ç©ºé—´ç›¸äº’éš”ç¦»,
è¿›ç¨‹å½±å“èŒƒå›´æœ€å°åŒ–ï¼Œæ‰ç”µå®‰å…¨æ–‡ä»¶ç³»ç»Ÿã€‚
\end{description}
\subsection{ç”¨Rustç¼–å†™çš„æ“ä½œç³»ç»Ÿ}
Rustè¯­è¨€çš„ç›®æ ‡ä¹‹ä¸€å°±æ˜¯å–ä»£Cè¯­è¨€ï¼Œæˆä¸ºç”¨äºç³»ç»Ÿå¼€å‘çš„åº•å±‚è¯­è¨€ã€‚ç›®å‰å·²æœ‰å¤§é‡ç”¨Rustå¼€å‘çš„æ“ä½œç³»ç»Ÿï¼š\cite{bib:rust-os-comparison}

\begin{longtable}{|>{\bfseries}l|p{0.11\linewidth}|p{0.02\linewidth}|p{0.02\linewidth}|p{0.08\linewidth}|p{0.06\linewidth}|p{0.02\linewidth}|p{0.02\linewidth}|p{0.05\linewidth}|p{0.08\linewidth}|p{0.08\linewidth}|}
\caption{ç”¨Rustå®ç°çš„æ“ä½œç³»ç»Ÿæ¯”è¾ƒ}\\
\hline
åç§°&\textbf{æ¶æ„}&\textbf{çº¯} \rotatebox[origin=c]{-90}{\textbf{Rust}}&\textbf{æ´»è·ƒ}&\textbf{å†…æ ¸æ¶æ„}&\textbf{ç›®æ ‡}&\textbf{ç”¨æˆ·æ€}&\rotatebox{-90}{\textbf{GUI}}&\textbf{è´¡çŒ®è€…æ•°}&\textbf{æ–‡ä»¶ç³»ç»Ÿ}&\textbf{è®¸å¯}\\\hline
\endfirsthead
\hline
åç§°&\textbf{æ¶æ„}&\textbf{çº¯} \rotatebox[origin=c]{-90}{\textbf{Rust}}&\textbf{æ´»è·ƒ}&\textbf{å†…æ ¸æ¶æ„}&\textbf{ç›®æ ‡}&\textbf{ç”¨æˆ·æ€}&\rotatebox{-90}{\textbf{GUI}}&\textbf{è´¡çŒ®è€…æ•°}&\textbf{æ–‡ä»¶ç³»ç»Ÿ}&\textbf{è®¸å¯}\\\hline
\endhead
redox&x86-32\newline x86-64&æ˜¯&æ˜¯&å¾®å†…æ ¸&é€šç”¨&æ˜¯&æ˜¯&50&ZFS\newline RedoxFS&MIT\\\hline
Theseus OS&x86-64\newline ARM WIP&æ˜¯&æ˜¯&Safe-language SAS/SPL OS&é€šç”¨+åµŒå…¥å¼&&æ˜¯&25&Custom\newline FAT32&MIT\\\hline
Tock&Cortex M&&æ˜¯&&&&å¦&40&&APL 2/\newline MIT\\\hline
intermezzOS&x86-64&å¦&æ˜¯&ï¼Ÿ&PoC&å¦&å¦&18&æ— &APL 2/\newline MIT\\\hline
RustOS&x86-32&ï¼Ÿ&æ˜¯&æ— &PoC&å¦&å¦&10&æ— &APL 2/\newline MIT\\\hline
rustboot&x86-32&ï¼Ÿ&å¦&æ— &PoC&å¦&å¦&8&æ— &MIT\\\hline
\end{longtable}

å…¶ä¸­çš„Redoxæ˜¯ä¸€æ¬¾åŠŸèƒ½å®Œæ•´çš„ç±»UNIXæ“ä½œç³»ç»Ÿï¼Œè€Œä¸åªæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå®ƒåŒ…å«Cæ ‡å‡†åº“ã€
çª—å£ç®¡ç†å™¨ã€æµè§ˆå™¨ã€æ–‡æœ¬ç¼–è¾‘å™¨ã€å›¾åƒæŸ¥çœ‹å™¨ã€ç»ˆç«¯æ¨¡æ‹Ÿå™¨ç­‰ä¼—å¤šè½¯ä»¶åŒ…ã€‚

\section*{è®¸å¯åè®®}\markboth{è®¸å¯åè®®}
æœ¬æ–‡æ¡£ä»¥çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™… (CC BY 4.0)è®¸å¯è¯å‘å¸ƒã€‚

\vspace{2ex}
\noindent\textbf{\large æ‚¨å¯ä»¥è‡ªç”±åœ°}ï¼š
\begin{description}
\item[å…±äº«] åœ¨ä»»ä½•åª’ä»‹ä»¥ä»»ä½•å½¢å¼å¤åˆ¶ã€å‘è¡Œæœ¬ä½œå“ï¼›
\item[æ¼”ç»] ä¿®æ”¹ã€è½¬æ¢æˆ–ä»¥æœ¬ä½œå“ä¸ºåŸºç¡€è¿›è¡Œåˆ›ä½œ
åœ¨ä»»ä½•ç”¨é€”ä¸‹ï¼Œç”šè‡³å•†ä¸šç›®çš„ã€‚
\end{description}

\vspace{2ex}
\noindent\textbf{\large æƒŸé¡»éµå®ˆä¸‹åˆ—æ¡ä»¶}ï¼š
\begin{description}
\item[ç½²å] æ‚¨å¿…é¡»ç»™å‡ºé€‚å½“çš„ç½²åï¼Œæä¾›æŒ‡å‘æœ¬è®¸å¯åè®®çš„é“¾æ¥ï¼Œ
åŒæ—¶æ ‡æ˜æ˜¯å¦ï¼ˆå¯¹åŸå§‹ä½œå“ï¼‰ä½œäº†ä¿®æ”¹ã€‚æ‚¨å¯ä»¥ç”¨ä»»ä½•åˆç†çš„æ–¹å¼æ¥ç½²åï¼Œ
ä½†æ˜¯ä¸å¾—ä»¥ä»»ä½•æ–¹å¼æš—ç¤ºè®¸å¯äººä¸ºæ‚¨æˆ–æ‚¨çš„ä½¿ç”¨èƒŒä¹¦ã€‚
\item[æ²¡æœ‰é™„åŠ é™åˆ¶] æ‚¨ä¸å¾—ä½¿ç”¨æ³•å¾‹æœ¯è¯­æˆ–è€…æŠ€æœ¯æªæ–½ï¼Œä»è€Œé™åˆ¶å…¶ä»–äºº
åšè®¸å¯åè®®å…è®¸çš„äº‹æƒ…ã€‚
\end{description}

\vspace{2ex}
\noindent\textbf{\large å£°æ˜}ï¼š

æ‚¨ä¸å¿…å› ä¸ºå…¬å…±é¢†åŸŸçš„ä½œå“è¦ç´ è€Œéµå®ˆè®¸å¯åè®®ï¼Œæˆ–è€…æ‚¨çš„ä½¿ç”¨è¢«å¯é€‚ç”¨çš„ä¾‹å¤–æˆ–é™åˆ¶æ‰€å…è®¸ã€‚

ä¸æä¾›æ‹…ä¿ã€‚è®¸å¯åè®®å¯èƒ½ä¸ä¼šç»™ä¸æ‚¨æ„å›¾ä½¿ç”¨çš„æ‰€å¿…é¡»çš„æ‰€æœ‰è®¸å¯ã€‚
ä¾‹å¦‚ï¼Œå…¶ä»–æƒåˆ©æ¯”å¦‚å½¢è±¡æƒã€éšç§æƒæˆ–äººæ ¼æƒå¯èƒ½é™åˆ¶æ‚¨å¦‚ä½•ä½¿ç”¨ä½œå“ã€‚

æœ¬è®¸å¯è¯çš„å…¨æ–‡ä½äºï¼š\\
\centerline{\url{https://creativecommons.org/licenses/by/4.0/legalcode.zh-Hans}}


\begin{thebibliography}{99}
\bibitem{bib:feasibility-7} Steve Klabink. \textit{The Rust Programming Language}[M]. The Rust Community, 2019.
\bibitem{bib:feasibility-3} å¼ æ±‰ä¸œ. \textit{æ•…äº‹ï¼šRuståœ¨ä¼ä¸šé¢†åŸŸçš„åº”ç”¨}[Z/OL]. çŸ¥ä¹ä¸“æ , 2019 (20190404) [2022-07-09] \url{https://web.archive.org/web/20220709104447/https://zhuanlan.zhihu.com/p/61410107}
\bibitem{bib:feasibility-0} \textit{About RISC-V}[Z/OL]. RISC-V International, 2021. \url{https://riscv.org/about/}
\bibitem{bib:feasibility-2} admin. \textit{RISC-Vå¼€æºæŒ‡ä»¤é›†æ¶æ„ç®€ä»‹ä¸åº”ç”¨å‰æ™¯åˆ†æ}[Z/OL]. ScenSmartä¸€ç«™å¼æ™ºèƒ½åˆ¶é€ å¹³å°, 2019 (20191102) [2022-04-15]. \url{http://www.scensmart.com/news/the-introduction-of-risc-v-and-application-prospect-analysis/}

\bibitem{bib:os-concept} Abraham Silberschatz, Peter B. Galvin and Greg Gagne.
\textit{æ“ä½œç³»ç»Ÿæ¦‚å¿µ}[M]. éƒ‘æ‰£æ ¹, å”æ°, æå–„å¹³\ è¯‘. åŒ—äº¬: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2021: 54-58.

\bibitem{bib:docker-security-selinux} Daniel J Walsh. \texttt{Are Docker containers really secure?}[Z/OL]. Opensource.com, 2014 (20140622) [2022-04-10]. \url{https://opensource.com/business/14/7/docker-security-selinux}

\bibitem{bib:unikernel}
\textit{Unikernels: Rethinking Cloud Infrastructure}[Z/OL].
@unikernel [2022-02-18]. \url{https://web.archive.org/web/20220218194213/http://unikernel.org/}

\bibitem{bib:unikraft} Simon Kuenzer, Vlad-Andrei BÄƒdoiu, Hugo Lefeuvre, Sharan Santhanam,
Alexander Jung, Gaulthier Gain, Cyril Soldani, Costin Lupu, \c{S}tefan Teodorescu, Costi RÄƒducanu,
Cristian Banu, Laurent Mathy, RÄƒzvan Deaconescu, Costin Raiciu and Felipe Huici.
\textit{Unikraft: Fast, Specialized Unikernels the Easy Way}[J/OL]. EuroSys '21, 2021, April: 26â€“29
[2022-03-27]. \url{https://dl.acm.org/doi/10.1145/3447786.3456248} \texttt{doi:10.1145/3447786.3456248}.

\bibitem{bib:unikernel-secuirty} Spencer Michaels and Jeff Dileo. \textit{Assessing Unikernel Security
}[R/OL]. Version 1.0. NCC Group, 2019: 4-10 [2022-03-27].
\url{https://research.nccgroup.com/wp-content/uploads/2020/07/ncc_group-assessing_unikernel_security.pdf}

\bibitem{bib:3-why-rust-pop}
Jake Goulding. \textit{What is Rust and why is it so popular?}[Z/OL]. Stack Overflow Blog. 2020 (20200120) [2022-03-24]. \url{https://web.archive.org/web/20220324021421/https://stackoverflow.blog/2020/01/20/what-is-rust-and-why-is-it-so-popular/}
\bibitem{bib:4-rust-go-cmp} CharyGao. \textit{ä¹Ÿè®¸æ˜¯æœ€å®¢è§‚ã€å…¨é¢çš„æ¯”è¾ƒ Rust ä¸ Goï¼šéƒ½æƒ³æŠŠ Rust ä¹Ÿå­¦ä¸€ä¸‹}[Z/OL]. åšå®¢å›­. 2020 (20201207) [2022-03-29]. \url{https://web.archive.org/web/20220329090604/https://www.cnblogs.com/Chary/p/14097609.html}
\bibitem{bib:5-why-rust2} é»„å…‰æ˜Ÿ. \textit{ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Rust è¯­è¨€ï¼ŸRust è¯­è¨€çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ}[Z/OL].
2020 (20200513) [2022-03-29] \url{https://www.zhihu.com/question/393796866}
\bibitem{bib:6-why-rust-pop-2} Krzysztof WrÃ³bel. \textit{Rust programming language - what is rust used for and why is so popular?}[Z/OL]. codilime, 2022 (20220325) [2022-03-25]. \url{https://codilime.com/blog/why-is-rust-programming-language-so-popular/}
\bibitem{bib:7-rust-by-num} Pavan Belagatti.[\textit{Rust by the Numbers: The Rust Programming Language in 2021}[Z/OL]. The New Stack. 2021 (20210512) [2022-03-25]. \url{https://thenewstack.io/rust-by-the-numbers-the-rust-programming-language-in-2021/}
\bibitem{bib:8-rust-compatibility} \textit{Rust By Example}[M/OL]. Compatibility [2022-03-26]. \url{https://web.archive.org/web/20220326130141/https://doc.rust-lang.org/rust-by-example/compatibility.html}

\bibitem{bib:riscv-support} Jeff Tranter. \textit{What is RISC-V and Why is it Important?}[Z/OL]. ICS. 2021 (20210512) [2022-03-27]. \url{https://www.ics.com/blog/what-risc-v-and-why-it-important}
\bibitem{bib:riscv-gcc} \textit{Using the GNU Compilers Collections (GCC)}[G/OL]. 2021: RISC-V Options [2022-03-27]. \url{https://gcc.gnu.org/onlinedocs/gcc-11.2.0/gcc/RISC-V-Options.html#RISC-V-Options}
\bibitem{bib:riscv-llvm} \textit{Clang command line argument reference: Clang 15.0.0git documentation}[G/OL]. 2022: RISCV [2022-03-27] \url{https://clang.llvm.org/docs/ClangCommandLineReference.html#riscv}
\bibitem{bib:riscv-linux} Drew Fustini. \textit{Linux on RISC-V
with Open Hardware}[Z/OL]. Embedded Linux Conference, 2020 [2022-03-27]. \url{https://elinux.org/images/3/3d/Linux_riscv_elce2020.pdf}
\bibitem{bib:riscv-debian} \textit{RISC-V}[G/OL]. Debian Wiki, 2022 (2022-03-24) [2022-03-27]. \url{https://wiki.debian.org/RISC-V?action=recall&rev=151}

\bibitem{bib:riscv-spec1} \textit{The RISC-V Instruction Set Manual
Volume I: Unprivileged ISA}[S/OL]. Editors Andrew Waterman and Krste AsanoviÄ‡. Version 2.1. RISC-V Foundation, 2019 (20191213) [2022-03-25]. \url{https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf}
\bibitem{bib:riscv-spec2} \textit{The RISC-V Instruction Set Manual
Volume II: Privileged Architecture}[S/OL]. Editors Andrew Waterman, Krste AsanoviÄ‡ and John Hauser.
Version 1.9.1. RISC-V International, 2021 (20211204) [2022-03-27]. \url{https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf}
\bibitem{bib:riscv-spec3} \textit{RISC-V Debug Support
}[S/OL]. Editors Ernie Edgar and Tim Newsome. Version 1.0.0-Stable. SiFive, Inc., 2022(20220209)[2022-03-27]. \url{https://github.com/riscv/riscv-debug-spec/raw/b659d7dc7f578e1a2a76f9e62a5eec0f2d80045c/riscv-debug-stable.pdf}
\bibitem{bib:riscv-spec4} \textit{RISC-V Processor Trace}[S/OL]. Gajinder Panesar and
Iain Robertson. Version 1.0. UltraSoC Technologies Ltd., 2020(20200320)[2022-03-27]. \url{https://github.com/riscv/riscv-trace-spec/raw/e372bd36abc1b72ccbff31494a73a862367cbb29/riscv-trace-spec.pdf}

\bibitem{bib:amd64-manual} \textit{AMD64 Architecture Programmer's Manual: Volumes 1-5}[S/OL]. Revision 4.04, Advanced Micro Devices, Inc., 2021 (202111) [2022-03-27]. \url{https://www.amd.com/system/files/TechDocs/40332.pdf}
\bibitem{bib:amd64-manual-intel} \textit{Intel\textsuperscript{Â®} 64 and IA-32 Architectures Software Developerâ€™s Manual}[S/OL]. Order Number: 325462-076US, Intel Corporation, 2021 (202112) [2022-03-27]. \url{https://cdrdv2.intel.com/v1/dl/getContent/671200}

\bibitem{bib:armv8-reference} \textit{Arm\textsuperscript{Â®} Architecture Reference Manual
for A-profile architecture}[S/OL]. Version 21.0, Arm Limited, 2022 [2022-03-27]. \url{https://developer.arm.com/documentation/ddi0487/latest}

\bibitem{bib:12-clickos} Joao Martins, Mohamed Ahmed, Costin Raiciu, Vladimir Olteanu,
Michio Honda, Roberto Bifulco and Felipe Huici. \textit{ClickOS and the Art of Network Function Virtualization}[C/OL]. 11th USENIX Symposium on Networked Systems
Design and Implementation. Seattle: USENIX Association. 2014: 459-473[2022-03-22]. \url{http://cnp.neclab.eu/projects/clickos/clickos.pdf}
\bibitem{bib:13-clickos2} Joao Martins, Mohamed Ahmed, Costin Raiciu and Felipe Huici.
\textit{Enabling Fast, Dynamic Network Processing with ClickOS}[J/OL]. HotSDN'13, 2013, August: 67-72[2022-03-22]. \url{http://cnp.neclab.eu/projects/clickos/clickos-workshop.pdf}

\bibitem{bib:11-unikerel2} Anil Madhavapeddy and David J. Scott. \textit{Unikernels: Rise of the Virtual Library Operating System}[J/OL]. ACM Queue, 2014, 11 [2022-03-22].  \url{https://queue.acm.org/detail.cfm?id=2566628}

\bibitem{bib:9-includeos}  Bratterud et al. \textit{IncludeOS: A minimal, resource efficient unikernel for cloud systems}[G/OL]. Adrian Colyer, The morning paper: a random walk through Computer Science research. 2016 (20160222) [2022-03-22]. \url{https://blog.acolyer.org/2016/02/22/includeos}
\bibitem{bib:10-includeos2} Nur Hussein. \textit{IncludeOS: a unikernel for C++ applications}[Z/OL]. 2017 (20170725) [2022-03-22]. \url{https://lwn.net/Articles/728682/}

\bibitem{bib:14-rusty-hermit} \textit{RustyHermit - A Rust-based, lightweight unikernel}[G/OL]. rusty-hermit 0.3.10. [2022-03-25]. \url{https://docs.rs/crate/rusty-hermit/0.3.10}
%\bibitem{bib:15-rust-runtime} Jason äºèˆª. \textit{Rust Runtime ä¸ ABI}[M/OL]. çŸ¥ä¹ä¸“æ , 2021 (20210509) [2022-03-25] \url{https://zhuanlan.zhihu.com/p/370897059}
%\bibitem{bib:16-rust-runtime2} \textit{The Rust runtime}[G/OL]. The Rust Reference. [2022-03-17].
%\url{https://web.archive.org/web/20220317124224/https://doc.rust-lang.org/reference/runtime.html}
\bibitem{bib:17-rusty-hermit2} @stlankes. \textit{The \texttt{RustyHermit} Unikernel}[Z/OL]. Rust OSDev. 2021 (20210122) [2022-03-25]. \url{https://rust-osdev.com/showcase/rusty-hermit/}

\bibitem{bib:18-intra-unikernel} Mincheol Sung and Pierre Olivier. \textit{Intra-Unikernel Isolation with Intel Memory Protection Keys}[C/OL]. 16th ACM SIGPLAN/SIGOPS International Conference on Virtual Execution Environments. Lausanne: Association for Computing Machinery, 2022. \texttt{doi:10.1145/3381052.3381326}.
\bibitem{bib:19-mpk} \textit{Memory Protection Keys}[G/OL]. The Linux Kernel, 5.17.0. [2022-03-18]. \url{https://web.archive.org/web/20220318143208/https://www.kernel.org/doc/html/latest/core-api/protection-keys.html}
%\bibitem{bib:20-linux-kernel} Huoçš„è—ç»é˜. \textit{linuxå†…æ ¸é‚£äº›äº‹ä¹‹Memory protection keys(ç¡¬ä»¶åŸç†)}[Z/OL]. CSDNåšå®¢. 2021 (20211119) [2022-03-25]. \url{https://blog.csdn.net/weixin_42730667/article/details/121386896}
\bibitem{bib:21-rump-kernel} Wikipedia Contributors. \textit{Rump kernel}[G/OL]. Wikipedia, 2021 (20210903) [2022-03-29]. \url{https://en.wikipedia.org/w/index.php?title=Rump_kernel&oldid=1042218732}
\bibitem{bib:22-xen} Antti Kantee. \textit{Xen on Rump Kernels and the Rumprun Unikernel}[Z/OL]. XenProject, 2015 (20150806) [2021-08-18].  \url{https://web.archive.org/web/20210818101601/https://xenproject.org/2015/08/06/on-rump-kernels-and-the-rumprun-unikernel/}

\bibitem{bib:23-mirageos} Mircea Cosbuc. \textit{All About Unikernels: Part 2, Two Different Approaches, MirageOS and Rumprun}[Z/OL]. Container Solutions, 2020 (20200125) [2022-01-27]. \url{https://web.archive.org/web/2021*/https://blog.container-solutions.com/all-about-unikernels-part-2-mirageos-and-rumprun}
\bibitem{bib:24-rumrun} Sebastian Wicki. \textit{The Rumprun Unikernel}[Z/OL]. pkgsrcCon, 2016
[2022-03-25]. \url{https://pkgsrc.org/pkgsrcCon/2016/rumprun.pdf}
\bibitem{bib:canary} Wikipedia contributors. \textit{Sentinel species}[G/OL]. Wikipedia, 2022 (20220319) [2022-03-24]. \url{https://en.wikipedia.org/w/index.php?title=Sentinel_species&oldid=1078038868}
\bibitem{bib:unikraft-secuirty} \textit{Unikraft's Inherent Security Benefits}[Z/OL]. Unikraft, 2022 [2022-03-29]. \url{https://web.archive.org/web/20220329100701/https://unikraft.org/docs/features/security/}
\bibitem{bib:rcore-os} Yu Chen and Yifan Wu. \textit{rCore Tutorial Book}[M/OL]. Version 3,
2022(20220102) [2022-03-27]. \url{https://rcore-os.github.io/rCore-Tutorial-Book-v3/chapter0/0intro.html}

\bibitem{bib:kata} \textit{Kata Containers - Open Source Container Runtime Software}[Z/OL].
Kata Containers, [2022-04-02]. \url{https://web.archive.org/web/20220402043101/https://katacontainers.io/}

\bibitem{bib:gvisor} \textit{gVisor}[Z/OL]. [2022-04-02]. \url{https://web.archive.org/web/20220402043121/https://gvisor.dev/}

\bibitem{bib:feasibility-1}  Paolo Bonzini. \textit{Main Page}[G/OL]. QEMU Wiki, 2020 (20200609) [2022-04-15]. \url{https://wiki.qemu.org/index.php?title=Main_Page&oldid=9546}
\bibitem{bib:feasibility-5} RISC-V Platform Specification Task Group. \textit{RISC-V Supervisor Binary Interface Specification}[S/OL]. GitHub, 2022 (20220322) [2022-04-15]. \url{https://github.com/riscv-non-isa/riscv-sbi-doc/releases/tag/v1.0.0}
\bibitem{bib:feasibility-6} \textit{OpenSBI Version 1.0}[CP/OL]. GitHub, 2021 (20211224) [2022-04-15]. \url{https://github.com/riscv-software-src/opensbi/releases/tag/v1.0}
\bibitem{bib:feasibility-8} è‚–çŒ›. \textit{å›¾è§£ Rust æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸ}[M/OL]. é«˜å®ªå‡¤. Rustç²¾é€‰. 2021 [2022-04-15]. \url{https://rustmagazine.github.io/rust_magazine_2021/chapter_1/rust_ownership.html}
\bibitem{bib:feasibility-9} hardsinging. \textit{Rustçº¿ç¨‹å®‰å…¨ç¼–ç¨‹åˆ†æ}[Z/OL]. çŸ¥ä¹ä¸“æ , 2022 (20220312) [2022-07-09]. \url{https://web.archive.org/web/20220709105413/https://zhuanlan.zhihu.com/p/138394529}
\bibitem{bib:feasibility-a} å°¹å¤©å®‡. \textit{RISC-Vç‰¹æƒç­‰çº§ä¸Linuxå†…æ ¸çš„å¯åŠ¨}[Z/OL]. çŸ¥ä¹ä¸“æ , 2020 (20200823) [2022-07-09]. \url{https://web.archive.org/web/20220709105606/https://zhuanlan.zhihu.com/p/164394603}
\bibitem{bib:feasibility-b} è¾£æ¤’æ²¹li. \textit{RISC-VåŸºæœ¬ä»‹ç»}[Z/OL]. CSDN, 2022 (20220122) [2022-03-29]. \url{https://web.archive.org/web/20220329183308/https://blog.csdn.net/lijianyi0219/article/details/122634356}
\bibitem{bib:feasibility-c} orangeQWJ. \textit{RISC-V ç‰¹æƒæŒ‡ä»¤ç»“æ„}[Z/OL]. åšå®¢å›­, 2022 (20220219) [2022-07-09].  \url{https://web.archive.org/web/20220709110346/https://www.cnblogs.com/orangeQWJ/p/15912780.html}
\bibitem{bib:feasibility-d} shawn. \textit{é—²èŠRISC-Vè™šæ‹ŸåŒ–ï¼ˆ1ï¼‰-CPUè™šæ‹ŸåŒ–}[Z/OL]. çŸ¥ä¹ä¸“æ , 2021 (20210908) [2022-07-09]. \url{https://web.archive.org/web/20220709110755/https://zhuanlan.zhihu.com/p/408197895}

\bibitem{bib:2-why-rust} @ç¨‹åºå¸ˆè§†é‡. \textit{æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦é€‰æ‹©å°ä¼—è¯­è¨€ Rust æ¥å¼€å‘è½¯ä»¶ï¼Ÿ}[Z/OL]. ç¨‹åºå¸ˆ. [2017-06-26]. \url{https://web.archive.org/web/20170626061304/https://www.techug.com/post/why-we-choose-rust-to-dev.html}
\bibitem{bib:1-rust-lang} \textit{Rust Programming Language}[G/OL]. [2022-03-26]. \url{https://web.archive.org/web/20220326232949/https://www.rust-lang.org/}
\bibitem{bib:risc-v-manual} David Patterson and Andrew Waterman. \textit{RISC-V æ‰‹å†Œ: ä¸€æœ¬å¼€æºæŒ‡ä»¤é›†çš„æŒ‡å—}[S]. å‹¾å‡Œç¿, é»„æˆ, åˆ˜å¿—åˆšè¯‘. 2018: 13-21

\bibitem{bib:feasibility-e} æ¨Šé‡‘æ˜Š, å·¦é¡º, å®é›¨äº­, é»„ä¸šç¦, å¼ ä¿¸é“­ and é›·æ€ç¦. \textit{å¯è¡Œæ€§æŠ¥å‘Š}[R/OL]. GitHub, 2019 (20190409) [2022-04-15]. \url{https://github.com/OSH-2019/x-rust-freertos/blob/2182e559cf5dedb68d0bf028f21298421cbedbb0/docs/feasibility.md}
\bibitem{bib:qemu-virt} \textit{`virt' Generic Virtual Platform (virt)}[G/OL]. QEMU Documentaion, [2022-07-09]. \url{https://web.archive.org/web/20220709110415/https://www.qemu.org/docs/master/system/riscv/virt.html}
\bibitem{bib:qemu7} Marius Nestor. \textit{QEMU 7.0 Released with KVM Support for RISC-V, ARM and OpenRISC Improvements}[N/OL]. 9TO5LINUX, 2022 (20220419) [2022-04-20]. \url{https://web.archive.org/web/20220420092003/https://9to5linux.com/qemu-7-0-released-with-kvm-support-for-risc-v-arm-and-openrisc-improvements}
\bibitem{bib:buddy-C-1} Evan Wallace. \textit{Buddy Memory Allocator}[CP/OL]. GitHub, 2018 (20180212) [2022-07-08]. \url{https://github.com/evanw/buddy-malloc/tree/254531aa101806ee665166920bd4c70e88730eb1}
\bibitem{bib:buddy-C-2} Stanislav Paskalev and Yun Hsiao Wu. \textit{buddy\_alloc}[CP/OL]. GitHub, 2022 (20220102) [2022-07-08]. \url{https://github.com/spaskalev/buddy_alloc/tree/6d6581605ae1254db7cdbc5ee2140d35f0bbac7b}
\bibitem{bib:buddy-C-3} Jinzhou Zhang. \textit{buddy-system}[CP/OL]. GitHub, 2013 (20131211) [2022-07-08]. \url{https://github.com/lotabout/buddy-system/tree/21b9a8edce16ada9622e53c12d4a2a23b92f5749}
\bibitem{bib:buddy-Rust-1} jiegec, Vinay Chandra, Runji Wang, Luo Jia, Richard Chien and
Tom Dohrmann. \textit{buddy\_system\_allocator}[CP/OL]. GitHub, 2022 (20220605) [2022-07-08]. \url{https://github.com/rcore-os/buddy_system_allocator/tree/72c01c53eca8fac39fde29842523ec9d3d965929}
\bibitem{bib:buddy-Rust-2} ARaspiK. \textit{Buddies: A low-level buddy allocator}[CP/OL]. GitHub, 2019 (20190514) [2022-07-08]. \url{https://github.com/araspik/buddies/tree/f607d4c015c0c2bd2ab069a7413045ffdd440b39}
\bibitem{bib:buddy-Rust-3} Eric Kidd and Jethro Beekman. \textit{\texttt{alloc\_buddy\_simple}: A simple ``buddy allocator'' for bare-metal Rust}[CP/OL]. 2016 (20160919) [2022-07-08]. \url{https://github.com/emk/toyos-rs/tree/b29fda8cab38ee51945bd73174ece15481409941/crates/alloc_buddy_simple}
\bibitem{bib:rust-test} ç¹æ˜Ÿç‚¹ç‚¹å°½åœ¨ä½ çš„æŒ‡å°–. \textit{å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•}[G/OL].
Rustè¯­è¨€åœ£ç»(Rust Course), 2022 [2022-07-02]. \url{https://web.archive.org/web/20220702105534/https://course.rs/test/unit-integration-test.html}
\bibitem{bib:kconfig} Luis Chamberlain. \texttt{Adapting Linux kernel kconfig}[CP/OL]. GitHub, 2022 (20220205) [2022-07-01]. \url{https://github.com/mcgrof/init-kconfig/tree/325fc60d21384742d137f9ea5bf66b2478021bce}

\bibitem{bib:iot-sys} åˆ˜äºè‹‡. \textit{ä¸åµŒå…¥å¼RTOSå¤§ä¸åŒï¼Œä¸»æµç‰©è”ç½‘æ“ä½œç³»ç»Ÿä¸­å“ªæ¬¾é€‚åˆä½ ï¼Ÿ}[Z/OL].
ç”µå­å·¥ç¨‹ä¸“è¾‘, 2021 (20210518) [2022-03-12]. \url{https://www.eet-china.com/news/202105180818.html}
\bibitem{bib:ms-rtos} ScilogyHunter. \textit{MS-RTOSæ­£å¼å‘å¸ƒå•¦ï¼ï¼ï¼}[Z/OL]. CSDN, 2020 (20200716) [2022-03-12]. \url{https://blog.csdn.net/ScilogyHunter/article/details/107390947}
\bibitem{bib:rust-os-comparison} flosse, wmanley, ticki, et al. \textit{Rust OS comparison}[G/OL]. GitHub, 2022 (20220408) [2022-04-10]. \url{https://github.com/flosse/rust-os-comparison/tree/f3eb1aae4f080fafd81b44254f54e387ac5f6b9d}
\end{thebibliography}
\end{document}
